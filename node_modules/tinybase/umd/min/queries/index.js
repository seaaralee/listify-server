var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),s=t(!0),r=t(0),o=t(t),a="Listener",i="Result",l="Ids",d="Table",c="Row",u=c+"Count",f=c+l,h="Sorted"+c+l,g="Cell",v=g+l,w=Math,L=w.max,y=w.min,R=isFinite,p=e=>null==e,T=(e,t,n)=>p(e)?n?.():t(e),b=e=>t(e)==o,m=e=>Array.isArray(e),C=e=>e.length,Q=()=>{},S=(e,t)=>e.every(t),I=(e,t)=>e.forEach(t),x=e=>j(e,((e,t)=>e+t),0),E=e=>0==C(e),j=(e,t,n)=>e.reduce(t,n),D=(e,...t)=>e.push(...t),M=Object,k=M.entries,z=M.freeze,A=e=>e?.size??0,F=(e,t)=>e?.has(t)??!1,B=e=>p(e)||0==A(e),O=e=>[...e?.values()??[]],W=e=>e.clear(),q=(e,t)=>e?.forEach(t),G=(e,t)=>e?.delete(t),H=e=>new Map(e),J=(e,t)=>e?.get(t),K=(e,t)=>q(e,((e,n)=>t(n,e))),N=(e,t,n)=>p(n)?(G(e,t),e):e?.set(t,n),P=(e,t,n,s)=>(F(e,t)?s?.(J(e,t)):N(e,t,n()),J(e,t)),U=(e,t,n,s,r=0)=>T((n?P:J)(e,t[r],r>C(t)-2?n:H),(o=>{if(r>C(t)-2)return s?.(o)&&N(e,t[r]),o;const a=U(o,t,n,s,r+1);return B(o)&&N(e,t[r]),a})),V=e=>new Set(m(e)||p(e)?e:[e]),X=(e,t)=>e?.add(t),Y=H([["avg",[(e,t)=>x(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>L(...e),(e,t)=>L(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:L(t,e)]],["min",[e=>y(...e),(e,t)=>y(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:y(t,e)]],["sum",[e=>x(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),Z=(()=>{const e=new WeakMap;return o=>(e.has(o)||e.set(o,(e=>{const o=e.createStore,l=o(),w=o(),L=H(),{addListener:y,callListeners:x,delListener:j}=w,[M,Z,$,_,ee,,,te,,ne,se,re,oe,ae]=((e,t,n,s,r)=>{const o=e.hasRow,a=H(),i=H(),l=H(),d=H(),c=H(),u=H(),f=(t,n,...s)=>{const r=P(u,t,V);return I(s,(t=>X(r,t)&&n&&e.callListener(t))),s},h=(t,...n)=>T(J(u,t),(s=>{I(E(n)?O(s):n,(t=>{e.delListener(t),G(s,t)})),B(s)&&N(u,t)})),g=(e,t)=>{N(a,e,t),F(i,e)||(N(i,e,!0),N(d,e,H()),N(c,e,H()),r(l))},v=e=>{N(a,e),N(i,e),N(d,e),N(c,e),h(e),r(l)};return[()=>e,()=>{return e=a,[...e?.keys()??[]];var e},e=>K(i,e),e=>F(i,e),e=>J(a,e),e=>J(i,e),(e,t)=>N(i,e,t),g,(t,s,r,a,i)=>{g(t,s);const l=H(),u=H(),v=J(d,t),w=J(c,t),L=t=>{const r=n=>e.getCell(s,t,n),d=J(v,t),c=o(s,t)?n(a(r,t)):void 0;var f,h;if(d===c||m(d)&&m(c)&&(h=c,C(f=d)===C(h)&&S(f,((e,t)=>h[t]===e)))||N(l,t,[d,c]),!p(i)){const e=J(w,t),n=o(s,t)?i(r,t):void 0;e!=n&&N(u,t,n)}},y=e=>{r((()=>{q(l,(([,e],t)=>N(v,t,e))),q(u,((e,t)=>N(w,t,e)))}),l,u,v,w,e),W(l),W(u)};K(v,L),e.hasTable(s)&&I(e.getRowIds(s),(e=>{F(v,e)||L(e)})),y(!0),h(t),f(t,0,e.addRowListener(s,null,((e,t,n)=>L(n))),e.addTableListener(s,(()=>y())))},v,e=>s(e,l),()=>K(u,v),f,h]})(e,0,Q,y,x),ie=(e,t,...n)=>I(n,(n=>X(P(P(L,t,H),e,V),n))),le=e=>{T(J(L,e),(e=>{K(e,((e,t)=>q(t,(t=>e.delListener(t))))),W(e)})),I([w,l],(t=>t.delTable(e)))},de=(e,t,n)=>ie(t,e,t.addStartTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),ce={setQueryDefinition:(o,a,i)=>{te(o,a),le(o);const d=[],c=[[null,[a,null,null,[],H()]]],u=[],f=[],h=[];i({select:(e,t)=>{const n=b(e)?[C(d)+"",e]:[p(t)?e:t,n=>n(e,t)];return D(d,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const s=p(n)||b(t)?null:t,r=p(s)?t:n,o=[e,[e,s,b(r)?r:e=>e(r),[],H()]];return D(c,o),{as:e=>o[0]=e}},where:(e,t,n)=>D(u,b(e)?e:p(n)?n=>n(e)===t:s=>s(e,t)===n),group:(e,t,n,s,r)=>{const o=[e,[e,b(t)?[t,n,s,r]:J(Y,t)??[(e,t)=>t]]];return D(f,o),{as:e=>o[0]=e}},having:(e,t)=>D(h,b(e)?e:n=>n(e)===t)});const g=H(d);if(B(g))return ce;const v=H(c);K(v,((e,[,t])=>T(J(v,t),(({3:t})=>p(e)?0:D(t,e)))));const L=H(f);let y=l;if(B(L)&&E(h))y=w;else{de(o,y,w);const e=H();K(L,((t,[n,s])=>X(P(e,n,V),[t,s])));const a=V();K(g,(t=>F(e,t)?0:X(a,t)));const i=H(),l=(a,i,l,d)=>T(a,(([c,u,f,g])=>{K(i,((o,[a])=>{const i=P(c,o,H),u=J(i,l),f=d?void 0:a;if(u!==f){const a=V([[u,f]]),d=A(i);N(i,l,f),q(J(e,o),(([e,o])=>{const l=((e,t,n,s,r,o=!1)=>{if(B(n))return;const[a,i,l,d]=r;return o||=p(e),q(s,(([n,s])=>{o||(e=p(n)?i?.(e,s,t++):p(s)?l?.(e,n,t--):d?.(e,s,n,t),o||=p(e))})),o?a(O(n),A(n)):e})(g[e],d,i,a,o);g[e]=p((e=>{const o=t(e);return(e=>e==n||e==s)(o)||o==r&&R(e)?o:void 0})(l))?null:l}))}})),B(u)||!S(h,(e=>e((e=>g[e]))))?w.delRow(o,f):p(f)?a[2]=w.addRow(o,g):w.setRow(o,f,g)}));ie(y,o,y.addRowListener(o,null,((t,n,s,r)=>{const d=[],c=[],u=H(),f=y.hasRow(o,s);let h=!f;q(a,(e=>{const[t,n,a]=r(o,s,e);D(d,n),D(c,a),h||=t})),K(e,(e=>{const[t,,n]=r(o,s,e);(h||t)&&N(u,e,[n])})),h&&l(U(i,d,void 0,(([,e])=>(G(e,s),B(e)))),u,s,1),f&&l(U(i,c,(()=>{const e={};return q(a,(t=>e[t]=y.getCell(o,s,t))),[H(),V(),void 0,e]}),(([,e])=>{X(e,s)})),u,s)})))}de(o,e,y);const m=(t,n,s,r)=>{const i=t=>e.getCell(n,s,t);I(r,(n=>{const[s,,r,a,l]=J(v,n),d=r?.(i,t),[c,u]=J(l,t)??[];d!=c&&(p(u)||ae(o,u),N(l,t,p(d)?null:[d,...oe(o,1,e.addRowListener(s,d,(()=>m(t,s,d,a))))]))})),(t=>{const n=(n,s)=>e.getCell(...p(s)?[a,t,n]:n===a?[a,t,s]:[J(v,n)?.[0],J(J(v,n)?.[4],t)?.[0],s]);y.transaction((()=>S(u,(e=>e(n)))?K(g,((e,s)=>((e,t,n,s,r)=>p(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(y,o,t,e,s(n,t)))):y.delRow(o,t)))})(t)},{3:Q}=J(v,null);return y.transaction((()=>oe(o,1,e.addRowListener(a,null,((t,n,s)=>{e.hasRow(a,s)?m(s,a,s,Q):(y.delRow(o,s),q(v,(({4:e})=>T(J(e,s),(([,t])=>{ae(o,t),N(e,s)})))))}))))),ce},delQueryDefinition:e=>(le(e),ne(e),ce),getStore:M,getQueryIds:Z,forEachQuery:$,hasQuery:_,getTableId:ee,addQueryIdsListener:e=>se((()=>e(ce))),delListener:e=>(j(e),ce),destroy:re,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:n,...s}=w.getListenerStats();return s}};var ue;return ue=([e,t],n)=>{I(e?["get","has","forEach"]:["get"],(e=>ce[e+i+n]=(...t)=>w[e+n](...t))),ce["add"+i+n+a]=(...e)=>{return w["add"+n+a](...(s=e,r=t,s.slice(0,r)),((n,...s)=>e[t](ce,...s)),!0);var s,r}},((e,t)=>{e.map(t)})(k({[d]:[1,1],[d+v]:[0,1],[u]:[0,1],[f]:[0,1],[h]:[0,5],[c]:[1,2],[v]:[0,2],[g]:[1,3]}),(([e,t])=>ue(t,e))),z(ce)})(o)),e.get(o))})();e.createQueries=Z},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
