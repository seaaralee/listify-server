var t,e;t=this,e=function(t,e){"use strict";const n="t",s="v",a=t=>null==t,o=(t,e,n)=>a(t)?n?.():e(t),r=t=>Array.isArray(t),i=t=>t.length,c=t=>{throw Error(t)},l=(t,e)=>t.forEach(e),d=(t,...e)=>t.push(...e),u=t=>t.shift(),g=Object,y=t=>g.getPrototypeOf(t),p=g.entries,f=g.keys,h=g.freeze,v=(t=[])=>g.fromEntries(t),w=(t,e)=>e in t,S=(t,e)=>((t,e)=>t.map(e))(p(t),(([t,n])=>e(n,t))),b=t=>(t=>!a(t)&&o(y(t),(t=>t==g.prototype||a(y(t))),(()=>!0)))(t)&&0==(t=>i(f(t)))(t),C=(t,e,n)=>(w(t,e)||(t[e]=n()),t[e]),M=t=>a(t)||0==(t=>t?.size??0)(t),A=(t,e)=>t?.forEach(e),O=(t,e)=>t?.delete(e),j=t=>new Map(t),L=(t,e)=>t?.get(e),J=(t,e)=>A(t,((t,n)=>e(n,t))),N=(t,e,n)=>a(n)?(O(t,e),t):t?.set(e,n),T=(t,e,n,s)=>{var a,o;return a=t,o=e,a?.has(o)?s?.(L(t,e)):N(t,e,n()),L(t,e)},z=(t,e,n,s,a=0)=>o((n?T:L)(t,e[a],a>i(e)-2?n:j),(o=>{if(a>i(e)-2)return s?.(o)&&N(t,e[a]),o;const r=z(o,e,n,s,a+1);return M(o)&&N(t,e[a]),r})),D=t=>new Set(r(t)||a(t)?t:[t]),E=/^\d+$/,m=j(),P=j(),x=(t,e,n,s,g,y,p,f={},v=0,w=[])=>{let S,C,J,x=0,Y=0,k=0;T(m,w,(()=>0)),T(P,w,(()=>[]));const q=j(),[B,F,$,G,H]=((t=1,e,n)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!n),([[t],[e]])=>!b(t)||!b(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!b(t)||!b(e),e.setContent]:c("Store type not supported by this Persister"))(p,t,v),[I,K,Q]=(()=>{let t;const[e,n]=(()=>{const t=[];let e=0;return[n=>(n?u(t):null)??""+e++,e=>{E.test(e)&&i(t)<1e3&&d(t,e)}]})(),s=j();return[(n,a,o,r=[],i=()=>[])=>{t??=tt;const c=e(1);var l,d;return N(s,c,[n,a,o,r,i]),l=z(a,o??[""],D),d=c,l?.add(d),c},(e,n,...a)=>l(((t,e=[""])=>{const n=[],s=(t,a)=>a==i(e)?d(n,t):null===e[a]?A(t,(t=>s(t,a+1))):l([e[a],null],(e=>s(L(t,e),a+1)));return s(t,0),n})(e,n),(e=>A(e,(e=>L(s,e)[0](t,...n??[],...a))))),t=>o(L(s,t),(([,e,a])=>(z(e,a??[""],void 0,(e=>(O(e,t),M(e)?1:0))),N(s,t),n(t),a))),e=>o(L(s,e),(([e,,n=[],s,o])=>{const r=(...c)=>{const d=i(c);d==i(n)?e(t,...c,...o(c)):a(n[d])?l(s[d]?.(...c)??[],(t=>r(...c,t))):r(...c,n[d])};r()}))]})(),R=t=>{t!=x&&(x=t,K(q,void 0,x))},U=e=>{(B&&r(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},V=async t=>(2!=x&&(R(1),Y++,await _((async()=>{try{const n=await e();r(n)?U(n):t?H(t):c("Content is not an array: "+n)}catch(e){y?.(e),t&&H(t)}R(0)}))),tt),W=()=>(C&&(g(C),C=void 0),tt),X=async t=>(1!=x&&(R(2),k++,await _((async()=>{try{await n(F,t)}catch(t){y?.(t)}R(0)}))),tt),Z=()=>(J&&(t.delListener(J),J=void 0),tt),_=async(...t)=>(d(L(P,w),...t),await(async()=>{if(!L(m,w)){for(N(m,w,1);!a(S=u(L(P,w)));)try{await S()}catch(t){y?.(t)}N(m,w,0)}})(),tt),tt={load:V,startAutoLoad:async t=>{W(),await V(t);try{C=await s((async(t,e)=>{e||t?2!=x&&(R(1),Y++,U(e??t),R(0)):await V()}))}catch(t){y?.(t)}return tt},stopAutoLoad:W,isAutoLoading:()=>!a(C),save:X,startAutoSave:async()=>(Z(),await X(),J=t.addDidFinishTransactionListener((()=>{const t=$();G(t)&&X(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!a(J),getStatus:()=>x,addStatusListener:t=>I(t,q),delListener:e=>(Q(e),t),schedule:_,getStore:()=>t,destroy:()=>(L(P,w).splice(0,void 0),W().stopAutoSave()),getStats:()=>({loads:Y,saves:k}),...f};return h(tt)},Y="delete",k=t=>[t.get(n),t.get(s)],q=(t,n,s,o)=>{const r=a(n)?t:t.get(n)??t.set(n,new e.Map);let i;return S(s,((t,e)=>{o(r,e,t)&&(i=1)})),r.forEach(((t,e)=>{w(s,e)||(r.delete(e),i=1)})),a(n)||r.size||t.delete(n),i};t.createYjsPersister=(t,r,c="tinybase",d)=>{const g=r.getMap(c);return x(t,(async()=>g.size?[g.get(n).toJSON(),g.get(s).toJSON()]:void 0),(async(t,i)=>r.transact((()=>((t,r,i)=>{t.size||(t.set(n,new e.Map),t.set(s,new e.Map));const[c,l]=k(t),d=()=>{u=1};let u=1;if(o(i,(([t,e])=>{u=0,S(t,((t,e)=>u?0:a(t)?c.delete(e):o(c.get(e),(e=>S(t,((t,n)=>u?0:a(t)?e.delete(n):o(e.get(n),(e=>S(t,((t,n)=>a(t)?e.delete(n):e.set(n,t)))),d)))),d))),S(e,((t,e)=>u?0:a(t)?l.delete(e):l.set(e,t)))})),u){const[t,e]=r();q(c,void 0,t,((t,e,n)=>q(c,e,n,((t,e,n)=>q(t,e,n,((t,e,n)=>{if(t.get(e)!==n)return t.set(e,n),1})))))),q(l,void 0,e,((t,e,n)=>{l.get(e)!==n&&l.set(e,n)}))}})(g,t,i)))),(t=>{const e=e=>t(void 0,((t,e)=>{if(1==i(e)&&(a=e[0].path,0==i(a)))return[t.get(n).toJSON(),t.get(s).toJSON(),1];var a;const[r,c]=k(t),d={},g={};return l(e,(({path:t,changes:{keys:e}})=>u(t)==n?o(u(t),(n=>{const s=C(d,n,v),a=r.get(n);o(u(t),(t=>{const n=C(s,t,v),o=a.get(t);J(e,((t,{action:e})=>n[t]=e==Y?null:o.get(t)))}),(()=>J(e,((t,{action:e})=>s[t]=e==Y?null:a.get(t)?.toJSON()))))}),(()=>J(e,((t,{action:e})=>d[t]=e==Y?null:r.get(t)?.toJSON())))):J(e,((t,{action:e})=>g[t]=e==Y?null:c.get(t))))),[d,g,1]})(g,e));return g.observeDeep(e),e}),(t=>{g.unobserveDeep(t)}),d,1,{getYDoc:()=>r})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
