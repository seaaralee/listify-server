var t,a;t=this,a=function(t){"use strict";const a=t=>typeof t,e="tinybase",n=",",s=a(""),i=Promise,o=t=>null==t,r=(t,a,e)=>o(t)?e?.():a(t),c=t=>a(t)==s,l=t=>Array.isArray(t),E=(t,a,e)=>t.slice(a,e),y=t=>t.length,w=async t=>i.all(t),d=t=>{throw Error(t)},u=(t,a)=>t.forEach(a),T=(t,a="")=>t.join(a),R=(t,a)=>t.map(a),A=t=>0==y(t),N=(t,a)=>t.filter(a),g=(t,...a)=>t.push(...a),p=t=>t.shift(),C="_",O="_id",f="SELECT",L="WHERE",v="TABLE",$="ALTER "+v,m="DELETE FROM",I=f+"*FROM",S=t=>`"${t.replace(/"/g,'""')}"`,h=(t,a=[1])=>T(R(t,(()=>"$"+a[0]++)),n),_=(t,a)=>t?.has(a)??!1,b=t=>o(t)||0==(t=>t?.size??0)(t),P=t=>[...t?.values()??[]],D=(t,a)=>t?.forEach(a),U=(t,a)=>t?.delete(a),F=Object,M=t=>F.getPrototypeOf(t),G=F.entries,B=F.keys,j=F.freeze,x=(t=[])=>F.fromEntries(t),X=(...t)=>F.assign({},...t),Y=(t,a)=>(delete t[a],t),q=(t,a)=>R(G(t),(([t,e])=>a(e,t))),H=t=>F.values(t),W=t=>y(B(t)),k=t=>(t=>!o(t)&&r(M(t),(t=>t==F.prototype||o(M(t))),(()=>!0)))(t)&&0==W(t),z=JSON.stringify,J=JSON.parse,K=t=>new Map(t),V=(t,a)=>t?.get(a),Q=(t,a)=>R([...t?.entries()??[]],(([t,e])=>a(e,t))),Z=(t,a,e)=>o(e)?(U(t,a),t):t?.set(a,e),tt=(t,a,e,n)=>(_(t,a)?n?.(V(t,a)):Z(t,a,e()),V(t,a)),at=(t,a,e,n,s=0)=>r((e?tt:V)(t,a[s],s>y(a)-2?e:K),(i=>{if(s>y(a)-2)return n?.(i)&&Z(t,a[s]),i;const o=at(i,a,e,n,s+1);return b(i)&&Z(t,a[s]),o})),et=t=>new Set(l(t)||o(t)?t:[t]),nt=(t,a)=>t?.add(a),st=/^\d+$/,it=K(),ot=K(),rt=(t,a,e,n,s,i,c,E={},w=0,T=[])=>{let R,A,N,C=0,O=0,f=0;tt(it,T,(()=>0)),tt(ot,T,(()=>[]));const L=K(),[v,$,m,I,S]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!k(t)||!k(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!k(t)||!k(a),a.setContent]:d("Store type not supported by this Persister"))(c,t,w),[h,_,P]=(()=>{let t;const[a,e]=(()=>{const t=[];let a=0;return[e=>(e?p(t):null)??""+a++,a=>{st.test(a)&&y(t)<1e3&&g(t,a)}]})(),n=K();return[(e,s,i,o=[],r=()=>[])=>{t??=q;const c=a(1);return Z(n,c,[e,s,i,o,r]),nt(at(s,i??[""],et),c),c},(a,e,...s)=>u(((t,a=[""])=>{const e=[],n=(t,s)=>s==y(a)?g(e,t):null===a[s]?D(t,(t=>n(t,s+1))):u([a[s],null],(a=>n(V(t,a),s+1)));return n(t,0),e})(a,e),(a=>D(a,(a=>V(n,a)[0](t,...e??[],...s))))),t=>r(V(n,t),(([,a,s])=>(at(a,s??[""],void 0,(a=>(U(a,t),b(a)?1:0))),Z(n,t),e(t),s))),a=>r(V(n,a),(([a,,e=[],n,s])=>{const i=(...r)=>{const c=y(r);c==y(e)?a(t,...r,...s(r)):o(e[c])?u(n[c]?.(...r)??[],(t=>i(...r,t))):i(...r,e[c])};i()}))]})(),F=t=>{t!=C&&(C=t,_(L,void 0,C))},M=a=>{(v&&l(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},G=async t=>(2!=C&&(F(1),O++,await Y((async()=>{try{const e=await a();l(e)?M(e):t?S(t):d("Content is not an array: "+e)}catch(a){i?.(a),t&&S(t)}F(0)}))),q),B=()=>(A&&(s(A),A=void 0),q),x=async t=>(1!=C&&(F(2),f++,await Y((async()=>{try{await e($,t)}catch(t){i?.(t)}F(0)}))),q),X=()=>(N&&(t.delListener(N),N=void 0),q),Y=async(...t)=>(g(V(ot,T),...t),await(async()=>{if(!V(it,T)){for(Z(it,T,1);!o(R=p(V(ot,T)));)try{await R()}catch(t){i?.(t)}Z(it,T,0)}})(),q),q={load:G,startAutoLoad:async t=>{B(),await G(t);try{A=await n((async(t,a)=>{a||t?2!=C&&(F(1),O++,M(a??t),F(0)):await G()}))}catch(t){i?.(t)}return q},stopAutoLoad:B,isAutoLoading:()=>!o(A),save:x,startAutoSave:async()=>(X(),await x(),N=t.addDidFinishTransactionListener((()=>{const t=m();I(t)&&x(t)})),q),stopAutoSave:X,isAutoSaving:()=>!o(N),getStatus:()=>C,addStatusListener:t=>h(t,L),delListener:a=>(P(a),t),schedule:Y,getStore:()=>t,destroy:()=>(V(ot,T).splice(0,void 0),B().stopAutoSave()),getStats:()=>({loads:O,saves:f}),...E};return j(q)},ct=(t,a,e,s,i,r=lt,c,l)=>{const E=K();return[async()=>{E.clear(),R(await e(t,a),(({tn:t,cn:a})=>nt(tt(E,t,et),a)))},async(a,e)=>((t,a)=>_(V(E,t),a))(a,e)?x(N(R(await t(I+S(a)),(t=>{return[t[e],l?(a=Y(t,e),n=l,x(q(a,((t,a)=>[a,n(t,a)])))):Y(t,e)];var a,n})),(([t,a])=>!o(t)&&!k(a)))):{},async(a,e,s,l,y,d=!1)=>{const u=et();q(s??{},(t=>R(B(t??{}),(t=>nt(u,t)))));const p=P(u);if(!d&&y&&A(p)&&_(E,a))return await t("DROP "+v+S(a)),void Z(E,a);const C=V(E,a),O=et(P(C));if(A(p)||(_(E,a)?await w(R([e,...p],(async(n,s)=>{U(O,n)||(await t($+S(a)+"ADD"+S(n)+i),0==s&&await t("CREATE UNIQUE INDEX pk ON "+S(a)+`(${S(e)})`),nt(C,n))}))):(await t("CREATE "+v+S(a)+`(${S(e)}${i} PRIMARY KEY${T(R(p,(t=>n+S(t)+i)))});`),Z(E,a,et([e,...p])))),await w([...!d&&l?R(P(O),(async n=>{n!=e&&(await t($+S(a)+"DROP"+S(n)),U(C,n))})):[]]),d)o(s)?await t(m+S(a)+L+" true"):await w(q(s,(async(n,s)=>{o(n)?await t(m+S(a)+L+S(e)+"=$1",[s]):A(p)||await r(t,a,e,B(n),{[s]:c?R(H(n),c):H(n)},C)})));else if(A(p))_(E,a)&&await t(m+S(a)+L+" true");else{const n=N(P(V(E,a)),(t=>t!=e)),i={},o=[];q(s??{},((t,a)=>{i[a]=R(n,(a=>c?c(t?.[a]):t?.[a])),g(o,a)})),await r(t,a,e,n,i),await t(m+S(a)+L+S(e)+`NOT IN(${h(o)})`,o)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){s?.(t)}return await t("END"),e}]},lt=async(t,a,e,s,i)=>{const o=[1];await t("INSERT INTO"+S(a)+"("+((...t)=>T(R(t,S),n))(e,...s)+")VALUES"+T(q(i,(t=>"($"+o[0]+++","+h(t,o)+")")),n)+"ON CONFLICT("+S(e)+")DO UPDATE SET"+T(R(s,(t=>S(t)+"=excluded."+S(t))),n),q(i,((t,a)=>[a,...R(t,(t=>t??null))])).flat())},Et=(t,a,e,n,s,i,o,[r,c,l],E,y,w,d,u,T)=>{const[R,A,N,g]=ct(a,E,y,s,u,T),p=rt(t,(async()=>await g((async()=>{return await R(),t=(await A(r,c))[C]?.[l]??"null",J(t,((t,a)=>"￼"===a?void 0:a));var t}))),(async t=>await g((async()=>{var a;await R(),await N(r,c,{[C]:{[l]:(a=t()??null,z(a,((t,a)=>void 0===a?"￼":a)))}},!0,!0)}))),e,n,s,o,{[d]:()=>w,destroy:()=>(p.stopAutoLoad().stopAutoSave(),i(),p)},0,w);return p},yt=(t,a,e,n,s,i,r,[c,l,[E,y,d]],u,T,R,A,g,p,f,L)=>{const[v,$,m,I]=ct(a,u,T,s,g,p,f,L),S=async(t,a)=>await w(Q(l,(async([e,n,s,i],o)=>{a&&!(o in t)||await m(e,n,t[o],s,i,a)}))),h=async(t,a)=>y?await m(d,O,{[C]:t},!0,!0,a):null,_=rt(t,(async()=>await I((async()=>{await v();const t=await(async()=>x(N(await w(Q(c,(async([t,a],e)=>[t,await $(e,a)]))),(t=>!k(t[1])))))(),a=await(async()=>E?(await $(d,O))[C]:{})();return k(t)&&o(a)?void 0:[t,a]}))),(async(t,a)=>await I((async()=>{if(await v(),o(a)){const[a,e]=t();await S(a),await h(e)}else await S(a[0],!0),await h(a[1],!0)}))),e,n,s,r,{[A]:()=>R,destroy:()=>(_.stopAutoLoad().stopAutoSave(),i(),_)},0,R);return _},wt="ColumnName",dt="store",ut="json",Tt=dt+"TableName",Rt=dt+"Id"+wt,At=dt+wt,Nt="autoLoadIntervalSeconds",gt="rowId"+wt,pt="tableId",Ct="tableName",Ot="deleteEmptyColumns",ft="deleteEmptyTable",Lt={mode:ut,[Nt]:1},vt={load:0,save:0,[Ct]:e+"_values"},$t=(t,a,e,n,s)=>{const i=K();return q(t,((t,r)=>{const l=E(H(X(a,c(t)?{[e]:t}:t)),0,W(a));o(l[0])||n(r,l[0])||(s(r,l[0]),Z(i,r,l))})),i},mt=e,It=/^([cd]:)(.+)/,St=e+"_data",ht=e+"_table";t.createPglitePersister=async(t,a,n,s,i)=>((t,a,n,s,i,o,l,y,d,u,T="getDb")=>{const A=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(n,o),[N,,g,p]=(t=>{const a=(t=>X(Lt,c(t)?{[Tt]:t}:t??{}))(t),n=a[Nt];if(a.mode==ut){const t=a[Tt]??e;return[1,n,[t,a[Rt]??O,a[At]??dt],et(t)]}const{tables:{load:s={},save:i={}}={},values:o={}}=a,r=E(H(X(vt,o)),0,W(vt)),l=r[2],y=et(l),w=et(l);return[0,n,[$t(s,{[pt]:null,[gt]:O},pt,(t=>_(w,t)),(t=>nt(y,t))),$t(i,{[Ct]:null,[gt]:O,[Ot]:0,[ft]:0},Ct,((t,a)=>_(w,a)),((t,a)=>nt(y,a))),r],y]})(a),C=async t=>{await A(`CREATE OR REPLACE TRIGGER ${S(St+"_"+t)} AFTER INSERT OR UPDATE OR DELETE ON ${S(t)} EXECUTE FUNCTION ${St}()`)};return(N?Et:yt)(t,A,(async t=>{await A(`CREATE OR REPLACE FUNCTION ${ht}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${mt}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{await A(`CREATE EVENT TRIGGER ${ht} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${ht}();`)}catch{}return await A(`CREATE OR REPLACE FUNCTION ${St}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${mt}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),await w(R(P(p),(async t=>{await A(`CREATE TABLE IF NOT EXISTS ${S(t)}("_id"text PRIMARY KEY)`),await C(t)}))),await s(mt,(async a=>{return await r((e=a,n=It,e?.match(n)),(async([,a,e])=>{_(p,e)&&("c:"==a&&await C(e),t())}));var e,n}))}),i,l,y,d,g,P(p),(async(t,a)=>await t(`${f} table_name tn,column_name cn FROM information_schema.columns ${L} table_schema='public'AND table_name IN(${h(a)})`,a)),u,T,"text",void 0,(t=>z(t)),(t=>J(t)))})(t,n,(async(t,e=[])=>(await a.query(t,e)).rows),(async(t,e)=>await a.listen(t,e)),(async t=>{try{await t()}catch(t){i?.(t)}}),s,i,(()=>0),3,a,"getPglite")},"object"==typeof exports&&"undefined"!=typeof module?a(exports):"function"==typeof define&&define.amd?define(["exports"],a):a((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPglite={});
