var t,a;t=this,a=function(t,a){"use strict";const e=t=>typeof t,n="tinybase",s="",i=",",o=e(s),r=Promise,c=clearInterval,l=t=>null==t,u=(t,a,e)=>l(t)?e?.():a(t),y=t=>e(t)==o,d=t=>Array.isArray(t),w=(t,a,e)=>t.slice(a,e),p=t=>t.length,v=async t=>r.all(t),f=t=>{throw Error(t)},E=(t,a)=>t.forEach(a),g=(t,a="")=>t.join(a),h=(t,a)=>t.map(a),m=t=>0==p(t),A=(t,a)=>t.filter(a),N=(t,...a)=>t.push(...a),S=t=>t.shift(),T="_",$="_id",b="SELECT",C="WHERE",O="TABLE",L="ALTER "+O,I="DELETE FROM",D=b+"*FROM",R="pragma_",M="data_version",x="schema_version",P="pragma_table_",_=t=>`"${t.replace(/"/g,'""')}"`,q=(t,a=[1])=>g(h(t,(()=>"$"+a[0]++)),i),F=(t,a)=>t?.has(a)??!1,j=t=>l(t)||0==(t=>t?.size??0)(t),B=t=>[...t?.values()??[]],U=(t,a)=>t?.forEach(a),J=(t,a)=>t?.delete(a),Y=Object,k=t=>Y.getPrototypeOf(t),z=Y.entries,G=Y.keys,H=Y.freeze,K=(t=[])=>Y.fromEntries(t),Q=(...t)=>Y.assign({},...t),V=(t,a)=>(delete t[a],t),W=(t,a)=>h(z(t),(([t,e])=>a(e,t))),X=t=>Y.values(t),Z=t=>p(G(t)),tt=t=>(t=>!l(t)&&u(k(t),(t=>t==Y.prototype||l(k(t))),(()=>!0)))(t)&&0==Z(t),at=JSON.stringify,et=JSON.parse,nt=t=>new Map(t),st=(t,a)=>t?.get(a),it=(t,a)=>h([...t?.entries()??[]],(([t,e])=>a(e,t))),ot=(t,a,e)=>l(e)?(J(t,a),t):t?.set(a,e),rt=(t,a,e,n)=>(F(t,a)?n?.(st(t,a)):ot(t,a,e()),st(t,a)),ct=(t,a,e,n,s=0)=>u((e?rt:st)(t,a[s],s>p(a)-2?e:nt),(i=>{if(s>p(a)-2)return n?.(i)&&ot(t,a[s]),i;const o=ct(i,a,e,n,s+1);return j(i)&&ot(t,a[s]),o})),lt=t=>new Set(d(t)||l(t)?t:[t]),ut=(t,a)=>t?.add(a),yt=/^\d+$/,dt=nt(),wt=nt(),pt=(t,a,e,n,i,o,r,c={},y=0,w=[])=>{let v,g,h,m=0,A=0,T=0;rt(dt,w,(()=>0)),rt(wt,w,(()=>[]));const $=nt(),[b,C,O,L,I]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!tt(t)||!tt(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!tt(t)||!tt(a),a.setContent]:f("Store type not supported by this Persister"))(r,t,y),[D,R,M]=(()=>{let t;const[a,e]=(()=>{const t=[];let a=0;return[e=>(e?S(t):null)??s+a++,a=>{yt.test(a)&&p(t)<1e3&&N(t,a)}]})(),n=nt();return[(e,i,o,r=[],c=()=>[])=>{t??=k;const l=a(1);return ot(n,l,[e,i,o,r,c]),ut(ct(i,o??[s],lt),l),l},(a,e,...i)=>E(((t,a=[s])=>{const e=[],n=(t,s)=>s==p(a)?N(e,t):null===a[s]?U(t,(t=>n(t,s+1))):E([a[s],null],(a=>n(st(t,a),s+1)));return n(t,0),e})(a,e),(a=>U(a,(a=>st(n,a)[0](t,...e??[],...i))))),t=>u(st(n,t),(([,a,i])=>(ct(a,i??[s],void 0,(a=>(J(a,t),j(a)?1:0))),ot(n,t),e(t),i))),a=>u(st(n,a),(([a,,e=[],n,s])=>{const i=(...o)=>{const r=p(o);r==p(e)?a(t,...o,...s(o)):l(e[r])?E(n[r]?.(...o)??[],(t=>i(...o,t))):i(...o,e[r])};i()}))]})(),x=t=>{t!=m&&(m=t,R($,void 0,m))},P=a=>{(b&&d(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},_=async t=>(2!=m&&(x(1),A++,await Y((async()=>{try{const e=await a();d(e)?P(e):t?I(t):f("Content is not an array: "+e)}catch(a){o?.(a),t&&I(t)}x(0)}))),k),q=()=>(g&&(i(g),g=void 0),k),F=async t=>(1!=m&&(x(2),T++,await Y((async()=>{try{await e(C,t)}catch(t){o?.(t)}x(0)}))),k),B=()=>(h&&(t.delListener(h),h=void 0),k),Y=async(...t)=>(N(st(wt,w),...t),await(async()=>{if(!st(dt,w)){for(ot(dt,w,1);!l(v=S(st(wt,w)));)try{await v()}catch(t){o?.(t)}ot(dt,w,0)}})(),k),k={load:_,startAutoLoad:async t=>{q(),await _(t);try{g=await n((async(t,a)=>{a||t?2!=m&&(x(1),A++,P(a??t),x(0)):await _()}))}catch(t){o?.(t)}return k},stopAutoLoad:q,isAutoLoading:()=>!l(g),save:F,startAutoSave:async()=>(B(),await F(),h=t.addDidFinishTransactionListener((()=>{const t=O();L(t)&&F(t)})),k),stopAutoSave:B,isAutoSaving:()=>!l(h),getStatus:()=>m,addStatusListener:t=>D(t,$),delListener:a=>(M(a),t),schedule:Y,getStore:()=>t,destroy:()=>(st(wt,w).splice(0,void 0),q().stopAutoSave()),getStats:()=>({loads:A,saves:T}),...c};return H(k)},vt=(t,a,e,n,s,o=ft,r,c)=>{const u=nt();return[async()=>{u.clear(),h(await e(t,a),(({tn:t,cn:a})=>ut(rt(u,t,lt),a)))},async(a,e)=>((t,a)=>F(st(u,t),a))(a,e)?K(A(h(await t(D+_(a)),(t=>{return[t[e],c?(a=V(t,e),n=c,K(W(a,((t,a)=>[a,n(t,a)])))):V(t,e)];var a,n})),(([t,a])=>!l(t)&&!tt(a)))):{},async(a,e,n,c,y,d=!1)=>{const w=lt();W(n??{},(t=>h(G(t??{}),(t=>ut(w,t)))));const p=B(w);if(!d&&y&&m(p)&&F(u,a))return await t("DROP "+O+_(a)),void ot(u,a);const f=st(u,a),E=lt(B(f));if(m(p)||(F(u,a)?await v(h([e,...p],(async(n,i)=>{J(E,n)||(await t(L+_(a)+"ADD"+_(n)+s),0==i&&await t("CREATE UNIQUE INDEX pk ON "+_(a)+`(${_(e)})`),ut(f,n))}))):(await t("CREATE "+O+_(a)+`(${_(e)}${s} PRIMARY KEY${g(h(p,(t=>i+_(t)+s)))});`),ot(u,a,lt([e,...p])))),await v([...!d&&c?h(B(E),(async n=>{n!=e&&(await t(L+_(a)+"DROP"+_(n)),J(f,n))})):[]]),d)l(n)?await t(I+_(a)+C+" true"):await v(W(n,(async(n,s)=>{l(n)?await t(I+_(a)+C+_(e)+"=$1",[s]):m(p)||await o(t,a,e,G(n),{[s]:r?h(X(n),r):X(n)},f)})));else if(m(p))F(u,a)&&await t(I+_(a)+C+" true");else{const s=A(B(st(u,a)),(t=>t!=e)),i={},c=[];W(n??{},((t,a)=>{i[a]=h(s,(a=>r?r(t?.[a]):t?.[a])),N(c,a)})),await o(t,a,e,s,i),await t(I+_(a)+C+_(e)+`NOT IN(${q(c)})`,c)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){n?.(t)}return await t("END"),e}]},ft=async(t,a,e,n,s)=>{const o=[1];await t("INSERT INTO"+_(a)+"("+((...t)=>g(h(t,_),i))(e,...n)+")VALUES"+g(W(s,(t=>"($"+o[0]+++","+q(t,o)+")")),i)+"ON CONFLICT("+_(e)+")DO UPDATE SET"+g(h(n,(t=>_(t)+"=excluded."+_(t))),i),W(s,((t,a)=>[a,...h(t,(t=>t??null))])).flat())},Et=(t,a,e,n,s,i,o,[r,c,l],u,y,d,w,p,v)=>{const[f,E,g,h]=vt(a,u,y,s,p,v),m=pt(t,(async()=>await h((async()=>{return await f(),t=(await E(r,c))[T]?.[l]??"null",et(t,((t,a)=>"￼"===a?void 0:a));var t}))),(async t=>await h((async()=>{var a;await f(),await g(r,c,{[T]:{[l]:(a=t()??null,at(a,((t,a)=>void 0===a?"￼":a)))}},!0,!0)}))),e,n,s,o,{[w]:()=>d,destroy:()=>(m.stopAutoLoad().stopAutoSave(),i(),m)},0,d);return m},gt=(t,a,e,n,s,i,o,[r,c,[u,y,d]],w,p,f,E,g,h,m,N)=>{const[S,b,C,O]=vt(a,w,p,s,g,h,m,N),L=async(t,a)=>await v(it(c,(async([e,n,s,i],o)=>{a&&!(o in t)||await C(e,n,t[o],s,i,a)}))),I=async(t,a)=>y?await C(d,$,{[T]:t},!0,!0,a):null,D=pt(t,(async()=>await O((async()=>{await S();const t=await(async()=>K(A(await v(it(r,(async([t,a],e)=>[t,await b(e,a)]))),(t=>!tt(t[1])))))(),a=await(async()=>u?(await b(d,$))[T]:{})();return tt(t)&&l(a)?void 0:[t,a]}))),(async(t,a)=>await O((async()=>{if(await S(),l(a)){const[a,e]=t();await L(a),await I(e)}else await L(a[0],!0),await I(a[1],!0)}))),e,n,s,o,{[E]:()=>f,destroy:()=>(D.stopAutoLoad().stopAutoSave(),i(),D)},0,f);return D},ht="ColumnName",mt="store",At="json",Nt=mt+"TableName",St=mt+"Id"+ht,Tt=mt+ht,$t="autoLoadIntervalSeconds",bt="rowId"+ht,Ct="tableId",Ot="tableName",Lt="deleteEmptyColumns",It="deleteEmptyTable",Dt={mode:At,[$t]:1},Rt={load:0,save:0,[Ot]:n+"_values"},Mt=(t,a,e,n,s)=>{const i=nt();return W(t,((t,o)=>{const r=w(X(Q(a,y(t)?{[e]:t}:t)),0,Z(a));l(r[0])||n(o,r[0])||(s(o,r[0]),ot(i,o,r))})),i},xt=(t,a,e,i,o,r,l,u,d,p,v="getDb",f)=>{let E,g,h;const m=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(e,r),[A,N,S,T]=(t=>{const a=(t=>Q(Dt,y(t)?{[Nt]:t}:t??{}))(t),e=a[$t];if(a.mode==At){const t=a[Nt]??n;return[1,e,[t,a[St]??$,a[Tt]??mt],lt(t)]}const{tables:{load:s={},save:i={}}={},values:o={}}=a,r=w(X(Q(Rt,o)),0,Z(Rt)),c=r[2],l=lt(c),u=lt(c);return[0,e,[Mt(s,{[Ct]:null,[bt]:$},Ct,(t=>F(u,t)),(t=>ut(l,t))),Mt(i,{[Ot]:null,[bt]:$,[Lt]:0,[It]:0},Ot,((t,a)=>F(u,a)),((t,a)=>ut(l,a))),r],l]})(a);return(A?Et:gt)(t,m,(t=>{let a;const e=()=>a=setInterval((async()=>{try{const[{d:a,s:e,c:n}]=await m(`${b} ${M} d,${x} s,TOTAL_CHANGES() c FROM ${R}${M} JOIN ${R}${x}`);a==E&&e==g&&n==h||(null!=E&&t(),E=a,g=e,h=n)}catch{}}),1e3*N),n=()=>{E=g=h=null,c(a)},s=i((a=>{T.has(a)&&(n(),t(),e())}));return e(),()=>{n(),o(s)}}),(t=>t()),l,u,d,S,B(T),(async(t,a)=>await t(`${b} t.name tn,c.name cn FROM ${P}list()t,${P}info(t.name)c ${C} t.schema='main'AND t.type IN('table','view')AND t.name IN(${q(a)})ORDER BY t.name,c.name`,a)),p,v,s,f,(t=>!0===t?1:!1===t?0:t),void 0)};t.createExpoSqlitePersister=(t,e,n,s,i)=>xt(t,n,(async(t,a=[])=>await e.getAllAsync(t,a)),(t=>a.addDatabaseChangeListener((({tableName:a})=>t(a)))),(t=>t.remove()),s,i,(()=>0),3,e)},"object"==typeof exports&&"undefined"!=typeof module?a(exports,require("expo-sqlite")):"function"==typeof define&&define.amd?define(["exports","expo-sqlite"],a):a((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterExpoSqlite={},t["expo-sqlite"]);
