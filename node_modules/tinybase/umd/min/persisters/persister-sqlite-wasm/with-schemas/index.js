var t,a;t=this,a=function(t){"use strict";const a=t=>typeof t,e="tinybase",n="",s=",",i=a(n),o=Promise,r=clearInterval,c=t=>null==t,l=(t,a,e)=>c(t)?e?.():a(t),u=t=>a(t)==i,y=t=>Array.isArray(t),d=(t,a,e)=>t.slice(a,e),w=t=>t.length,p=async t=>o.all(t),v=t=>{throw Error(t)},f=(t,a)=>t.forEach(a),E=(t,a="")=>t.join(a),g=(t,a)=>t.map(a),h=t=>0==w(t),m=(t,a)=>t.filter(a),A=(t,...a)=>t.push(...a),N=t=>t.shift(),S="_",T="_id",$="SELECT",b="WHERE",C="TABLE",O="ALTER "+C,I="DELETE FROM",L=$+"*FROM",R="pragma_",D="data_version",_="schema_version",M="pragma_table_",P=t=>`"${t.replace(/"/g,'""')}"`,F=(t,a=[1])=>E(g(t,(()=>"$"+a[0]++)),s),j=(t,a)=>t?.has(a)??!1,x=t=>c(t)||0==(t=>t?.size??0)(t),k=t=>[...t?.values()??[]],q=(t,a)=>t?.forEach(a),B=(t,a)=>t?.delete(a),U=Object,J=t=>U.getPrototypeOf(t),W=U.entries,Y=U.keys,z=U.freeze,G=(t=[])=>U.fromEntries(t),H=(...t)=>U.assign({},...t),V=(t,a)=>(delete t[a],t),K=(t,a)=>g(W(t),(([t,e])=>a(e,t))),Q=t=>U.values(t),X=t=>w(Y(t)),Z=t=>(t=>!c(t)&&l(J(t),(t=>t==U.prototype||c(J(t))),(()=>!0)))(t)&&0==X(t),tt=JSON.stringify,at=JSON.parse,et=t=>new Map(t),nt=(t,a)=>t?.get(a),st=(t,a)=>g([...t?.entries()??[]],(([t,e])=>a(e,t))),it=(t,a,e)=>c(e)?(B(t,a),t):t?.set(a,e),ot=(t,a,e,n)=>(j(t,a)?n?.(nt(t,a)):it(t,a,e()),nt(t,a)),rt=(t,a,e,n,s=0)=>l((e?ot:nt)(t,a[s],s>w(a)-2?e:et),(i=>{if(s>w(a)-2)return n?.(i)&&it(t,a[s]),i;const o=rt(i,a,e,n,s+1);return x(i)&&it(t,a[s]),o})),ct=t=>new Set(y(t)||c(t)?t:[t]),lt=(t,a)=>t?.add(a),ut=/^\d+$/,yt=et(),dt=et(),wt=(t,a,e,s,i,o,r,u={},d=0,p=[])=>{let E,g,h,m=0,S=0,T=0;ot(yt,p,(()=>0)),ot(dt,p,(()=>[]));const $=et(),[b,C,O,I,L]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!Z(t)||!Z(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!Z(t)||!Z(a),a.setContent]:v("Store type not supported by this Persister"))(r,t,d),[R,D,_]=(()=>{let t;const[a,e]=(()=>{const t=[];let a=0;return[e=>(e?N(t):null)??n+a++,a=>{ut.test(a)&&w(t)<1e3&&A(t,a)}]})(),s=et();return[(e,i,o,r=[],c=()=>[])=>{t??=W;const l=a(1);return it(s,l,[e,i,o,r,c]),lt(rt(i,o??[n],ct),l),l},(a,e,...i)=>f(((t,a=[n])=>{const e=[],s=(t,n)=>n==w(a)?A(e,t):null===a[n]?q(t,(t=>s(t,n+1))):f([a[n],null],(a=>s(nt(t,a),n+1)));return s(t,0),e})(a,e),(a=>q(a,(a=>nt(s,a)[0](t,...e??[],...i))))),t=>l(nt(s,t),(([,a,i])=>(rt(a,i??[n],void 0,(a=>(B(a,t),x(a)?1:0))),it(s,t),e(t),i))),a=>l(nt(s,a),(([a,,e=[],n,s])=>{const i=(...o)=>{const r=w(o);r==w(e)?a(t,...o,...s(o)):c(e[r])?f(n[r]?.(...o)??[],(t=>i(...o,t))):i(...o,e[r])};i()}))]})(),M=t=>{t!=m&&(m=t,D($,void 0,m))},P=a=>{(b&&y(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},F=async t=>(2!=m&&(M(1),S++,await J((async()=>{try{const e=await a();y(e)?P(e):t?L(t):v("Content is not an array: "+e)}catch(a){o?.(a),t&&L(t)}M(0)}))),W),j=()=>(g&&(i(g),g=void 0),W),k=async t=>(1!=m&&(M(2),T++,await J((async()=>{try{await e(C,t)}catch(t){o?.(t)}M(0)}))),W),U=()=>(h&&(t.delListener(h),h=void 0),W),J=async(...t)=>(A(nt(dt,p),...t),await(async()=>{if(!nt(yt,p)){for(it(yt,p,1);!c(E=N(nt(dt,p)));)try{await E()}catch(t){o?.(t)}it(yt,p,0)}})(),W),W={load:F,startAutoLoad:async t=>{j(),await F(t);try{g=await s((async(t,a)=>{a||t?2!=m&&(M(1),S++,P(a??t),M(0)):await F()}))}catch(t){o?.(t)}return W},stopAutoLoad:j,isAutoLoading:()=>!c(g),save:k,startAutoSave:async()=>(U(),await k(),h=t.addDidFinishTransactionListener((()=>{const t=O();I(t)&&k(t)})),W),stopAutoSave:U,isAutoSaving:()=>!c(h),getStatus:()=>m,addStatusListener:t=>R(t,$),delListener:a=>(_(a),t),schedule:J,getStore:()=>t,destroy:()=>(nt(dt,p).splice(0,void 0),j().stopAutoSave()),getStats:()=>({loads:S,saves:T}),...u};return z(W)},pt=(t,a,e,n,i,o=vt,r,l)=>{const u=et();return[async()=>{u.clear(),g(await e(t,a),(({tn:t,cn:a})=>lt(ot(u,t,ct),a)))},async(a,e)=>((t,a)=>j(nt(u,t),a))(a,e)?G(m(g(await t(L+P(a)),(t=>{return[t[e],l?(a=V(t,e),n=l,G(K(a,((t,a)=>[a,n(t,a)])))):V(t,e)];var a,n})),(([t,a])=>!c(t)&&!Z(a)))):{},async(a,e,n,l,y,d=!1)=>{const w=ct();K(n??{},(t=>g(Y(t??{}),(t=>lt(w,t)))));const v=k(w);if(!d&&y&&h(v)&&j(u,a))return await t("DROP "+C+P(a)),void it(u,a);const f=nt(u,a),N=ct(k(f));if(h(v)||(j(u,a)?await p(g([e,...v],(async(n,s)=>{B(N,n)||(await t(O+P(a)+"ADD"+P(n)+i),0==s&&await t("CREATE UNIQUE INDEX pk ON "+P(a)+`(${P(e)})`),lt(f,n))}))):(await t("CREATE "+C+P(a)+`(${P(e)}${i} PRIMARY KEY${E(g(v,(t=>s+P(t)+i)))});`),it(u,a,ct([e,...v])))),await p([...!d&&l?g(k(N),(async n=>{n!=e&&(await t(O+P(a)+"DROP"+P(n)),B(f,n))})):[]]),d)c(n)?await t(I+P(a)+b+" true"):await p(K(n,(async(n,s)=>{c(n)?await t(I+P(a)+b+P(e)+"=$1",[s]):h(v)||await o(t,a,e,Y(n),{[s]:r?g(Q(n),r):Q(n)},f)})));else if(h(v))j(u,a)&&await t(I+P(a)+b+" true");else{const s=m(k(nt(u,a)),(t=>t!=e)),i={},c=[];K(n??{},((t,a)=>{i[a]=g(s,(a=>r?r(t?.[a]):t?.[a])),A(c,a)})),await o(t,a,e,s,i),await t(I+P(a)+b+P(e)+`NOT IN(${F(c)})`,c)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){n?.(t)}return await t("END"),e}]},vt=async(t,a,e,n,i)=>{const o=[1];await t("INSERT INTO"+P(a)+"("+((...t)=>E(g(t,P),s))(e,...n)+")VALUES"+E(K(i,(t=>"($"+o[0]+++","+F(t,o)+")")),s)+"ON CONFLICT("+P(e)+")DO UPDATE SET"+E(g(n,(t=>P(t)+"=excluded."+P(t))),s),K(i,((t,a)=>[a,...g(t,(t=>t??null))])).flat())},ft=(t,a,e,n,s,i,o,[r,c,l],u,y,d,w,p,v)=>{const[f,E,g,h]=pt(a,u,y,s,p,v),m=wt(t,(async()=>await h((async()=>{return await f(),t=(await E(r,c))[S]?.[l]??"null",at(t,((t,a)=>"￼"===a?void 0:a));var t}))),(async t=>await h((async()=>{var a;await f(),await g(r,c,{[S]:{[l]:(a=t()??null,tt(a,((t,a)=>void 0===a?"￼":a)))}},!0,!0)}))),e,n,s,o,{[w]:()=>d,destroy:()=>(m.stopAutoLoad().stopAutoSave(),i(),m)},0,d);return m},Et=(t,a,e,n,s,i,o,[r,l,[u,y,d]],w,v,f,E,g,h,A,N)=>{const[$,b,C,O]=pt(a,w,v,s,g,h,A,N),I=async(t,a)=>await p(st(l,(async([e,n,s,i],o)=>{a&&!(o in t)||await C(e,n,t[o],s,i,a)}))),L=async(t,a)=>y?await C(d,T,{[S]:t},!0,!0,a):null,R=wt(t,(async()=>await O((async()=>{await $();const t=await(async()=>G(m(await p(st(r,(async([t,a],e)=>[t,await b(e,a)]))),(t=>!Z(t[1])))))(),a=await(async()=>u?(await b(d,T))[S]:{})();return Z(t)&&c(a)?void 0:[t,a]}))),(async(t,a)=>await O((async()=>{if(await $(),c(a)){const[a,e]=t();await I(a),await L(e)}else await I(a[0],!0),await L(a[1],!0)}))),e,n,s,o,{[E]:()=>f,destroy:()=>(R.stopAutoLoad().stopAutoSave(),i(),R)},0,f);return R},gt="ColumnName",ht="store",mt="json",At=ht+"TableName",Nt=ht+"Id"+gt,St=ht+gt,Tt="autoLoadIntervalSeconds",$t="rowId"+gt,bt="tableId",Ct="tableName",Ot="deleteEmptyColumns",It="deleteEmptyTable",Lt={mode:mt,[Tt]:1},Rt={load:0,save:0,[Ct]:e+"_values"},Dt=(t,a,e,n,s)=>{const i=et();return K(t,((t,o)=>{const r=d(Q(H(a,u(t)?{[e]:t}:t)),0,X(a));c(r[0])||n(o,r[0])||(s(o,r[0]),it(i,o,r))})),i},_t=(t,a,s,i,o,c,l,y,w,p,v="getDb",f)=>{let E,g,h;const m=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(s,c),[A,N,S,C]=(t=>{const a=(t=>H(Lt,u(t)?{[At]:t}:t??{}))(t),n=a[Tt];if(a.mode==mt){const t=a[At]??e;return[1,n,[t,a[Nt]??T,a[St]??ht],ct(t)]}const{tables:{load:s={},save:i={}}={},values:o={}}=a,r=d(Q(H(Rt,o)),0,X(Rt)),c=r[2],l=ct(c),y=ct(c);return[0,n,[Dt(s,{[bt]:null,[$t]:T},bt,(t=>j(y,t)),(t=>lt(l,t))),Dt(i,{[Ct]:null,[$t]:T,[Ot]:0,[It]:0},Ct,((t,a)=>j(y,a)),((t,a)=>lt(l,a))),r],l]})(a);return(A?ft:Et)(t,m,(t=>{let a;const e=()=>a=setInterval((async()=>{try{const[{d:a,s:e,c:n}]=await m(`${$} ${D} d,${_} s,TOTAL_CHANGES() c FROM ${R}${D} JOIN ${R}${_}`);a==E&&e==g&&n==h||(null!=E&&t(),E=a,g=e,h=n)}catch{}}),1e3*N),n=()=>{E=g=h=null,r(a)},s=i((a=>{C.has(a)&&(n(),t(),e())}));return e(),()=>{n(),o(s)}}),(t=>t()),l,y,w,S,k(C),(async(t,a)=>await t(`${$} t.name tn,c.name cn FROM ${M}list()t,${M}info(t.name)c ${b} t.schema='main'AND t.type IN('table','view')AND t.name IN(${F(a)})ORDER BY t.name,c.name`,a)),p,v,n,f,(t=>!0===t?1:!1===t?0:t),void 0)};t.createSqliteWasmPersister=(t,a,e,n,s,i)=>_t(t,n,(async(t,a=[])=>e.exec(t,{bind:a,rowMode:"object",returnValue:"resultRows"}).map((t=>({...t})))),(t=>a.capi.sqlite3_update_hook(e,((a,e,n,s)=>t(s)),0)),(()=>a.capi.sqlite3_update_hook(e,(()=>0),0)),s,i,(()=>0),3,e)},"object"==typeof exports&&"undefined"!=typeof module?a(exports):"function"==typeof define&&define.amd?define(["exports"],a):a((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterSqliteWasm={});
