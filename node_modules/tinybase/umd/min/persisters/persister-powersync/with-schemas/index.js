var t,a;t=this,a=function(t){"use strict";const a=t=>typeof t,e="tinybase",n="",s=",",o=a(n),r=Promise,i=clearInterval,c=t=>null==t,l=(t,a,e)=>c(t)?e?.():a(t),y=t=>a(t)==o,u=t=>Array.isArray(t),w=(t,a,e)=>t.slice(a,e),d=t=>t.length,E=async t=>r.all(t),p=t=>{throw Error(t)},f=(t,a)=>t.forEach(a),v=(t,a="")=>t.join(a),g=(t,a)=>t.map(a),h=t=>0==d(t),A=(t,a)=>t.filter(a),T=(t,...a)=>t.push(...a),m=t=>t.shift(),N=Object,S=t=>N.getPrototypeOf(t),b=N.entries,C=N.keys,$=N.freeze,O=(t=[])=>N.fromEntries(t),I=(...t)=>N.assign({},...t),L=(t,a)=>(delete t[a],t),R=(t,a)=>g(b(t),(([t,e])=>a(e,t))),D=t=>N.values(t),P=t=>d(C(t)),M=t=>(t=>!c(t)&&l(S(t),(t=>t==N.prototype||c(S(t))),(()=>!0)))(t)&&0==P(t),_=t=>new Set(u(t)||c(t)?t:[t]),F=(t,a)=>t?.add(a),x="_",U="_id",j="SELECT",B="WHERE",H="TABLE",J="ALTER "+H,Y="DELETE FROM",k=j+"*FROM",z="pragma_",G="data_version",V="schema_version",W="pragma_table_",K=t=>`"${t.replace(/"/g,'""')}"`,Q=(...t)=>v(g(t,K),s),X=(t,a=[1])=>v(g(t,(()=>"$"+a[0]++)),s),q=(t,a)=>t?.has(a)??!1,Z=t=>c(t)||0==(t=>t?.size??0)(t),tt=t=>[...t?.values()??[]],at=(t,a)=>t?.forEach(a),et=(t,a)=>t?.delete(a),nt=JSON.stringify,st=JSON.parse,ot=t=>new Map(t),rt=(t,a)=>t?.get(a),it=(t,a)=>g([...t?.entries()??[]],(([t,e])=>a(e,t))),ct=(t,a,e)=>c(e)?(et(t,a),t):t?.set(a,e),lt=(t,a,e,n)=>(q(t,a)?n?.(rt(t,a)):ct(t,a,e()),rt(t,a)),yt=(t,a,e,n,s=0)=>l((e?lt:rt)(t,a[s],s>d(a)-2?e:ot),(o=>{if(s>d(a)-2)return n?.(o)&&ct(t,a[s]),o;const r=yt(o,a,e,n,s+1);return Z(o)&&ct(t,a[s]),r})),ut=/^\d+$/,wt=ot(),dt=ot(),Et=(t,a,e,s,o,r,i,y={},w=0,E=[])=>{let v,g,h,A=0,N=0,S=0;lt(wt,E,(()=>0)),lt(dt,E,(()=>[]));const b=ot(),[C,O,I,L,R]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!M(t)||!M(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!M(t)||!M(a),a.setContent]:p("Store type not supported by this Persister"))(i,t,w),[D,P,x]=(()=>{let t;const[a,e]=(()=>{const t=[];let a=0;return[e=>(e?m(t):null)??n+a++,a=>{ut.test(a)&&d(t)<1e3&&T(t,a)}]})(),s=ot();return[(e,o,r,i=[],c=()=>[])=>{t??=z;const l=a(1);return ct(s,l,[e,o,r,i,c]),F(yt(o,r??[n],_),l),l},(a,e,...o)=>f(((t,a=[n])=>{const e=[],s=(t,n)=>n==d(a)?T(e,t):null===a[n]?at(t,(t=>s(t,n+1))):f([a[n],null],(a=>s(rt(t,a),n+1)));return s(t,0),e})(a,e),(a=>at(a,(a=>rt(s,a)[0](t,...e??[],...o))))),t=>l(rt(s,t),(([,a,o])=>(yt(a,o??[n],void 0,(a=>(et(a,t),Z(a)?1:0))),ct(s,t),e(t),o))),a=>l(rt(s,a),(([a,,e=[],n,s])=>{const o=(...r)=>{const i=d(r);i==d(e)?a(t,...r,...s(r)):c(e[i])?f(n[i]?.(...r)??[],(t=>o(...r,t))):o(...r,e[i])};o()}))]})(),U=t=>{t!=A&&(A=t,P(b,void 0,A))},j=a=>{(C&&u(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},B=async t=>(2!=A&&(U(1),N++,await k((async()=>{try{const e=await a();u(e)?j(e):t?R(t):p("Content is not an array: "+e)}catch(a){r?.(a),t&&R(t)}U(0)}))),z),H=()=>(g&&(o(g),g=void 0),z),J=async t=>(1!=A&&(U(2),S++,await k((async()=>{try{await e(O,t)}catch(t){r?.(t)}U(0)}))),z),Y=()=>(h&&(t.delListener(h),h=void 0),z),k=async(...t)=>(T(rt(dt,E),...t),await(async()=>{if(!rt(wt,E)){for(ct(wt,E,1);!c(v=m(rt(dt,E)));)try{await v()}catch(t){r?.(t)}ct(wt,E,0)}})(),z),z={load:B,startAutoLoad:async t=>{H(),await B(t);try{g=await s((async(t,a)=>{a||t?2!=A&&(U(1),N++,j(a??t),U(0)):await B()}))}catch(t){r?.(t)}return z},stopAutoLoad:H,isAutoLoading:()=>!c(g),save:J,startAutoSave:async()=>(Y(),await J(),h=t.addDidFinishTransactionListener((()=>{const t=I();L(t)&&J(t)})),z),stopAutoSave:Y,isAutoSaving:()=>!c(h),getStatus:()=>A,addStatusListener:t=>D(t,b),delListener:a=>(x(a),t),schedule:k,getStore:()=>t,destroy:()=>(rt(dt,E).splice(0,void 0),H().stopAutoSave()),getStats:()=>({loads:N,saves:S}),...y};return $(z)},pt=(t,a,e,n,o,r=ft,i,l)=>{const y=ot();return[async()=>{y.clear(),g(await e(t,a),(({tn:t,cn:a})=>F(lt(y,t,_),a)))},async(a,e)=>((t,a)=>q(rt(y,t),a))(a,e)?O(A(g(await t(k+K(a)),(t=>{return[t[e],l?(a=L(t,e),n=l,O(R(a,((t,a)=>[a,n(t,a)])))):L(t,e)];var a,n})),(([t,a])=>!c(t)&&!M(a)))):{},async(a,e,n,l,u,w=!1)=>{const d=_();R(n??{},(t=>g(C(t??{}),(t=>F(d,t)))));const p=tt(d);if(!w&&u&&h(p)&&q(y,a))return await t("DROP "+H+K(a)),void ct(y,a);const f=rt(y,a),m=_(tt(f));if(h(p)||(q(y,a)?await E(g([e,...p],(async(n,s)=>{et(m,n)||(await t(J+K(a)+"ADD"+K(n)+o),0==s&&await t("CREATE UNIQUE INDEX pk ON "+K(a)+`(${K(e)})`),F(f,n))}))):(await t("CREATE "+H+K(a)+`(${K(e)}${o} PRIMARY KEY${v(g(p,(t=>s+K(t)+o)))});`),ct(y,a,_([e,...p])))),await E([...!w&&l?g(tt(m),(async n=>{n!=e&&(await t(J+K(a)+"DROP"+K(n)),et(f,n))})):[]]),w)c(n)?await t(Y+K(a)+B+" true"):await E(R(n,(async(n,s)=>{c(n)?await t(Y+K(a)+B+K(e)+"=$1",[s]):h(p)||await r(t,a,e,C(n),{[s]:i?g(D(n),i):D(n)},f)})));else if(h(p))q(y,a)&&await t(Y+K(a)+B+" true");else{const s=A(tt(rt(y,a)),(t=>t!=e)),o={},c=[];R(n??{},((t,a)=>{o[a]=g(s,(a=>i?i(t?.[a]):t?.[a])),T(c,a)})),await r(t,a,e,s,o),await t(Y+K(a)+B+K(e)+`NOT IN(${X(c)})`,c)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){n?.(t)}return await t("END"),e}]},ft=async(t,a,e,n,o)=>{const r=[1];await t("INSERT INTO"+K(a)+"("+Q(e,...n)+")VALUES"+v(R(o,(t=>"($"+r[0]+++","+X(t,r)+")")),s)+"ON CONFLICT("+K(e)+")DO UPDATE SET"+v(g(n,(t=>K(t)+"=excluded."+K(t))),s),R(o,((t,a)=>[a,...g(t,(t=>t??null))])).flat())},vt=(t,a,e,n,s,o,r,[i,c,l],y,u,w,d,E,p)=>{const[f,v,g,h]=pt(a,y,u,s,E,p),A=Et(t,(async()=>await h((async()=>{return await f(),t=(await v(i,c))[x]?.[l]??"null",st(t,((t,a)=>"￼"===a?void 0:a));var t}))),(async t=>await h((async()=>{var a;await f(),await g(i,c,{[x]:{[l]:(a=t()??null,nt(a,((t,a)=>void 0===a?"￼":a)))}},!0,!0)}))),e,n,s,r,{[d]:()=>w,destroy:()=>(A.stopAutoLoad().stopAutoSave(),o(),A)},0,w);return A},gt=(t,a,e,n,s,o,r,[i,l,[y,u,w]],d,p,f,v,g,h,T,m)=>{const[N,S,b,C]=pt(a,d,p,s,g,h,T,m),$=async(t,a)=>await E(it(l,(async([e,n,s,o],r)=>{a&&!(r in t)||await b(e,n,t[r],s,o,a)}))),I=async(t,a)=>u?await b(w,U,{[x]:t},!0,!0,a):null,L=Et(t,(async()=>await C((async()=>{await N();const t=await(async()=>O(A(await E(it(i,(async([t,a],e)=>[t,await S(e,a)]))),(t=>!M(t[1])))))(),a=await(async()=>y?(await S(w,U))[x]:{})();return M(t)&&c(a)?void 0:[t,a]}))),(async(t,a)=>await C((async()=>{if(await N(),c(a)){const[a,e]=t();await $(a),await I(e)}else await $(a[0],!0),await I(a[1],!0)}))),e,n,s,r,{[v]:()=>f,destroy:()=>(L.stopAutoLoad().stopAutoSave(),o(),L)},0,f);return L},ht="ColumnName",At="store",Tt="json",mt=At+"TableName",Nt=At+"Id"+ht,St=At+ht,bt="autoLoadIntervalSeconds",Ct="rowId"+ht,$t="tableId",Ot="tableName",It="deleteEmptyColumns",Lt="deleteEmptyTable",Rt={mode:Tt,[bt]:1},Dt={load:0,save:0,[Ot]:e+"_values"},Pt=(t,a,e,n,s)=>{const o=ot();return R(t,((t,r)=>{const i=w(D(I(a,y(t)?{[e]:t}:t)),0,P(a));c(i[0])||n(r,i[0])||(s(r,i[0]),ct(o,r,i))})),o},Mt=(t,a,s,o,r,c,l,u,d,E,p="getDb",f)=>{let v,g,h;const A=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(s,c),[T,m,N,S]=(t=>{const a=(t=>I(Rt,y(t)?{[mt]:t}:t??{}))(t),n=a[bt];if(a.mode==Tt){const t=a[mt]??e;return[1,n,[t,a[Nt]??U,a[St]??At],_(t)]}const{tables:{load:s={},save:o={}}={},values:r={}}=a,i=w(D(I(Dt,r)),0,P(Dt)),c=i[2],l=_(c),u=_(c);return[0,n,[Pt(s,{[$t]:null,[Ct]:U},$t,(t=>q(u,t)),(t=>F(l,t))),Pt(o,{[Ot]:null,[Ct]:U,[It]:0,[Lt]:0},Ot,((t,a)=>q(u,a)),((t,a)=>F(l,a))),i],l]})(a);return(T?vt:gt)(t,A,(t=>{let a;const e=()=>a=setInterval((async()=>{try{const[{d:a,s:e,c:n}]=await A(`${j} ${G} d,${V} s,TOTAL_CHANGES() c FROM ${z}${G} JOIN ${z}${V}`);a==v&&e==g&&n==h||(null!=v&&t(),v=a,g=e,h=n)}catch{}}),1e3*m),n=()=>{v=g=h=null,i(a)},s=o((a=>{S.has(a)&&(n(),t(),e())}));return e(),()=>{n(),r(s)}}),(t=>t()),l,u,d,N,tt(S),(async(t,a)=>await t(`${j} t.name tn,c.name cn FROM ${W}list()t,${W}info(t.name)c ${B} t.schema='main'AND t.type IN('table','view')AND t.name IN(${X(a)})ORDER BY t.name,c.name`,a)),E,p,n,f,(t=>!0===t?1:!1===t?0:t),void 0)},_t=async(t,a,e,n,o,r)=>{const i=[1],c=_(n),l=r?A([...r],(t=>t!=e&&!q(c,t))):[];if(!h(l)){const n=C(o),s=O(g(await t("SELECT"+Q(e,...l)+"FROM"+K(a)+"WHERE"+K(e)+"IN("+X(n)+")",n),(t=>[t[e],t])));f(n,(t=>T(o[t],...g(l,(a=>s?.[t]?.[a]??null)))))}await t("INSERT OR REPLACE INTO"+K(a)+"("+Q(e,...n,...l)+")VALUES"+v(R(o,(t=>"($"+i[0]+++","+X(t,i)+")")),s),R(o,((t,a)=>[a,...g(t,(t=>t??null))])).flat())};t.createPowerSyncPersister=(t,a,e,n,s)=>{let o;return Mt(t,e,(async(t,e=[])=>a.execute(t,e).then((t=>t.rows?._array??[]))),(t=>{const e=new AbortController,n=a.onChange({rawTableNames:!0,signal:e.signal});return(async()=>{for await(const t of n)o&&g(t.changedTables,o)})(),o=t,e}),(t=>{o=void 0,t.abort()}),n,s,(()=>0),1,a,"getPowerSync",_t)}},"object"==typeof exports&&"undefined"!=typeof module?a(exports):"function"==typeof define&&define.amd?define(["exports"],a):a((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPowersync={});
