var e,n;e=this,n=function(e){"use strict";const n=e=>typeof e,l="tinybase",t="",o=",",r=n(t),i=Promise,u=clearInterval,a=e=>null==e,d=(e,n,l)=>a(e)?null==l?void 0:l():n(e),s=e=>n(e)==r,c=e=>Array.isArray(e),v=(e,n,l)=>e.slice(n,l),y=e=>e.length,f=e=>{return n=function*(){return i.all(e)},new Promise(((e,l)=>{var t=e=>{try{r(n.next(e))}catch(e){l(e)}},o=e=>{try{r(n.throw(e))}catch(e){l(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,o);r((n=n.apply(void 0,null)).next())}));var n},h=e=>{throw Error(e)},p=(e,n)=>e.forEach(n),m=(e,n="")=>e.join(n),E=(e,n)=>e.map(n),g=e=>0==y(e),b=(e,n)=>e.filter(n),P=(e,...n)=>e.push(...n),w=e=>e.shift(),S=Object,A=e=>S.getPrototypeOf(e),O=S.entries,T=S.keys,N=S.freeze,x=(e=[])=>S.fromEntries(e),C=(...e)=>S.assign({},...e),$=(e,n)=>(delete e[n],e),I=(e,n)=>E(O(e),(([e,l])=>n(l,e))),L=e=>S.values(e),R=e=>y(T(e)),D=e=>(e=>!a(e)&&d(A(e),(e=>e==S.prototype||a(A(e))),(()=>!0)))(e)&&0==R(e),M=e=>new Set(c(e)||a(e)?e:[e]),_=(e,n)=>null==e?void 0:e.add(n),j="_",F="_id",U="SELECT",B="WHERE",H="TABLE",J="ALTER "+H,Y="DELETE FROM",k=U+"*FROM",z="pragma_",G="data_version",V="schema_version",W="pragma_table_",K=e=>`"${e.replace(/"/g,'""')}"`,Q=(...e)=>m(E(e,K),o),X=(e,n=[1])=>m(E(e,(()=>"$"+n[0]++)),o),q=(e,n)=>{var l;return null!=(l=null==e?void 0:e.has(n))&&l},Z=e=>a(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),ee=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},ne=(e,n)=>null==e?void 0:e.forEach(n),le=(e,n)=>null==e?void 0:e.delete(n),te=JSON.stringify,oe=JSON.parse,re=e=>new Map(e),ie=(e,n)=>null==e?void 0:e.get(n),ue=(e,n)=>{var l;return E([...null!=(l=null==e?void 0:e.entries())?l:[]],(([e,l])=>n(l,e)))},ae=(e,n,l)=>a(l)?(le(e,n),e):null==e?void 0:e.set(n,l),de=(e,n,l,t)=>(q(e,n)?null==t||t(ie(e,n)):ae(e,n,l()),ie(e,n)),se=(e,n,l,t,o=0)=>d((l?de:ie)(e,n[o],o>y(n)-2?l:re),(r=>{if(o>y(n)-2)return(null==t?void 0:t(r))&&ae(e,n[o]),r;const i=se(r,n,l,t,o+1);return Z(r)&&ae(e,n[o]),i})),ce=/^\d+$/;var ve=Object.defineProperty,ye=Object.getOwnPropertySymbols,fe=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable,pe=(e,n,l)=>n in e?ve(e,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[n]=l,me=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ee=re(),ge=re(),be=(e,n,l,o,r,i,u,s={},v=0,f=[])=>{let m,E,g,b=0,S=0,A=0;de(Ee,f,(()=>0)),de(ge,f,(()=>[]));const O=re(),[T,x,C,$,I]=((e=1,n,l)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!l),([[e],[n]])=>!D(e)||!D(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!D(e)||!D(n),n.setContent]:h("Store type not supported by this Persister"))(u,e,v),[L,R,j]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var o;return null!=(o=l?w(e):null)?o:t+n++},n=>{ce.test(n)&&y(e)<1e3&&P(e,n)}]})(),o=re();return[(l,r,i,u=[],a=()=>[])=>{null!=e||(e=z);const d=n(1);return ae(o,d,[l,r,i,u,a]),_(se(r,null!=i?i:[t],M),d),d},(n,l,...r)=>p(((e,n=[t])=>{const l=[],o=(e,t)=>t==y(n)?P(l,e):null===n[t]?ne(e,(e=>o(e,t+1))):p([n[t],null],(n=>o(ie(e,n),t+1)));return o(e,0),l})(n,l),(n=>ne(n,(n=>ie(o,n)[0](e,...null!=l?l:[],...r))))),e=>d(ie(o,e),(([,n,r])=>(se(n,null!=r?r:[t],void 0,(n=>(le(n,e),Z(n)?1:0))),ae(o,e),l(e),r))),n=>d(ie(o,n),(([n,,l=[],t,o])=>{const r=(...i)=>{var u,d;const s=y(i);s==y(l)?n(e,...i,...o(i)):a(l[s])?p(null!=(d=null==(u=t[s])?void 0:u.call(t,...i))?d:[],(e=>r(...i,e))):r(...i,l[s])};r()}))]})(),F=e=>{e!=b&&(b=e,R(O,void 0,b))},U=n=>{(T&&c(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},B=e=>me(void 0,null,(function*(){return 2!=b&&(F(1),S++,yield k((()=>me(void 0,null,(function*(){try{const l=yield n();c(l)?U(l):e?I(e):h("Content is not an array: "+l)}catch(n){null==i||i(n),e&&I(e)}F(0)}))))),z})),H=()=>(E&&(r(E),E=void 0),z),J=e=>me(void 0,null,(function*(){return 1!=b&&(F(2),A++,yield k((()=>me(void 0,null,(function*(){try{yield l(x,e)}catch(e){null==i||i(e)}F(0)}))))),z})),Y=()=>(g&&(e.delListener(g),g=void 0),z),k=(...e)=>me(void 0,null,(function*(){return P(ie(ge,f),...e),yield me(void 0,null,(function*(){if(!ie(Ee,f)){for(ae(Ee,f,1);!a(m=w(ie(ge,f)));)try{yield m()}catch(e){null==i||i(e)}ae(Ee,f,0)}})),z})),z=((e,n)=>{for(var l in n||(n={}))fe.call(n,l)&&pe(e,l,n[l]);if(ye)for(var l of ye(n))he.call(n,l)&&pe(e,l,n[l]);return e})({load:B,startAutoLoad:e=>me(void 0,null,(function*(){H(),yield B(e);try{E=yield o(((e,n)=>me(void 0,null,(function*(){n||e?2!=b&&(F(1),S++,U(null!=n?n:e),F(0)):yield B()}))))}catch(e){null==i||i(e)}return z})),stopAutoLoad:H,isAutoLoading:()=>!a(E),save:J,startAutoSave:()=>me(void 0,null,(function*(){return Y(),yield J(),g=e.addDidFinishTransactionListener((()=>{const e=C();$(e)&&J(e)})),z})),stopAutoSave:Y,isAutoSaving:()=>!a(g),getStatus:()=>b,addStatusListener:e=>L(e,O),delListener:n=>(j(n),e),schedule:k,getStore:()=>e,destroy:()=>(ie(ge,f).splice(0,void 0),H().stopAutoSave()),getStats:()=>({loads:S,saves:A})},s);return N(z)};var Pe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const we=(e,n,l,t,r,i=Se,u,d)=>{const s=re();return[()=>Pe(void 0,null,(function*(){s.clear(),E(yield l(e,n),(({tn:e,cn:n})=>_(de(s,e,M),n)))})),(n,l)=>Pe(void 0,null,(function*(){return((e,n)=>q(ie(s,e),n))(n,l)?x(b(E(yield e(k+K(n)),(e=>{return[e[l],d?(n=$(e,l),t=d,x(I(n,((e,n)=>[n,t(e,n)])))):$(e,l)];var n,t})),(([e,n])=>!a(e)&&!D(n)))):{}})),(n,l,t,d,c,v=!1)=>Pe(void 0,null,(function*(){const y=M();I(null!=t?t:{},(e=>E(T(null!=e?e:{}),(e=>_(y,e)))));const h=ee(y);if(!v&&c&&g(h)&&q(s,n))return yield e("DROP "+H+K(n)),void ae(s,n);const p=ie(s,n),w=M(ee(p));if(g(h)||(q(s,n)?yield f(E([l,...h],((t,o)=>Pe(void 0,null,(function*(){le(w,t)||(yield e(J+K(n)+"ADD"+K(t)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+K(n)+`(${K(l)})`)),_(p,t))}))))):(yield e("CREATE "+H+K(n)+`(${K(l)}${r} PRIMARY KEY${m(E(h,(e=>o+K(e)+r)))});`),ae(s,n,M([l,...h])))),yield f([...!v&&d?E(ee(w),(t=>Pe(void 0,null,(function*(){t!=l&&(yield e(J+K(n)+"DROP"+K(t)),le(p,t))})))):[]]),v)a(t)?yield e(Y+K(n)+B+" true"):yield f(I(t,((t,o)=>Pe(void 0,null,(function*(){a(t)?yield e(Y+K(n)+B+K(l)+"=$1",[o]):g(h)||(yield i(e,n,l,T(t),{[o]:u?E(L(t),u):L(t)},p))})))));else if(g(h))q(s,n)&&(yield e(Y+K(n)+B+" true"));else{const o=b(ee(ie(s,n)),(e=>e!=l)),r={},a=[];I(null!=t?t:{},((e,n)=>{r[n]=E(o,(n=>u?u(null==e?void 0:e[n]):null==e?void 0:e[n])),P(a,n)})),yield i(e,n,l,o,r),yield e(Y+K(n)+B+K(l)+`NOT IN(${X(a)})`,a)}})),n=>Pe(void 0,null,(function*(){let l;yield e("BEGIN");try{l=yield n()}catch(e){null==t||t(e)}return yield e("END"),l}))]},Se=(e,n,l,t,r)=>Pe(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+K(n)+"("+Q(l,...t)+")VALUES"+m(I(r,(e=>"($"+i[0]+++","+X(e,i)+")")),o)+"ON CONFLICT("+K(l)+")DO UPDATE SET"+m(E(t,(e=>K(e)+"=excluded."+K(e))),o),I(r,((e,n)=>[n,...E(e,(e=>null!=e?e:null))])).flat())}));var Ae=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Oe=(e,n,l,t,o,r,i,[u,a,d],s,c,v,y,f,h)=>{const[p,m,E,g]=we(n,s,c,o,f,h),b=be(e,(()=>Ae(void 0,null,(function*(){return yield g((()=>Ae(void 0,null,(function*(){var e,n,l;return yield p(),l=null!=(n=null==(e=(yield m(u,a))[j])?void 0:e[d])?n:"null",oe(l,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>Ae(void 0,null,(function*(){return yield g((()=>Ae(void 0,null,(function*(){var n,l;yield p(),yield E(u,a,{[j]:{[d]:(l=null!=(n=e())?n:null,te(l,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),l,t,o,i,{[y]:()=>v,destroy:()=>(b.stopAutoLoad().stopAutoSave(),r(),b)},0,v);return b};var Te=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ne=(e,n,l,t,o,r,i,[u,d,[s,c,v]],y,h,p,m,E,g,P,w)=>{const[S,A,O,T]=we(n,y,h,o,E,g,P,w),N=(e,n)=>Te(void 0,null,(function*(){return yield f(ue(d,((l,t)=>Te(void 0,[l,t],(function*([l,t,o,r],i){n&&!(i in e)||(yield O(l,t,e[i],o,r,n))})))))})),C=(e,n)=>Te(void 0,null,(function*(){return c?yield O(v,F,{[j]:e},!0,!0,n):null})),$=be(e,(()=>Te(void 0,null,(function*(){return yield T((()=>Te(void 0,null,(function*(){yield S();const e=yield Te(void 0,null,(function*(){return x(b(yield f(ue(u,((e,n)=>Te(void 0,[e,n],(function*([e,n],l){return[e,yield A(l,n)]}))))),(e=>!D(e[1]))))})),n=yield Te(void 0,null,(function*(){return s?(yield A(v,F))[j]:{}}));return D(e)&&a(n)?void 0:[e,n]}))))}))),((e,n)=>Te(void 0,null,(function*(){return yield T((()=>Te(void 0,null,(function*(){if(yield S(),a(n)){const[n,l]=e();yield N(n),yield C(l)}else yield N(n[0],!0),yield C(n[1],!0)}))))}))),l,t,o,i,{[m]:()=>p,destroy:()=>($.stopAutoLoad().stopAutoSave(),r(),$)},0,p);return $},xe="ColumnName",Ce="store",$e="json",Ie=Ce+"TableName",Le=Ce+"Id"+xe,Re=Ce+xe,De="autoLoadIntervalSeconds",Me="rowId"+xe,_e="tableId",je="tableName",Fe="deleteEmptyColumns",Ue="deleteEmptyTable",Be={mode:$e,[De]:1},He={load:0,save:0,[je]:l+"_values"},Je=(e,n,l,t,o)=>{const r=re();return I(e,((e,i)=>{const u=v(L(C(n,s(e)?{[l]:e}:e)),0,R(n));a(u[0])||t(i,u[0])||(o(i,u[0]),ae(r,i,u))})),r};var Ye=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const ke=(e,n,o,r,i,a,d,c,y,f,h="getDb",p)=>{let m,E,g;const b=((e,n)=>n?(l,t)=>{return o=function*(){return n(l,t),yield e(l,t)},new Promise(((e,n)=>{var l=e=>{try{r(o.next(e))}catch(e){n(e)}},t=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,t);r((o=o.apply(void 0,null)).next())}));var o}:e)(o,a),[P,w,S,A]=(e=>{var n,t,o;const r=(e=>C(Be,s(e)?{[Ie]:e}:null!=e?e:{}))(e),i=r[De];if(r.mode==$e){const e=null!=(n=r[Ie])?n:l;return[1,i,[e,null!=(t=r[Le])?t:F,null!=(o=r[Re])?o:Ce],M(e)]}const{tables:{load:u={},save:a={}}={},values:d={}}=r,c=v(L(C(He,d)),0,R(He)),y=c[2],f=M(y),h=M(y);return[0,i,[Je(u,{[_e]:null,[Me]:F},_e,(e=>q(h,e)),(e=>_(f,e))),Je(a,{[je]:null,[Me]:F,[Fe]:0,[Ue]:0},je,((e,n)=>q(h,n)),((e,n)=>_(f,n))),c],f]})(n);return(P?Oe:Ne)(e,b,(e=>{let n;const l=()=>n=setInterval((()=>Ye(void 0,null,(function*(){try{const[{d:n,s:l,c:t}]=yield b(`${U} ${G} d,${V} s,TOTAL_CHANGES() c FROM ${z}${G} JOIN ${z}${V}`);n==m&&l==E&&t==g||(null!=m&&e(),m=n,E=l,g=t)}catch(e){}}))),1e3*w),t=()=>{m=E=g=null,u(n)},o=r((n=>{A.has(n)&&(t(),e(),l())}));return l(),()=>{t(),i(o)}}),(e=>e()),d,c,y,S,ee(A),((e,n)=>Ye(void 0,null,(function*(){return yield e(`${U} t.name tn,c.name cn FROM ${W}list()t,${W}info(t.name)c ${B} t.schema='main'AND t.type IN('table','view')AND t.name IN(${X(n)})ORDER BY t.name,c.name`,n)}))),f,h,t,p,(e=>!0===e?1:!1===e?0:e),void 0)};var ze=(e,n)=>(n=Symbol[e])?n:Symbol.for("Symbol."+e),Ge=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ve=(e,n,l,t,r,i)=>Ge(void 0,null,(function*(){const u=[1],a=M(t),d=i?b([...i],(e=>e!=l&&!q(a,e))):[];if(!g(d)){const t=T(r),o=x(E(yield e("SELECT"+Q(l,...d)+"FROM"+K(n)+"WHERE"+K(l)+"IN("+X(t)+")",t),(e=>[e[l],e])));p(t,(e=>P(r[e],...E(d,(n=>{var l,t;return null!=(t=null==(l=null==o?void 0:o[e])?void 0:l[n])?t:null})))))}yield e("INSERT OR REPLACE INTO"+K(n)+"("+Q(l,...t,...d)+")VALUES"+m(I(r,(e=>"($"+u[0]+++","+X(e,u)+")")),o),I(r,((e,n)=>[n,...E(e,(e=>null!=e?e:null))])).flat())}));e.createPowerSyncPersister=(e,n,l,t,o)=>{let r;return ke(e,l,((e,...l)=>Ge(void 0,[e,...l],(function*(e,l=[]){return n.execute(e,l).then((e=>{var n,l;return null!=(l=null==(n=e.rows)?void 0:n._array)?l:[]}))}))),(e=>{const l=new AbortController,t=n.onChange({rawTableNames:!0,signal:l.signal});return Ge(void 0,null,(function*(){try{for(var e,n,l,o=((e,n,l)=>(n=e[ze("asyncIterator")])?n.call(e):(e=e[ze("iterator")](),n={},(l=(l,t)=>(t=e[l])&&(n[l]=n=>new Promise(((l,o,r)=>(n=t.call(e,n),r=n.done,Promise.resolve(n.value).then((e=>l({value:e,done:r})),o))))))("next"),l("return"),n))(t);e=!(n=yield o.next()).done;e=!1){const e=n.value;r&&E(e.changedTables,r)}}catch(n){l=[n]}finally{try{e&&(n=o.return)&&(yield n.call(o))}finally{if(l)throw l[0]}}})),r=e,l}),(e=>{r=void 0,e.abort()}),t,o,(()=>0),1,n,"getPowerSync",Ve)}},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterPowersync={});
