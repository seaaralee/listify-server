var e,n;e=this,n=function(e){"use strict";const n=e=>typeof e,t="tinybase",l=",",o=n(""),i=Promise,r=e=>null==e,u=(e,n,t)=>r(e)?null==t?void 0:t():n(e),d=e=>n(e)==o,a=e=>Array.isArray(e),c=(e,n,t)=>e.slice(n,t),s=e=>e.length,v=e=>{return n=function*(){return i.all(e)},new Promise(((e,t)=>{var l=e=>{try{i(n.next(e))}catch(e){t(e)}},o=e=>{try{i(n.throw(e))}catch(e){t(e)}},i=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,o);i((n=n.apply(void 0,null)).next())}));var n},y=e=>{throw Error(e)},E=(e,n)=>e.forEach(n),f=(e,n="")=>e.join(n),p=(e,n)=>e.map(n),h=e=>0==s(e),T=(e,n)=>e.filter(n),R=(e,...n)=>e.push(...n),A=e=>e.shift(),m="_",N="_id",g="SELECT",P="WHERE",O="TABLE",C="ALTER "+O,b="DELETE FROM",L=g+"*FROM",$=e=>`"${e.replace(/"/g,'""')}"`,I=(e,n=[1])=>f(p(e,(()=>"$"+n[0]++)),l),S=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},w=e=>r(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),_=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},x=(e,n)=>null==e?void 0:e.forEach(n),D=(e,n)=>null==e?void 0:e.delete(n),U=Object,F=e=>U.getPrototypeOf(e),M=U.entries,G=U.keys,j=U.freeze,B=(e=[])=>U.fromEntries(e),X=(...e)=>U.assign({},...e),Y=(e,n)=>(delete e[n],e),q=(e,n)=>p(M(e),(([e,t])=>n(t,e))),H=e=>U.values(e),W=e=>s(G(e)),k=e=>(e=>!r(e)&&u(F(e),(e=>e==U.prototype||r(F(e))),(()=>!0)))(e)&&0==W(e),z=JSON.stringify,J=JSON.parse,K=e=>new Map(e),V=(e,n)=>null==e?void 0:e.get(n),Q=(e,n)=>{var t;return p([...null!=(t=null==e?void 0:e.entries())?t:[]],(([e,t])=>n(t,e)))},Z=(e,n,t)=>r(t)?(D(e,n),e):null==e?void 0:e.set(n,t),ee=(e,n,t,l)=>(S(e,n)?null==l||l(V(e,n)):Z(e,n,t()),V(e,n)),ne=(e,n,t,l,o=0)=>u((t?ee:V)(e,n[o],o>s(n)-2?t:K),(i=>{if(o>s(n)-2)return(null==l?void 0:l(i))&&Z(e,n[o]),i;const r=ne(i,n,t,l,o+1);return w(i)&&Z(e,n[o]),r})),te=e=>new Set(a(e)||r(e)?e:[e]),le=(e,n)=>null==e?void 0:e.add(n),oe=/^\d+$/;var ie=Object.defineProperty,re=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable,ae=(e,n,t)=>n in e?ie(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,ce=(e,n,t)=>new Promise(((l,o)=>{var i=e=>{try{u(t.next(e))}catch(e){o(e)}},r=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,r);u((t=t.apply(e,n)).next())}));const se=K(),ve=K(),ye=(e,n,t,l,o,i,d,c={},v=0,f=[])=>{let p,h,T,m=0,N=0,g=0;ee(se,f,(()=>0)),ee(ve,f,(()=>[]));const P=K(),[O,C,b,L,$]=((e=1,n,t)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!t),([[e],[n]])=>!k(e)||!k(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!k(e)||!k(n),n.setContent]:y("Store type not supported by this Persister"))(d,e,v),[I,S,_]=(()=>{let e;const[n,t]=(()=>{const e=[];let n=0;return[t=>{var l;return null!=(l=t?A(e):null)?l:""+n++},n=>{oe.test(n)&&s(e)<1e3&&R(e,n)}]})(),l=K();return[(t,o,i,r=[],u=()=>[])=>{null!=e||(e=q);const d=n(1);return Z(l,d,[t,o,i,r,u]),le(ne(o,null!=i?i:[""],te),d),d},(n,t,...o)=>E(((e,n=[""])=>{const t=[],l=(e,o)=>o==s(n)?R(t,e):null===n[o]?x(e,(e=>l(e,o+1))):E([n[o],null],(n=>l(V(e,n),o+1)));return l(e,0),t})(n,t),(n=>x(n,(n=>V(l,n)[0](e,...null!=t?t:[],...o))))),e=>u(V(l,e),(([,n,o])=>(ne(n,null!=o?o:[""],void 0,(n=>(D(n,e),w(n)?1:0))),Z(l,e),t(e),o))),n=>u(V(l,n),(([n,,t=[],l,o])=>{const i=(...u)=>{var d,a;const c=s(u);c==s(t)?n(e,...u,...o(u)):r(t[c])?E(null!=(a=null==(d=l[c])?void 0:d.call(l,...u))?a:[],(e=>i(...u,e))):i(...u,t[c])};i()}))]})(),U=e=>{e!=m&&(m=e,S(P,void 0,m))},F=n=>{(O&&a(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},M=e=>ce(void 0,null,(function*(){return 2!=m&&(U(1),N++,yield Y((()=>ce(void 0,null,(function*(){try{const t=yield n();a(t)?F(t):e?$(e):y("Content is not an array: "+t)}catch(n){null==i||i(n),e&&$(e)}U(0)}))))),q})),G=()=>(h&&(o(h),h=void 0),q),B=e=>ce(void 0,null,(function*(){return 1!=m&&(U(2),g++,yield Y((()=>ce(void 0,null,(function*(){try{yield t(C,e)}catch(e){null==i||i(e)}U(0)}))))),q})),X=()=>(T&&(e.delListener(T),T=void 0),q),Y=(...e)=>ce(void 0,null,(function*(){return R(V(ve,f),...e),yield ce(void 0,null,(function*(){if(!V(se,f)){for(Z(se,f,1);!r(p=A(V(ve,f)));)try{yield p()}catch(e){null==i||i(e)}Z(se,f,0)}})),q})),q=((e,n)=>{for(var t in n||(n={}))ue.call(n,t)&&ae(e,t,n[t]);if(re)for(var t of re(n))de.call(n,t)&&ae(e,t,n[t]);return e})({load:M,startAutoLoad:e=>ce(void 0,null,(function*(){G(),yield M(e);try{h=yield l(((e,n)=>ce(void 0,null,(function*(){n||e?2!=m&&(U(1),N++,F(null!=n?n:e),U(0)):yield M()}))))}catch(e){null==i||i(e)}return q})),stopAutoLoad:G,isAutoLoading:()=>!r(h),save:B,startAutoSave:()=>ce(void 0,null,(function*(){return X(),yield B(),T=e.addDidFinishTransactionListener((()=>{const e=b();L(e)&&B(e)})),q})),stopAutoSave:X,isAutoSaving:()=>!r(T),getStatus:()=>m,addStatusListener:e=>I(e,P),delListener:n=>(_(n),e),schedule:Y,getStore:()=>e,destroy:()=>(V(ve,f).splice(0,void 0),G().stopAutoSave()),getStats:()=>({loads:N,saves:g})},c);return j(q)};var Ee=(e,n,t)=>new Promise(((l,o)=>{var i=e=>{try{u(t.next(e))}catch(e){o(e)}},r=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,r);u((t=t.apply(e,n)).next())}));const fe=(e,n,t,o,i,u=pe,d,a)=>{const c=K();return[()=>Ee(void 0,null,(function*(){c.clear(),p(yield t(e,n),(({tn:e,cn:n})=>le(ee(c,e,te),n)))})),(n,t)=>Ee(void 0,null,(function*(){return((e,n)=>S(V(c,e),n))(n,t)?B(T(p(yield e(L+$(n)),(e=>{return[e[t],a?(n=Y(e,t),l=a,B(q(n,((e,n)=>[n,l(e,n)])))):Y(e,t)];var n,l})),(([e,n])=>!r(e)&&!k(n)))):{}})),(n,t,o,a,s,y=!1)=>Ee(void 0,null,(function*(){const E=te();q(null!=o?o:{},(e=>p(G(null!=e?e:{}),(e=>le(E,e)))));const A=_(E);if(!y&&s&&h(A)&&S(c,n))return yield e("DROP "+O+$(n)),void Z(c,n);const m=V(c,n),N=te(_(m));if(h(A)||(S(c,n)?yield v(p([t,...A],((l,o)=>Ee(void 0,null,(function*(){D(N,l)||(yield e(C+$(n)+"ADD"+$(l)+i),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+$(n)+`(${$(t)})`)),le(m,l))}))))):(yield e("CREATE "+O+$(n)+`(${$(t)}${i} PRIMARY KEY${f(p(A,(e=>l+$(e)+i)))});`),Z(c,n,te([t,...A])))),yield v([...!y&&a?p(_(N),(l=>Ee(void 0,null,(function*(){l!=t&&(yield e(C+$(n)+"DROP"+$(l)),D(m,l))})))):[]]),y)r(o)?yield e(b+$(n)+P+" true"):yield v(q(o,((l,o)=>Ee(void 0,null,(function*(){r(l)?yield e(b+$(n)+P+$(t)+"=$1",[o]):h(A)||(yield u(e,n,t,G(l),{[o]:d?p(H(l),d):H(l)},m))})))));else if(h(A))S(c,n)&&(yield e(b+$(n)+P+" true"));else{const l=T(_(V(c,n)),(e=>e!=t)),i={},r=[];q(null!=o?o:{},((e,n)=>{i[n]=p(l,(n=>d?d(null==e?void 0:e[n]):null==e?void 0:e[n])),R(r,n)})),yield u(e,n,t,l,i),yield e(b+$(n)+P+$(t)+`NOT IN(${I(r)})`,r)}})),n=>Ee(void 0,null,(function*(){let t;yield e("BEGIN");try{t=yield n()}catch(e){null==o||o(e)}return yield e("END"),t}))]},pe=(e,n,t,o,i)=>Ee(void 0,null,(function*(){const r=[1];yield e("INSERT INTO"+$(n)+"("+((...e)=>f(p(e,$),l))(t,...o)+")VALUES"+f(q(i,(e=>"($"+r[0]+++","+I(e,r)+")")),l)+"ON CONFLICT("+$(t)+")DO UPDATE SET"+f(p(o,(e=>$(e)+"=excluded."+$(e))),l),q(i,((e,n)=>[n,...p(e,(e=>null!=e?e:null))])).flat())}));var he=(e,n,t)=>new Promise(((l,o)=>{var i=e=>{try{u(t.next(e))}catch(e){o(e)}},r=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,r);u((t=t.apply(e,n)).next())}));const Te=(e,n,t,l,o,i,r,[u,d,a],c,s,v,y,E,f)=>{const[p,h,T,R]=fe(n,c,s,o,E,f),A=ye(e,(()=>he(void 0,null,(function*(){return yield R((()=>he(void 0,null,(function*(){var e,n,t;return yield p(),t=null!=(n=null==(e=(yield h(u,d))[m])?void 0:e[a])?n:"null",J(t,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>he(void 0,null,(function*(){return yield R((()=>he(void 0,null,(function*(){var n,t;yield p(),yield T(u,d,{[m]:{[a]:(t=null!=(n=e())?n:null,z(t,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),t,l,o,r,{[y]:()=>v,destroy:()=>(A.stopAutoLoad().stopAutoSave(),i(),A)},0,v);return A};var Re=(e,n,t)=>new Promise(((l,o)=>{var i=e=>{try{u(t.next(e))}catch(e){o(e)}},r=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,r);u((t=t.apply(e,n)).next())}));const Ae=(e,n,t,l,o,i,u,[d,a,[c,s,y]],E,f,p,h,R,A,g,P)=>{const[O,C,b,L]=fe(n,E,f,o,R,A,g,P),$=(e,n)=>Re(void 0,null,(function*(){return yield v(Q(a,((t,l)=>Re(void 0,[t,l],(function*([t,l,o,i],r){n&&!(r in e)||(yield b(t,l,e[r],o,i,n))})))))})),I=(e,n)=>Re(void 0,null,(function*(){return s?yield b(y,N,{[m]:e},!0,!0,n):null})),S=ye(e,(()=>Re(void 0,null,(function*(){return yield L((()=>Re(void 0,null,(function*(){yield O();const e=yield Re(void 0,null,(function*(){return B(T(yield v(Q(d,((e,n)=>Re(void 0,[e,n],(function*([e,n],t){return[e,yield C(t,n)]}))))),(e=>!k(e[1]))))})),n=yield Re(void 0,null,(function*(){return c?(yield C(y,N))[m]:{}}));return k(e)&&r(n)?void 0:[e,n]}))))}))),((e,n)=>Re(void 0,null,(function*(){return yield L((()=>Re(void 0,null,(function*(){if(yield O(),r(n)){const[n,t]=e();yield $(n),yield I(t)}else yield $(n[0],!0),yield I(n[1],!0)}))))}))),t,l,o,u,{[h]:()=>p,destroy:()=>(S.stopAutoLoad().stopAutoSave(),i(),S)},0,p);return S},me="ColumnName",Ne="store",ge="json",Pe=Ne+"TableName",Oe=Ne+"Id"+me,Ce=Ne+me,be="autoLoadIntervalSeconds",Le="rowId"+me,$e="tableId",Ie="tableName",Se="deleteEmptyColumns",we="deleteEmptyTable",_e={mode:ge,[be]:1},xe={load:0,save:0,[Ie]:t+"_values"},De=(e,n,t,l,o)=>{const i=K();return q(e,((e,u)=>{const a=c(H(X(n,d(e)?{[t]:e}:e)),0,W(n));r(a[0])||l(u,a[0])||(o(u,a[0]),Z(i,u,a))})),i};var Ue=(e,n,t)=>new Promise(((l,o)=>{var i=e=>{try{u(t.next(e))}catch(e){o(e)}},r=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,r);u((t=t.apply(e,n)).next())}));const Fe=t,Me=/^([cd]:)(.+)/,Ge=t+"_data",je=t+"_table";var Be=(e,n,t)=>new Promise(((l,o)=>{var i=e=>{try{u(t.next(e))}catch(e){o(e)}},r=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,r);u((t=t.apply(e,n)).next())}));e.createPglitePersister=(e,n,l,o,i)=>Be(void 0,null,(function*(){return((e,n,l,o,i,r,a,s,y,E,f="getDb")=>{const h=((e,n)=>n?(t,l)=>{return o=function*(){return n(t,l),yield e(t,l)},new Promise(((e,n)=>{var t=e=>{try{i(o.next(e))}catch(e){n(e)}},l=e=>{try{i(o.throw(e))}catch(e){n(e)}},i=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,l);i((o=o.apply(void 0,null)).next())}));var o}:e)(l,r),[T,,R,A]=(e=>{var n,l,o;const i=(e=>X(_e,d(e)?{[Pe]:e}:null!=e?e:{}))(e),r=i[be];if(i.mode==ge){const e=null!=(n=i[Pe])?n:t;return[1,r,[e,null!=(l=i[Oe])?l:N,null!=(o=i[Ce])?o:Ne],te(e)]}const{tables:{load:u={},save:a={}}={},values:s={}}=i,v=c(H(X(xe,s)),0,W(xe)),y=v[2],E=te(y),f=te(y);return[0,r,[De(u,{[$e]:null,[Le]:N},$e,(e=>S(f,e)),(e=>le(E,e))),De(a,{[Ie]:null,[Le]:N,[Se]:0,[we]:0},Ie,((e,n)=>S(f,n)),((e,n)=>le(E,n))),v],E]})(n),m=e=>Ue(void 0,null,(function*(){yield h(`CREATE OR REPLACE TRIGGER ${$(Ge+"_"+e)} AFTER INSERT OR UPDATE OR DELETE ON ${$(e)} EXECUTE FUNCTION ${Ge}()`)}));return(T?Te:Ae)(e,h,(e=>Ue(void 0,null,(function*(){yield h(`CREATE OR REPLACE FUNCTION ${je}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${Fe}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{yield h(`CREATE EVENT TRIGGER ${je} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${je}();`)}catch(e){}return yield h(`CREATE OR REPLACE FUNCTION ${Ge}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${Fe}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),yield v(p(_(A),(e=>Ue(void 0,null,(function*(){yield h(`CREATE TABLE IF NOT EXISTS ${$(e)}("_id"text PRIMARY KEY)`),yield m(e)}))))),yield o(Fe,(n=>Ue(void 0,null,(function*(){return yield u((t=n,l=Me,null==t?void 0:t.match(l)),(n=>Ue(void 0,[n],(function*([,n,t]){S(A,t)&&("c:"==n&&(yield m(t)),e())}))));var t,l}))))}))),i,a,s,y,R,_(A),((e,n)=>Ue(void 0,null,(function*(){return yield e(`${g} table_name tn,column_name cn FROM information_schema.columns ${P} table_schema='public'AND table_name IN(${I(n)})`,n)}))),E,f,"text",void 0,(e=>z(e)),(e=>J(e)))})(e,l,((e,...t)=>Be(void 0,[e,...t],(function*(e,t=[]){return(yield n.query(e,t)).rows}))),((e,t)=>Be(void 0,null,(function*(){return yield n.listen(e,t)}))),(e=>Be(void 0,null,(function*(){try{yield e()}catch(e){null==i||i(e)}}))),o,i,(()=>0),3,n,"getPglite")}))},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterPglite={});
