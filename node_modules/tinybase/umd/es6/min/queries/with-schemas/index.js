var e,n;e=this,n=function(e){"use strict";const n=e=>typeof e,t=n(""),r=n(!0),l=n(0),o=n(n),s="Listener",i="Result",a="Ids",d="Table",u="Row",c=u+"Count",v=u+a,f="Sorted"+u+a,h="Cell",y=h+a,g=Math,p=g.max,w=g.min,L=isFinite,b=e=>null==e,R=(e,n,t)=>b(e)?void 0:n(e),T=e=>n(e)==o,m=e=>Array.isArray(e),C=e=>e.length,O=()=>{},Q=(e,n)=>e.every(n),S=(e,n)=>e.forEach(n),x=e=>j(e,((e,n)=>e+n),0),I=e=>0==C(e),j=(e,n,t)=>e.reduce(n,t),E=(e,...n)=>e.push(...n),D=Object,M=D.entries,k=D.freeze,z=e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0},A=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},F=e=>b(e)||0==z(e),P=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},B=e=>e.clear(),W=(e,n)=>null==e?void 0:e.forEach(n),q=(e,n)=>null==e?void 0:e.delete(n),G=e=>new Map(e),H=(e,n)=>null==e?void 0:e.get(n),J=(e,n)=>W(e,((e,t)=>n(t,e))),K=(e,n,t)=>b(t)?(q(e,n),e):null==e?void 0:e.set(n,t),N=(e,n,t,r)=>(A(e,n)?null==r||r(H(e,n)):K(e,n,t()),H(e,n)),U=(e,n,t,r,l=0)=>R((t?N:H)(e,n[l],l>C(n)-2?t:G),(o=>{if(l>C(n)-2)return(null==r?void 0:r(o))&&K(e,n[l]),o;const s=U(o,n,t,r,l+1);return F(o)&&K(e,n[l]),s})),V=e=>new Set(m(e)||b(e)?e:[e]),X=(e,n)=>null==e?void 0:e.add(n),Y=G([["avg",[(e,n)=>x(e)/n,(e,n,t)=>e+(n-e)/(t+1),(e,n,t)=>e+(e-n)/(t-1),(e,n,t,r)=>e+(n-t)/r]],["max",[e=>p(...e),(e,n)=>p(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:p(n,e)]],["min",[e=>w(...e),(e,n)=>w(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:w(n,e)]],["sum",[e=>x(e),(e,n)=>e+n,(e,n)=>e-n,(e,n,t)=>e-t+n]]]);var Z=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;const ee=(()=>{const e=new WeakMap;return o=>(e.has(o)||e.set(o,(e=>{const o=e.createStore,a=o(),g=o(),p=G(),{addListener:w,callListeners:x,delListener:j}=g,[D,ee,ne,te,re,,,le,,oe,se,ie,ae,de]=((e,n,t,r,l)=>{const o=e.hasRow,s=G(),i=G(),a=G(),d=G(),u=G(),c=G(),v=(n,t,...r)=>{const l=N(c,n,V);return S(r,(n=>X(l,n)&&t&&e.callListener(n))),r},f=(n,...t)=>R(H(c,n),(r=>{S(I(t)?P(r):t,(n=>{e.delListener(n),q(r,n)})),F(r)&&K(c,n)})),h=(e,n)=>{K(s,e,n),A(i,e)||(K(i,e,!0),K(d,e,G()),K(u,e,G()),l(a))},y=e=>{K(s,e),K(i,e),K(d,e),K(u,e),f(e),l(a)};return[()=>e,()=>{return[...null!=(n=null==(e=s)?void 0:e.keys())?n:[]];var e,n},e=>J(i,e),e=>A(i,e),e=>H(s,e),e=>H(i,e),(e,n)=>K(i,e,n),h,(n,r,l,s,i)=>{h(n,r);const a=G(),c=G(),y=H(d,n),g=H(u,n),p=n=>{const l=t=>e.getCell(r,n,t),d=H(y,n),u=o(r,n)?t(s(l,n)):void 0;var v,f;if(d===u||m(d)&&m(u)&&(f=u,C(v=d)===C(f)&&Q(v,((e,n)=>f[n]===e)))||K(a,n,[d,u]),!b(i)){const e=H(g,n),t=o(r,n)?i(l,n):void 0;e!=t&&K(c,n,t)}},w=e=>{l((()=>{W(a,(([,e],n)=>K(y,n,e))),W(c,((e,n)=>K(g,n,e)))}),a,c,y,g,e),B(a),B(c)};J(y,p),e.hasTable(r)&&S(e.getRowIds(r),(e=>{A(y,e)||p(e)})),w(!0),f(n),v(n,0,e.addRowListener(r,null,((e,n,t)=>p(t))),e.addTableListener(r,(()=>w())))},y,e=>r(e,a),()=>J(c,y),v,f]})(e,0,O,w,x),ue=(e,n,...t)=>S(t,(t=>X(N(N(p,n,G),e,V),t))),ce=e=>{R(H(p,e),(e=>{J(e,((e,n)=>W(n,(n=>e.delListener(n))))),B(e)})),S([g,a],(n=>n.delTable(e)))},ve=(e,n,t)=>ue(n,e,n.addStartTransactionListener(t.startTransaction),n.addDidFinishTransactionListener((()=>t.finishTransaction()))),fe={setQueryDefinition:(o,s,i)=>{le(o,s),ce(o);const d=[],u=[[null,[s,null,null,[],G()]]],c=[],v=[],f=[];i({select:(e,n)=>{const t=T(e)?[C(d)+"",e]:[b(n)?e:n,t=>t(e,n)];return E(d,t),{as:e=>t[0]=e}},join:(e,n,t)=>{const r=b(t)||T(n)?null:n,l=b(r)?n:t,o=[e,[e,r,T(l)?l:e=>e(l),[],G()]];return E(u,o),{as:e=>o[0]=e}},where:(e,n,t)=>E(c,T(e)?e:b(t)?t=>t(e)===n:r=>r(e,n)===t),group:(e,n,t,r,l)=>{var o;const s=[e,[e,T(n)?[n,t,r,l]:null!=(o=H(Y,n))?o:[(e,n)=>n]]];return E(v,s),{as:e=>s[0]=e}},having:(e,n)=>E(f,T(e)?e:t=>t(e)===n)});const h=G(d);if(F(h))return fe;const y=G(u);J(y,((e,[,n])=>R(H(y,n),(({3:n})=>b(e)?0:E(n,e)))));const p=G(v);let w=a;if(F(p)&&I(f))w=g;else{ve(o,w,g);const e=G();J(p,((n,[t,r])=>X(N(e,t,V),[n,r])));const s=V();J(h,(n=>A(e,n)?0:X(s,n)));const i=G(),a=(s,i,a,d)=>R(s,(([u,c,v,h])=>{J(i,((o,[s])=>{const i=N(u,o,G),c=H(i,a),v=d?void 0:s;if(c!==v){const s=V([[c,v]]),d=z(i);K(i,a,v),W(H(e,o),(([e,o])=>{const a=((e,n,t,r,l,o=!1)=>{if(F(t))return;const[s,i,a,d]=l;return o||(o=b(e)),W(r,(([t,r])=>{o||(e=b(t)?null==i?void 0:i(e,r,n++):b(r)?null==a?void 0:a(e,t,n--):null==d?void 0:d(e,r,t,n),o||(o=b(e)))})),o?s(P(t),z(t)):e})(h[e],d,i,s,o);h[e]=b((e=>{const o=n(e);return(e=>e==t||e==r)(o)||o==l&&L(e)?o:void 0})(a))?null:a}))}})),F(c)||!Q(f,(e=>e((e=>h[e]))))?g.delRow(o,v):b(v)?s[2]=g.addRow(o,h):g.setRow(o,v,h)}));ue(w,o,w.addRowListener(o,null,((n,t,r,l)=>{const d=[],u=[],c=G(),v=w.hasRow(o,r);let f=!v;W(s,(e=>{const[n,t,s]=l(o,r,e);E(d,t),E(u,s),f||(f=n)})),J(e,(e=>{const[n,,t]=l(o,r,e);(f||n)&&K(c,e,[t])})),f&&a(U(i,d,void 0,(([,e])=>(q(e,r),F(e)))),c,r,1),v&&a(U(i,u,(()=>{const e={};return W(s,(n=>e[n]=w.getCell(o,r,n))),[G(),V(),void 0,e]}),(([,e])=>{X(e,r)})),c,r)})))}ve(o,e,w);const m=(n,t,r,l)=>{const i=n=>e.getCell(t,r,n);S(l,(t=>{var r;const[l,,s,a,d]=H(y,t),u=null==s?void 0:s(i,n),[c,v]=null!=(r=H(d,n))?r:[];u!=c&&(b(v)||de(o,v),K(d,n,b(u)?null:[u,...ae(o,1,e.addRowListener(l,u,(()=>m(n,l,u,a))))]))})),(n=>{const t=(t,r)=>{var l,o,i;return e.getCell(...b(r)?[s,n,t]:t===s?[s,n,r]:[null==(l=H(y,t))?void 0:l[0],null==(i=H(null==(o=H(y,t))?void 0:o[4],n))?void 0:i[0],r])};w.transaction((()=>Q(c,(e=>e(t)))?J(h,((e,r)=>((e,n,t,r,l)=>b(l)?e.delCell(n,t,r,!0):e.setCell(n,t,r,l))(w,o,n,e,r(t,n)))):w.delRow(o,n)))})(n)},{3:O}=H(y,null);return w.transaction((()=>ae(o,1,e.addRowListener(s,null,((n,t,r)=>{e.hasRow(s,r)?m(r,s,r,O):(w.delRow(o,r),W(y,(({4:e})=>R(H(e,r),(([,n])=>{de(o,n),K(e,r)})))))}))))),fe},delQueryDefinition:e=>(ce(e),oe(e),fe),getStore:D,getQueryIds:ee,forEachQuery:ne,hasQuery:te,getTableId:re,addQueryIdsListener:e=>se((()=>e(fe))),delListener:e=>(j(e),fe),destroy:ie,getListenerStats:()=>((e,n)=>{var t={};for(var r in e)$.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&Z)for(var r of Z(e))n.indexOf(r)<0&&_.call(e,r)&&(t[r]=e[r]);return t})(g.getListenerStats(),["tables","tableIds","transaction"])};var he;return he=([e,n],t)=>{S(e?["get","has","forEach"]:["get"],(e=>fe[e+i+t]=(...n)=>g[e+t](...n))),fe["add"+i+t+s]=(...e)=>{return g["add"+t+s](...(r=e,l=n,r.slice(0,l)),((t,...r)=>e[n](fe,...r)),!0);var r,l}},((e,n)=>{e.map(n)})(M({[d]:[1,1],[d+y]:[0,1],[c]:[0,1],[v]:[0,1],[f]:[0,5],[u]:[1,2],[y]:[0,2],[h]:[1,3]}),(([e,n])=>he(n,e))),k(fe)})(o)),e.get(o))})();e.createQueries=ee},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
