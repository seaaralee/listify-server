var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",l=t(n),r=t(t),i=Math,o=i.max,s=i.min,u=isFinite,d=e=>null==e,a=(e,t,n)=>d(e)?void 0:t(e),c=e=>Array.isArray(e),v=e=>e.length,f=()=>{},h=(e,t)=>e.forEach(t),g=e=>M(e,((e,t)=>e+t),0),M=(e,t,n)=>e.reduce(t,n),p=(e,...t)=>e.push(...t),y=Object.freeze,m=e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0},L=(b=m,e=>M(x(e),((e,t)=>e+b(t)),0));var b;const w=(e,t)=>{var n;return null!=(n=null==e?void 0:e.has(t))&&n},T=e=>d(e)||0==m(e),x=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},I=e=>e.clear(),E=(e,t)=>null==e?void 0:e.forEach(t),R=(e,t)=>null==e?void 0:e.delete(t),S=e=>new Map(e),j=(e,t)=>null==e?void 0:e.get(t),k=(e,t)=>E(e,((e,n)=>t(n,e))),z=(e,t,n)=>d(n)?(R(e,t),e):null==e?void 0:e.set(t,n),A=(e,t,n,l)=>(w(e,t)?null==l||l(j(e,t)):z(e,t,n()),j(e,t)),D=(e,t,n,l,r=0)=>a((n?A:j)(e,t[r],r>v(t)-2?n:S),(i=>{if(r>v(t)-2)return(null==l?void 0:l(i))&&z(e,t[r]),i;const o=D(i,t,n,l,r+1);return T(i)&&z(e,t[r]),o})),N=S([["avg",[(e,t)=>g(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,l)=>e+(t-n)/l]],["max",[e=>o(...e),(e,t)=>o(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:o(t,e)]],["min",[e=>s(...e),(e,t)=>s(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:s(t,e)]],["sum",[e=>g(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),B=e=>new Set(c(e)||d(e)?e:[e]),C=(e,t)=>null==e?void 0:e.add(t),F=/^\d+$/,O=(()=>{const e=new WeakMap;return i=>(e.has(i)||e.set(i,(e=>{const i=S(),[o,s,g]=(()=>{let e;const[t,l]=(()=>{const e=[];let t=0;return[l=>{var r;return null!=(r=l?e.shift():null)?r:n+t++},t=>{F.test(t)&&v(e)<1e3&&p(e,t)}]})(),r=S();return[(l,i,o,s=[],u=()=>[])=>{null!=e||(e=Q);const d=t(1);return z(r,d,[l,i,o,s,u]),C(D(i,null!=o?o:[n],B),d),d},(t,l,...i)=>h(((e,t=[n])=>{const l=[],r=(e,n)=>n==v(t)?p(l,e):null===t[n]?E(e,(e=>r(e,n+1))):h([t[n],null],(t=>r(j(e,t),n+1)));return r(e,0),l})(t,l),(t=>E(t,(t=>j(r,t)[0](e,...null!=l?l:[],...i))))),e=>a(j(r,e),(([,t,i])=>(D(t,null!=i?i:[n],void 0,(t=>(R(t,e),T(t)?1:0))),z(r,e),l(e),i))),t=>a(j(r,t),(([t,,n=[],l,r])=>{const i=(...o)=>{var s,u;const a=v(o);a==v(n)?t(e,...o,...r(o)):d(n[a])?h(null!=(u=null==(s=l[a])?void 0:s.call(l,...o))?u:[],(e=>i(...o,e))):i(...o,n[a])};i()}))]})(),[M,b,O,W,$,q,G,,H,J,K,P]=((e,t,l,r,i)=>{const o=e.hasRow,s=S(),u=S(),f=S(),g=S(),M=S(),p=S(),y=(t,n,...l)=>{const r=A(p,t,B);return h(l,(t=>C(r,t)&&n&&e.callListener(t))),l},m=(t,...n)=>a(j(p,t),(l=>{h(0==v(n)?x(l):n,(t=>{e.delListener(t),R(l,t)})),T(l)&&z(p,t)})),L=(e,n)=>{z(s,e,n),w(u,e)||(z(u,e,t()),z(g,e,S()),z(M,e,S()),i(f))},b=e=>{z(s,e),z(u,e),z(g,e),z(M,e),m(e),i(f)};return[()=>e,()=>{return[...null!=(t=null==(e=s)?void 0:e.keys())?t:[]];var e,t},e=>k(u,e),e=>w(u,e),e=>j(s,e),e=>j(u,e),(e,t)=>z(u,e,t),L,(t,l,r,i,s)=>{L(t,l);const u=S(),a=S(),f=j(g,t),p=j(M,t),b=t=>{const r=n=>e.getCell(l,t,n),h=j(f,t),g=o(l,t)?(M=i(r,t),isNaN(M)||d(M)||!0===M||!1===M||M===n?void 0:1*M):void 0;var M,y,m,L;if(h===g||c(h)&&c(g)&&(m=g,v(y=h)===v(m)&&(L=(e,t)=>m[t]===e,y.every(L)))||z(u,t,[h,g]),!d(s)){const e=j(p,t),n=o(l,t)?s(r,t):void 0;e!=n&&z(a,t,n)}},T=e=>{r((()=>{E(u,(([,e],t)=>z(f,t,e))),E(a,((e,t)=>z(p,t,e)))}),u,a,f,p,e),I(u),I(a)};k(f,b),e.hasTable(l)&&h(e.getRowIds(l),(e=>{w(f,e)||b(e)})),T(!0),m(t),y(t,0,e.addRowListener(l,null,((e,t,n)=>b(n))),e.addTableListener(l,(()=>T())))},b,e=>r(e,f),()=>k(p,b),y,m]})(e,f,0,o,s),Q={setMetricDefinition:(e,n,o,a,c,v,f)=>{var h;const g=t(o)==r?[o,c,v,f]:null!=(h=j(N,o))?h:j(N,"sum");return H(e,n,((t,n,l,r,o,a)=>{const c=q(e),v=m(r);a||(a=d(c)),t();let f=((e,t,n,l,r,i=!1)=>{if(T(n))return;const[o,s,u,a]=r;return i||(i=d(e)),E(l,(([n,l])=>{i||(e=d(n)?null==s?void 0:s(e,l,t++):d(l)?null==u?void 0:u(e,n,t--):null==a?void 0:a(e,l,n,t),i||(i=d(e)))})),i?o(x(n),m(n)):e})(c,v,r,n,g,a);u(f)||(f=void 0),f!=c&&(G(e,f),s(i,[e],f,c))}),t(M=a)==l?e=>e(M):null!=M?M:()=>1),Q;var M},delMetricDefinition:e=>(J(e),Q),getStore:M,getMetricIds:b,forEachMetric:O,hasMetric:W,getTableId:$,getMetric:q,addMetricIdsListener:K,addMetricListener:(e,t)=>o(t,i,[e]),delListener:e=>(g(e),Q),destroy:P,getListenerStats:()=>({metric:L(i)})};return y(Q)})(i)),e.get(i))})();e.createMetrics=O},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
