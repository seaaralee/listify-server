var e,n;e=this,n=function(e){"use strict";const n=e=>null==e,t=(e,t,l)=>n(e)?void 0:t(e),l=e=>e.length,r=(e,n)=>e.includes(n),o=(e,n)=>e.forEach(n),s=e=>0==l(e),i=(e,...n)=>e.push(...n),u=e=>e.pop(),d=e=>e.shift(),c=Object.freeze,a=e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0},v=(h=a,e=>{return n=(e,n)=>e+h(n),g(e).reduce(n,0);var n});var h;const p=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},f=e=>n(e)||0==a(e),g=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},k=(e,n)=>null==e?void 0:e.forEach(n),C=(e,n)=>null==e?void 0:e.delete(n),L=e=>new Map(e),y=(e,n)=>null==e?void 0:e.get(n),w=(e,t,l)=>n(l)?(C(e,t),e):null==e?void 0:e.set(t,l),b=(e,n,t,l)=>(p(e,n)?null==l||l(y(e,n)):w(e,n,t()),y(e,n)),S=(e,n,r,o,s=0)=>t((r?b:y)(e,n[s],s>l(n)-2?r:L),(t=>{if(s>l(n)-2)return(null==o?void 0:o(t))&&w(e,n[s]),t;const i=S(t,n,r,o,s+1);return f(t)&&w(e,n[s]),i})),T=e=>new Set(Array.isArray(e)||n(e)?e:[e]),x=/^\d+$/,z=((e,a)=>{const h=new WeakMap;return e=>{h.has(e)||h.set(e,(e=>{let a,h,g,z=100,E=L(),I=L(),V=1;const j=L(),m=L(),[A,B,F]=(()=>{let e;const[r,s]=(()=>{const e=[];let n=0;return[t=>{var l;return null!=(l=t?d(e):null)?l:""+n++},n=>{x.test(n)&&l(e)<1e3&&i(e,n)}]})(),u=L();return[(n,t,l,o=[],s=()=>[])=>{null!=e||(e=ee);const i=r(1);var d,c;return w(u,i,[n,t,l,o,s]),c=i,null==(d=S(t,null!=l?l:[""],T))||d.add(c),i},(n,t,...r)=>o(((e,n=[""])=>{const t=[],r=(e,s)=>s==l(n)?i(t,e):null===n[s]?k(e,(e=>r(e,s+1))):o([n[s],null],(n=>r(y(e,n),s+1)));return r(e,0),t})(n,t),(n=>k(n,(n=>y(u,n)[0](e,...null!=t?t:[],...r))))),e=>t(y(u,e),(([,n,t])=>(S(n,null!=t?t:[""],void 0,(n=>(C(n,e),f(n)?1:0))),w(u,e),s(e),t))),r=>t(y(u,r),(([t,,r=[],s,i])=>{const u=(...d)=>{var c,a;const v=l(d);v==l(r)?t(e,...d,...i(d)):n(r[v])?o(null!=(a=null==(c=s[v])?void 0:c.call(s,...d))?a:[],(e=>u(...d,e))):u(...d,r[v])};u()}))]})(),M=L(),_=L(),O=[],W=[],$=(t,l)=>{V=0,e.transaction((()=>{const[r,o]=y(M,l);k(r,((l,r)=>k(l,((l,o)=>k(l,((l,s)=>((e,t,l,r,o)=>n(o)?e.delCell(t,l,r,!0):e.setCell(t,l,r,o))(e,r,o,s,l[t]))))))),k(o,((l,r)=>((e,t,l)=>n(l)?e.delValue(t):e.setValue(t,l))(e,r,l[t])))})),V=1},q=e=>{w(M,e),w(_,e),B(m,[e])},D=(e,n)=>o(((e,n)=>e.splice(0,n))(e,null!=n?n:l(e)),q),G=()=>D(O,l(O)-z),H=()=>t(a,(()=>{i(O,a),G(),D(W),a=void 0,g=1})),J=()=>{a=u(O),g=1};let K,N;const P=(e="")=>(n(a)&&(a=""+h++,w(M,a,[E,I]),Y(a,e),E=L(),I=L(),g=1),a),Q=()=>{s(O)||(((e,...n)=>{e.unshift(...n)})(W,P()),$(0,a),a=u(O),g=1)},R=()=>{s(W)||(i(O,a),a=d(W),$(1,a),g=1)},U=()=>{g&&(B(j),g=0)},X=e=>{const n=P(e);return U(),n},Y=(e,n)=>(Z(e)&&y(_,e)!==n&&(w(_,e,n),B(m,[e])),ee),Z=e=>p(M,e),ee={setSize:e=>(z=e,G(),ee),addCheckpoint:X,setCheckpoint:Y,getStore:()=>e,getCheckpointIds:()=>[[...O],a,[...W]],forEachCheckpoint:e=>{return n=e,k(_,((e,t)=>n(t,e)));var n},hasCheckpoint:Z,getCheckpoint:e=>y(_,e),goBackward:()=>(Q(),U(),ee),goForward:()=>(R(),U(),ee),goTo:e=>{const t=r(O,e)?Q:r(W,e)?R:null;for(;!n(t)&&e!=a;)t();return U(),ee},addCheckpointIdsListener:e=>A(e,j),addCheckpointListener:(e,n)=>A(n,m,[e]),delListener:e=>(F(e),ee),clear:()=>(D(O),D(W),n(a)||q(a),a=void 0,h=0,X(),ee),clearForward:()=>(s(W)||(D(W),B(j)),ee),destroy:()=>{e.delListener(K),e.delListener(N)},getListenerStats:()=>({checkpointIds:v(j),checkpoint:v(m)}),_registerListeners:()=>{K=e.addCellListener(null,null,null,((e,n,t,l,r,o)=>{if(V){H();const e=b(E,n,L),s=b(e,t,L),i=b(s,l,(()=>[o,void 0]));i[1]=r,i[0]===r&&f(w(s,l))&&f(w(e,t))&&f(w(E,n))&&J(),U()}})),N=e.addValueListener(null,((e,n,t,l)=>{if(V){H();const e=b(I,n,(()=>[l,void 0]));e[1]=t,e[0]===t&&f(w(I,n))&&J(),U()}}))}};return c(ee.clear())})(e));const g=h.get(e);return null==a||a(g),g}})(0,(e=>e._registerListeners()));e.createCheckpoints=z},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseCheckpoints={});
