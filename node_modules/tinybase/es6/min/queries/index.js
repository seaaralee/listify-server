const e=e=>typeof e,n=e(""),t=e(!0),l=e(0),r=e(e),o="Listener",s="Result",a="Ids",i="Table",d="Row",u=d+"Count",c=d+a,v="Sorted"+d+a,f="Cell",h=f+a,w=Math,g=w.max,y=w.min,L=isFinite,p=e=>null==e,R=(e,n,t)=>p(e)?void 0:n(e),b=n=>e(n)==r,T=e=>Array.isArray(e),m=e=>e.length,C=()=>{},O=(e,n)=>e.every(n),S=(e,n)=>e.forEach(n),I=e=>j(e,((e,n)=>e+n),0),Q=e=>0==m(e),j=(e,n,t)=>e.reduce(n,t),x=(e,...n)=>e.push(...n),E=Object,D=E.entries,M=E.freeze,k=e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0},z=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},A=e=>p(e)||0==k(e),F=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},P=e=>e.clear(),W=(e,n)=>null==e?void 0:e.forEach(n),q=(e,n)=>null==e?void 0:e.delete(n),B=e=>new Map(e),G=(e,n)=>null==e?void 0:e.get(n),H=(e,n)=>W(e,((e,t)=>n(t,e))),J=(e,n,t)=>p(t)?(q(e,n),e):null==e?void 0:e.set(n,t),K=(e,n,t,l)=>(z(e,n)?null==l||l(G(e,n)):J(e,n,t()),G(e,n)),N=(e,n,t,l,r=0)=>R((t?K:G)(e,n[r],r>m(n)-2?t:B),(o=>{if(r>m(n)-2)return(null==l?void 0:l(o))&&J(e,n[r]),o;const s=N(o,n,t,l,r+1);return A(o)&&J(e,n[r]),s})),U=e=>new Set(T(e)||p(e)?e:[e]),V=(e,n)=>null==e?void 0:e.add(n),X=B([["avg",[(e,n)=>I(e)/n,(e,n,t)=>e+(n-e)/(t+1),(e,n,t)=>e+(e-n)/(t-1),(e,n,t,l)=>e+(n-t)/l]],["max",[e=>g(...e),(e,n)=>g(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:g(n,e)]],["min",[e=>y(...e),(e,n)=>y(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:y(n,e)]],["sum",[e=>I(e),(e,n)=>e+n,(e,n)=>e-n,(e,n,t)=>e-t+n]]]);var Y=Object.getOwnPropertySymbols,Z=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;const _=(()=>{const r=new WeakMap;return a=>(r.has(a)||r.set(a,(r=>{const a=r.createStore,w=a(),g=a(),y=B(),{addListener:I,callListeners:j,delListener:E}=g,[_,ee,ne,te,le,,,re,,oe,se,ae,ie,de]=((e,n,t,l,r)=>{const o=e.hasRow,s=B(),a=B(),i=B(),d=B(),u=B(),c=B(),v=(n,t,...l)=>{const r=K(c,n,U);return S(l,(n=>V(r,n)&&t&&e.callListener(n))),l},f=(n,...t)=>R(G(c,n),(l=>{S(Q(t)?F(l):t,(n=>{e.delListener(n),q(l,n)})),A(l)&&J(c,n)})),h=(e,n)=>{J(s,e,n),z(a,e)||(J(a,e,!0),J(d,e,B()),J(u,e,B()),r(i))},w=e=>{J(s,e),J(a,e),J(d,e),J(u,e),f(e),r(i)};return[()=>e,()=>{return[...null!=(n=null==(e=s)?void 0:e.keys())?n:[]];var e,n},e=>H(a,e),e=>z(a,e),e=>G(s,e),e=>G(a,e),(e,n)=>J(a,e,n),h,(n,l,r,s,a)=>{h(n,l);const i=B(),c=B(),w=G(d,n),g=G(u,n),y=n=>{const r=t=>e.getCell(l,n,t),d=G(w,n),u=o(l,n)?t(s(r,n)):void 0;var v,f;if(d===u||T(d)&&T(u)&&(f=u,m(v=d)===m(f)&&O(v,((e,n)=>f[n]===e)))||J(i,n,[d,u]),!p(a)){const e=G(g,n),t=o(l,n)?a(r,n):void 0;e!=t&&J(c,n,t)}},L=e=>{r((()=>{W(i,(([,e],n)=>J(w,n,e))),W(c,((e,n)=>J(g,n,e)))}),i,c,w,g,e),P(i),P(c)};H(w,y),e.hasTable(l)&&S(e.getRowIds(l),(e=>{z(w,e)||y(e)})),L(!0),f(n),v(n,0,e.addRowListener(l,null,((e,n,t)=>y(t))),e.addTableListener(l,(()=>L())))},w,e=>l(e,i),()=>H(c,w),v,f]})(r,0,C,I,j),ue=(e,n,...t)=>S(t,(t=>V(K(K(y,n,B),e,U),t))),ce=e=>{R(G(y,e),(e=>{H(e,((e,n)=>W(n,(n=>e.delListener(n))))),P(e)})),S([g,w],(n=>n.delTable(e)))},ve=(e,n,t)=>ue(n,e,n.addStartTransactionListener(t.startTransaction),n.addDidFinishTransactionListener((()=>t.finishTransaction()))),fe={setQueryDefinition:(o,s,a)=>{re(o,s),ce(o);const i=[],d=[[null,[s,null,null,[],B()]]],u=[],c=[],v=[];a({select:(e,n)=>{const t=b(e)?[m(i)+"",e]:[p(n)?e:n,t=>t(e,n)];return x(i,t),{as:e=>t[0]=e}},join:(e,n,t)=>{const l=p(t)||b(n)?null:n,r=p(l)?n:t,o=[e,[e,l,b(r)?r:e=>e(r),[],B()]];return x(d,o),{as:e=>o[0]=e}},where:(e,n,t)=>x(u,b(e)?e:p(t)?t=>t(e)===n:l=>l(e,n)===t),group:(e,n,t,l,r)=>{var o;const s=[e,[e,b(n)?[n,t,l,r]:null!=(o=G(X,n))?o:[(e,n)=>n]]];return x(c,s),{as:e=>s[0]=e}},having:(e,n)=>x(v,b(e)?e:t=>t(e)===n)});const f=B(i);if(A(f))return fe;const h=B(d);H(h,((e,[,n])=>R(G(h,n),(({3:n})=>p(e)?0:x(n,e)))));const y=B(c);let T=w;if(A(y)&&Q(v))T=g;else{ve(o,T,g);const r=B();H(y,((e,[n,t])=>V(K(r,n,U),[e,t])));const s=U();H(f,(e=>z(r,e)?0:V(s,e)));const a=B(),i=(s,a,i,d)=>R(s,(([u,c,f,h])=>{H(a,((o,[s])=>{const a=K(u,o,B),c=G(a,i),v=d?void 0:s;if(c!==v){const s=U([[c,v]]),d=k(a);J(a,i,v),W(G(r,o),(([r,o])=>{const i=((e,n,t,l,r,o=!1)=>{if(A(t))return;const[s,a,i,d]=r;return o||(o=p(e)),W(l,(([t,l])=>{o||(e=p(t)?null==a?void 0:a(e,l,n++):p(l)?null==i?void 0:i(e,t,n--):null==d?void 0:d(e,l,t,n),o||(o=p(e)))})),o?s(F(t),k(t)):e})(h[r],d,a,s,o);h[r]=p((r=>{const o=e(r);return(e=>e==n||e==t)(o)||o==l&&L(r)?o:void 0})(i))?null:i}))}})),A(c)||!O(v,(e=>e((e=>h[e]))))?g.delRow(o,f):p(f)?s[2]=g.addRow(o,h):g.setRow(o,f,h)}));ue(T,o,T.addRowListener(o,null,((e,n,t,l)=>{const d=[],u=[],c=B(),v=T.hasRow(o,t);let f=!v;W(s,(e=>{const[n,r,s]=l(o,t,e);x(d,r),x(u,s),f||(f=n)})),H(r,(e=>{const[n,,r]=l(o,t,e);(f||n)&&J(c,e,[r])})),f&&i(N(a,d,void 0,(([,e])=>(q(e,t),A(e)))),c,t,1),v&&i(N(a,u,(()=>{const e={};return W(s,(n=>e[n]=T.getCell(o,t,n))),[B(),U(),void 0,e]}),(([,e])=>{V(e,t)})),c,t)})))}ve(o,r,T);const C=(e,n,t,l)=>{const a=e=>r.getCell(n,t,e);S(l,(n=>{var t;const[l,,s,i,d]=G(h,n),u=null==s?void 0:s(a,e),[c,v]=null!=(t=G(d,e))?t:[];u!=c&&(p(v)||de(o,v),J(d,e,p(u)?null:[u,...ie(o,1,r.addRowListener(l,u,(()=>C(e,l,u,i))))]))})),(e=>{const n=(n,t)=>{var l,o,a;return r.getCell(...p(t)?[s,e,n]:n===s?[s,e,t]:[null==(l=G(h,n))?void 0:l[0],null==(a=G(null==(o=G(h,n))?void 0:o[4],e))?void 0:a[0],t])};T.transaction((()=>O(u,(e=>e(n)))?H(f,((t,l)=>((e,n,t,l,r)=>p(r)?e.delCell(n,t,l,!0):e.setCell(n,t,l,r))(T,o,e,t,l(n,e)))):T.delRow(o,e)))})(e)},{3:I}=G(h,null);return T.transaction((()=>ie(o,1,r.addRowListener(s,null,((e,n,t)=>{r.hasRow(s,t)?C(t,s,t,I):(T.delRow(o,t),W(h,(({4:e})=>R(G(e,t),(([,n])=>{de(o,n),J(e,t)})))))}))))),fe},delQueryDefinition:e=>(ce(e),oe(e),fe),getStore:_,getQueryIds:ee,forEachQuery:ne,hasQuery:te,getTableId:le,addQueryIdsListener:e=>se((()=>e(fe))),delListener:e=>(E(e),fe),destroy:ae,getListenerStats:()=>((e,n)=>{var t={};for(var l in e)Z.call(e,l)&&n.indexOf(l)<0&&(t[l]=e[l]);if(null!=e&&Y)for(var l of Y(e))n.indexOf(l)<0&&$.call(e,l)&&(t[l]=e[l]);return t})(g.getListenerStats(),["tables","tableIds","transaction"])};var he;return he=([e,n],t)=>{S(e?["get","has","forEach"]:["get"],(e=>fe[e+s+t]=(...n)=>g[e+t](...n))),fe["add"+s+t+o]=(...e)=>{return g["add"+t+o](...(l=e,r=n,l.slice(0,r)),((t,...l)=>e[n](fe,...l)),!0);var l,r}},((e,n)=>{D({[i]:[1,1],[i+h]:[0,1],[u]:[0,1],[c]:[0,1],[v]:[0,5],[d]:[1,2],[h]:[0,2],[f]:[1,3]}).map(n)})(0,(([e,n])=>he(n,e))),M(fe)})(a)),r.get(a))})();export{_ as createQueries};
