const e=e=>typeof e,n="tinybase",l=",",t=e(""),o=Promise,r=e=>null==e,i=(e,n,l)=>r(e)?null==l?void 0:l():n(e),u=n=>e(n)==t,d=e=>Array.isArray(e),a=(e,n,l)=>e.slice(n,l),c=e=>e.length,s=e=>{return n=function*(){return o.all(e)},new Promise(((e,l)=>{var t=e=>{try{r(n.next(e))}catch(e){l(e)}},o=e=>{try{r(n.throw(e))}catch(e){l(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,o);r((n=n.apply(void 0,null)).next())}));var n},v=e=>{throw Error(e)},y=(e,n)=>e.forEach(n),E=(e,n="")=>e.join(n),f=(e,n)=>e.map(n),p=e=>0==c(e),h=(e,n)=>e.filter(n),T=(e,...n)=>e.push(...n),R=e=>e.shift(),A="_",m="_id",N="SELECT",O="WHERE",g="TABLE",P="ALTER "+g,C="DELETE FROM",L=N+"*FROM",$=e=>`"${e.replace(/"/g,'""')}"`,b=(e,n=[1])=>E(f(e,(()=>"$"+n[0]++)),l),S=(e,n)=>{var l;return null!=(l=null==e?void 0:e.has(n))&&l},I=e=>r(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),_=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},w=(e,n)=>null==e?void 0:e.forEach(n),x=(e,n)=>null==e?void 0:e.delete(n),D=Object,U=e=>D.getPrototypeOf(e),F=D.entries,M=D.keys,G=D.freeze,j=(e=[])=>D.fromEntries(e),B=(...e)=>D.assign({},...e),X=(e,n)=>(delete e[n],e),Y=(e,n)=>f(F(e),(([e,l])=>n(l,e))),q=e=>D.values(e),H=e=>c(M(e)),W=e=>(e=>!r(e)&&i(U(e),(e=>e==D.prototype||r(U(e))),(()=>!0)))(e)&&0==H(e),k=JSON.stringify,z=JSON.parse,J=e=>new Map(e),K=(e,n)=>null==e?void 0:e.get(n),V=(e,n)=>{var l;return f([...null!=(l=null==e?void 0:e.entries())?l:[]],(([e,l])=>n(l,e)))},Q=(e,n,l)=>r(l)?(x(e,n),e):null==e?void 0:e.set(n,l),Z=(e,n,l,t)=>(S(e,n)?null==t||t(K(e,n)):Q(e,n,l()),K(e,n)),ee=(e,n,l,t,o=0)=>i((l?Z:K)(e,n[o],o>c(n)-2?l:J),(r=>{if(o>c(n)-2)return(null==t?void 0:t(r))&&Q(e,n[o]),r;const i=ee(r,n,l,t,o+1);return I(r)&&Q(e,n[o]),i})),ne=e=>new Set(d(e)||r(e)?e:[e]),le=(e,n)=>null==e?void 0:e.add(n),te=/^\d+$/;var oe=Object.defineProperty,re=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,de=(e,n,l)=>n in e?oe(e,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[n]=l,ae=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const ce=J(),se=J(),ve=(e,n,l,t,o,u,a,s={},E=0,f=[])=>{let p,h,A,m=0,N=0,O=0;Z(ce,f,(()=>0)),Z(se,f,(()=>[]));const g=J(),[P,C,L,$,b]=((e=1,n,l)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!l),([[e],[n]])=>!W(e)||!W(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!W(e)||!W(n),n.setContent]:v("Store type not supported by this Persister"))(a,e,E),[S,_,D]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var t;return null!=(t=l?R(e):null)?t:""+n++},n=>{te.test(n)&&c(e)<1e3&&T(e,n)}]})(),t=J();return[(l,o,r,i=[],u=()=>[])=>{null!=e||(e=q);const d=n(1);return Q(t,d,[l,o,r,i,u]),le(ee(o,null!=r?r:[""],ne),d),d},(n,l,...o)=>y(((e,n=[""])=>{const l=[],t=(e,o)=>o==c(n)?T(l,e):null===n[o]?w(e,(e=>t(e,o+1))):y([n[o],null],(n=>t(K(e,n),o+1)));return t(e,0),l})(n,l),(n=>w(n,(n=>K(t,n)[0](e,...null!=l?l:[],...o))))),e=>i(K(t,e),(([,n,o])=>(ee(n,null!=o?o:[""],void 0,(n=>(x(n,e),I(n)?1:0))),Q(t,e),l(e),o))),n=>i(K(t,n),(([n,,l=[],t,o])=>{const i=(...u)=>{var d,a;const s=c(u);s==c(l)?n(e,...u,...o(u)):r(l[s])?y(null!=(a=null==(d=t[s])?void 0:d.call(t,...u))?a:[],(e=>i(...u,e))):i(...u,l[s])};i()}))]})(),U=e=>{e!=m&&(m=e,_(g,void 0,m))},F=n=>{(P&&d(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},M=e=>ae(void 0,null,(function*(){return 2!=m&&(U(1),N++,yield Y((()=>ae(void 0,null,(function*(){try{const l=yield n();d(l)?F(l):e?b(e):v("Content is not an array: "+l)}catch(n){null==u||u(n),e&&b(e)}U(0)}))))),q})),j=()=>(h&&(o(h),h=void 0),q),B=e=>ae(void 0,null,(function*(){return 1!=m&&(U(2),O++,yield Y((()=>ae(void 0,null,(function*(){try{yield l(C,e)}catch(e){null==u||u(e)}U(0)}))))),q})),X=()=>(A&&(e.delListener(A),A=void 0),q),Y=(...e)=>ae(void 0,null,(function*(){return T(K(se,f),...e),yield ae(void 0,null,(function*(){if(!K(ce,f)){for(Q(ce,f,1);!r(p=R(K(se,f)));)try{yield p()}catch(e){null==u||u(e)}Q(ce,f,0)}})),q})),q=((e,n)=>{for(var l in n||(n={}))ie.call(n,l)&&de(e,l,n[l]);if(re)for(var l of re(n))ue.call(n,l)&&de(e,l,n[l]);return e})({load:M,startAutoLoad:e=>ae(void 0,null,(function*(){j(),yield M(e);try{h=yield t(((e,n)=>ae(void 0,null,(function*(){n||e?2!=m&&(U(1),N++,F(null!=n?n:e),U(0)):yield M()}))))}catch(e){null==u||u(e)}return q})),stopAutoLoad:j,isAutoLoading:()=>!r(h),save:B,startAutoSave:()=>ae(void 0,null,(function*(){return X(),yield B(),A=e.addDidFinishTransactionListener((()=>{const e=L();$(e)&&B(e)})),q})),stopAutoSave:X,isAutoSaving:()=>!r(A),getStatus:()=>m,addStatusListener:e=>S(e,g),delListener:n=>(D(n),e),schedule:Y,getStore:()=>e,destroy:()=>(K(se,f).splice(0,void 0),j().stopAutoSave()),getStats:()=>({loads:N,saves:O})},s);return G(q)};var ye=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ee=(e,n,t,o,i,u=fe,d,a)=>{const c=J();return[()=>ye(void 0,null,(function*(){c.clear(),f(yield t(e,n),(({tn:e,cn:n})=>le(Z(c,e,ne),n)))})),(n,l)=>ye(void 0,null,(function*(){return((e,n)=>S(K(c,e),n))(n,l)?j(h(f(yield e(L+$(n)),(e=>{return[e[l],a?(n=X(e,l),t=a,j(Y(n,((e,n)=>[n,t(e,n)])))):X(e,l)];var n,t})),(([e,n])=>!r(e)&&!W(n)))):{}})),(n,t,o,a,v,y=!1)=>ye(void 0,null,(function*(){const R=ne();Y(null!=o?o:{},(e=>f(M(null!=e?e:{}),(e=>le(R,e)))));const A=_(R);if(!y&&v&&p(A)&&S(c,n))return yield e("DROP "+g+$(n)),void Q(c,n);const m=K(c,n),N=ne(_(m));if(p(A)||(S(c,n)?yield s(f([t,...A],((l,o)=>ye(void 0,null,(function*(){x(N,l)||(yield e(P+$(n)+"ADD"+$(l)+i),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+$(n)+`(${$(t)})`)),le(m,l))}))))):(yield e("CREATE "+g+$(n)+`(${$(t)}${i} PRIMARY KEY${E(f(A,(e=>l+$(e)+i)))});`),Q(c,n,ne([t,...A])))),yield s([...!y&&a?f(_(N),(l=>ye(void 0,null,(function*(){l!=t&&(yield e(P+$(n)+"DROP"+$(l)),x(m,l))})))):[]]),y)r(o)?yield e(C+$(n)+O+" true"):yield s(Y(o,((l,o)=>ye(void 0,null,(function*(){r(l)?yield e(C+$(n)+O+$(t)+"=$1",[o]):p(A)||(yield u(e,n,t,M(l),{[o]:d?f(q(l),d):q(l)},m))})))));else if(p(A))S(c,n)&&(yield e(C+$(n)+O+" true"));else{const l=h(_(K(c,n)),(e=>e!=t)),r={},i=[];Y(null!=o?o:{},((e,n)=>{r[n]=f(l,(n=>d?d(null==e?void 0:e[n]):null==e?void 0:e[n])),T(i,n)})),yield u(e,n,t,l,r),yield e(C+$(n)+O+$(t)+`NOT IN(${b(i)})`,i)}})),n=>ye(void 0,null,(function*(){let l;yield e("BEGIN");try{l=yield n()}catch(e){null==o||o(e)}return yield e("END"),l}))]},fe=(e,n,t,o,r)=>ye(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+$(n)+"("+((...e)=>E(f(e,$),l))(t,...o)+")VALUES"+E(Y(r,(e=>"($"+i[0]+++","+b(e,i)+")")),l)+"ON CONFLICT("+$(t)+")DO UPDATE SET"+E(f(o,(e=>$(e)+"=excluded."+$(e))),l),Y(r,((e,n)=>[n,...f(e,(e=>null!=e?e:null))])).flat())}));var pe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const he=(e,n,l,t,o,r,i,[u,d,a],c,s,v,y,E,f)=>{const[p,h,T,R]=Ee(n,c,s,o,E,f),m=ve(e,(()=>pe(void 0,null,(function*(){return yield R((()=>pe(void 0,null,(function*(){var e,n,l;return yield p(),l=null!=(n=null==(e=(yield h(u,d))[A])?void 0:e[a])?n:"null",z(l,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>pe(void 0,null,(function*(){return yield R((()=>pe(void 0,null,(function*(){var n,l;yield p(),yield T(u,d,{[A]:{[a]:(l=null!=(n=e())?n:null,k(l,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),l,t,o,i,{[y]:()=>v,destroy:()=>(m.stopAutoLoad().stopAutoSave(),r(),m)},0,v);return m};var Te=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Re=(e,n,l,t,o,i,u,[d,a,[c,v,y]],E,f,p,T,R,N,O,g)=>{const[P,C,L,$]=Ee(n,E,f,o,R,N,O,g),b=(e,n)=>Te(void 0,null,(function*(){return yield s(V(a,((l,t)=>Te(void 0,[l,t],(function*([l,t,o,r],i){n&&!(i in e)||(yield L(l,t,e[i],o,r,n))})))))})),S=(e,n)=>Te(void 0,null,(function*(){return v?yield L(y,m,{[A]:e},!0,!0,n):null})),I=ve(e,(()=>Te(void 0,null,(function*(){return yield $((()=>Te(void 0,null,(function*(){yield P();const e=yield Te(void 0,null,(function*(){return j(h(yield s(V(d,((e,n)=>Te(void 0,[e,n],(function*([e,n],l){return[e,yield C(l,n)]}))))),(e=>!W(e[1]))))})),n=yield Te(void 0,null,(function*(){return c?(yield C(y,m))[A]:{}}));return W(e)&&r(n)?void 0:[e,n]}))))}))),((e,n)=>Te(void 0,null,(function*(){return yield $((()=>Te(void 0,null,(function*(){if(yield P(),r(n)){const[n,l]=e();yield b(n),yield S(l)}else yield b(n[0],!0),yield S(n[1],!0)}))))}))),l,t,o,u,{[T]:()=>p,destroy:()=>(I.stopAutoLoad().stopAutoSave(),i(),I)},0,p);return I},Ae="ColumnName",me="store",Ne="json",Oe=me+"TableName",ge=me+"Id"+Ae,Pe=me+Ae,Ce="autoLoadIntervalSeconds",Le="rowId"+Ae,$e="tableId",be="tableName",Se="deleteEmptyColumns",Ie="deleteEmptyTable",_e={mode:Ne,[Ce]:1},we={load:0,save:0,[be]:n+"_values"},xe=(e,n,l,t,o)=>{const i=J();return Y(e,((e,d)=>{const c=a(q(B(n,u(e)?{[l]:e}:e)),0,H(n));r(c[0])||t(d,c[0])||(o(d,c[0]),Q(i,d,c))})),i};var De=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ue=n,Fe=/^([cd]:)(.+)/,Me=n+"_data",Ge=n+"_table";var je=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Be=(e,l,t,o,r)=>je(void 0,null,(function*(){var d;const c=yield null==(d=l.reserve)?void 0:d.call(l);return((e,l,t,o,r,d,c,v,y,E,p="getDb")=>{const h=((e,n)=>n?(l,t)=>{return o=function*(){return n(l,t),yield e(l,t)},new Promise(((e,n)=>{var l=e=>{try{r(o.next(e))}catch(e){n(e)}},t=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,t);r((o=o.apply(void 0,null)).next())}));var o}:e)(t,d),[T,,R,A]=(e=>{var l,t,o;const r=(e=>B(_e,u(e)?{[Oe]:e}:null!=e?e:{}))(e),i=r[Ce];if(r.mode==Ne){const e=null!=(l=r[Oe])?l:n;return[1,i,[e,null!=(t=r[ge])?t:m,null!=(o=r[Pe])?o:me],ne(e)]}const{tables:{load:d={},save:c={}}={},values:s={}}=r,v=a(q(B(we,s)),0,H(we)),y=v[2],E=ne(y),f=ne(y);return[0,i,[xe(d,{[$e]:null,[Le]:m},$e,(e=>S(f,e)),(e=>le(E,e))),xe(c,{[be]:null,[Le]:m,[Se]:0,[Ie]:0},be,((e,n)=>S(f,n)),((e,n)=>le(E,n))),v],E]})(l),g=e=>De(void 0,null,(function*(){yield h(`CREATE OR REPLACE TRIGGER ${$(Me+"_"+e)} AFTER INSERT OR UPDATE OR DELETE ON ${$(e)} EXECUTE FUNCTION ${Me}()`)}));return(T?he:Re)(e,h,(e=>De(void 0,null,(function*(){yield h(`CREATE OR REPLACE FUNCTION ${Ge}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${Ue}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{yield h(`CREATE EVENT TRIGGER ${Ge} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${Ge}();`)}catch(e){}return yield h(`CREATE OR REPLACE FUNCTION ${Me}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${Ue}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),yield s(f(_(A),(e=>De(void 0,null,(function*(){yield h(`CREATE TABLE IF NOT EXISTS ${$(e)}("_id"text PRIMARY KEY)`),yield g(e)}))))),yield o(Ue,(n=>De(void 0,null,(function*(){return yield i((l=n,t=Fe,null==l?void 0:l.match(t)),(n=>De(void 0,[n],(function*([,n,l]){S(A,l)&&("c:"==n&&(yield g(l)),e())}))));var l,t}))))}))),r,c,v,y,R,_(A),((e,n)=>De(void 0,null,(function*(){return yield e(`${N} table_name tn,column_name cn FROM information_schema.columns ${O} table_schema='public'AND table_name IN(${b(n)})`,n)}))),E,p,"text",void 0,(e=>k(e)),(e=>z(e)))})(e,t,null==c?void 0:c.unsafe,((e,n)=>je(void 0,null,(function*(){return l.listen(e,n)}))),(e=>je(void 0,null,(function*(){try{yield e.unlisten()}catch(e){null==r||r(e)}}))),o,r,(()=>{var e;return null==(e=null==c?void 0:c.release)?void 0:e.call(c)}),3,l,"getSql")}));export{Be as createPostgresPersister};
