const e=e=>typeof e,n="tinybase",t="",l=",",o=e(t),r=Promise,i=clearInterval,u=e=>null==e,a=(e,n,t)=>u(e)?null==t?void 0:t():n(e),d=n=>e(n)==o,c=e=>Array.isArray(e),s=(e,n,t)=>e.slice(n,t),v=e=>e.length,y=e=>{return n=function*(){return r.all(e)},new Promise(((e,t)=>{var l=e=>{try{r(n.next(e))}catch(e){t(e)}},o=e=>{try{r(n.throw(e))}catch(e){t(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,o);r((n=n.apply(void 0,null)).next())}));var n},E=e=>{throw Error(e)},f=(e,n)=>e.forEach(n),p=(e,n="")=>e.join(n),h=(e,n)=>e.map(n),m=e=>0==v(e),R=(e,n)=>e.filter(n),A=(e,...n)=>e.push(...n),T=e=>e.shift(),N=Object,O=e=>N.getPrototypeOf(e),g=N.entries,$=N.keys,C=N.freeze,P=(e=[])=>N.fromEntries(e),b=(...e)=>N.assign({},...e),I=(e,n)=>(delete e[n],e),L=(e,n)=>h(g(e),(([e,t])=>n(t,e))),S=e=>N.values(e),_=e=>v($(e)),w=e=>(e=>!u(e)&&a(O(e),(e=>e==N.prototype||u(O(e))),(()=>!0)))(e)&&0==_(e),D=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},x=e=>u(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),M=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},F=(e,n)=>null==e?void 0:e.forEach(n),U=(e,n)=>null==e?void 0:e.delete(n),G=e=>new Map(e),j=(e,n)=>null==e?void 0:e.get(n),B=(e,n)=>{var t;return h([...null!=(t=null==e?void 0:e.entries())?t:[]],(([e,t])=>n(t,e)))},Y=(e,n,t)=>u(t)?(U(e,n),e):null==e?void 0:e.set(n,t),H=(e,n,t,l)=>(D(e,n)?null==l||l(j(e,n)):Y(e,n,t()),j(e,n)),X=(e,n,t,l,o=0)=>a((t?H:j)(e,n[o],o>v(n)-2?t:G),(r=>{if(o>v(n)-2)return(null==l?void 0:l(r))&&Y(e,n[o]),r;const i=X(r,n,t,l,o+1);return x(r)&&Y(e,n[o]),i})),J=e=>new Set(c(e)||u(e)?e:[e]),W=(e,n)=>null==e?void 0:e.add(n),k=/^\d+$/;var q=Object.defineProperty,z=Object.getOwnPropertySymbols,K=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable,Q=(e,n,t)=>n in e?q(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,Z=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const ee={Idle:0,Loading:1,Saving:2},ne={StoreOnly:1,MergeableStoreOnly:2,StoreOrMergeableStore:3},te=G(),le=G(),oe=(e,n,l,o,r,i,d,s={},y=0,p=[])=>{let h,m,R,N=0,O=0,g=0;H(te,p,(()=>0)),H(le,p,(()=>[]));const $=G(),[P,b,I,L,S]=((e=1,n,t)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!t),([[e],[n]])=>!w(e)||!w(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!w(e)||!w(n),n.setContent]:E("Store type not supported by this Persister"))(d,e,y),[_,D,M]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var o;return null!=(o=l?T(e):null)?o:t+n++},n=>{k.test(n)&&v(e)<1e3&&A(e,n)}]})(),o=G();return[(l,r,i,u=[],a=()=>[])=>{null!=e||(e=ue);const d=n(1);return Y(o,d,[l,r,i,u,a]),W(X(r,null!=i?i:[t],J),d),d},(n,l,...r)=>f(((e,n=[t])=>{const l=[],o=(e,t)=>t==v(n)?A(l,e):null===n[t]?F(e,(e=>o(e,t+1))):f([n[t],null],(n=>o(j(e,n),t+1)));return o(e,0),l})(n,l),(n=>F(n,(n=>j(o,n)[0](e,...null!=l?l:[],...r))))),e=>a(j(o,e),(([,n,r])=>(X(n,null!=r?r:[t],void 0,(n=>(U(n,e),x(n)?1:0))),Y(o,e),l(e),r))),n=>a(j(o,n),(([n,,t=[],l,o])=>{const r=(...i)=>{var a,d;const c=v(i);c==v(t)?n(e,...i,...o(i)):u(t[c])?f(null!=(d=null==(a=l[c])?void 0:a.call(l,...i))?d:[],(e=>r(...i,e))):r(...i,t[c])};r()}))]})(),B=e=>{e!=N&&(N=e,D($,void 0,N))},q=n=>{(P&&c(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},ee=e=>Z(void 0,null,(function*(){return 2!=N&&(B(1),O++,yield ie((()=>Z(void 0,null,(function*(){try{const t=yield n();c(t)?q(t):e?S(e):E("Content is not an array: "+t)}catch(n){null==i||i(n),e&&S(e)}B(0)}))))),ue})),ne=()=>(m&&(r(m),m=void 0),ue),oe=e=>Z(void 0,null,(function*(){return 1!=N&&(B(2),g++,yield ie((()=>Z(void 0,null,(function*(){try{yield l(b,e)}catch(e){null==i||i(e)}B(0)}))))),ue})),re=()=>(R&&(e.delListener(R),R=void 0),ue),ie=(...e)=>Z(void 0,null,(function*(){return A(j(le,p),...e),yield Z(void 0,null,(function*(){if(!j(te,p)){for(Y(te,p,1);!u(h=T(j(le,p)));)try{yield h()}catch(e){null==i||i(e)}Y(te,p,0)}})),ue})),ue=((e,n)=>{for(var t in n||(n={}))K.call(n,t)&&Q(e,t,n[t]);if(z)for(var t of z(n))V.call(n,t)&&Q(e,t,n[t]);return e})({load:ee,startAutoLoad:e=>Z(void 0,null,(function*(){ne(),yield ee(e);try{m=yield o(((e,n)=>Z(void 0,null,(function*(){n||e?2!=N&&(B(1),O++,q(null!=n?n:e),B(0)):yield ee()}))))}catch(e){null==i||i(e)}return ue})),stopAutoLoad:ne,isAutoLoading:()=>!u(m),save:oe,startAutoSave:()=>Z(void 0,null,(function*(){return re(),yield oe(),R=e.addDidFinishTransactionListener((()=>{const e=I();L(e)&&oe(e)})),ue})),stopAutoSave:re,isAutoSaving:()=>!u(R),getStatus:()=>N,addStatusListener:e=>_(e,$),delListener:n=>(M(n),e),schedule:ie,getStore:()=>e,destroy:()=>(j(le,p).splice(0,void 0),ne().stopAutoSave()),getStats:()=>({loads:O,saves:g})},s);return C(ue)},re="_",ie="_id",ue="SELECT",ae="WHERE",de="TABLE",ce="ALTER "+de,se="DELETE FROM",ve=ue+"*FROM",ye="pragma_",Ee="data_version",fe="schema_version",pe="pragma_table_",he=(e,n)=>n?(t,l)=>{return o=function*(){return n(t,l),yield e(t,l)},new Promise(((e,n)=>{var t=e=>{try{r(o.next(e))}catch(e){n(e)}},l=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,l);r((o=o.apply(void 0,null)).next())}));var o}:e,me=e=>`"${e.replace(/"/g,'""')}"`,Re=(e,n=[1])=>p(h(e,(()=>"$"+n[0]++)),l),Ae=JSON.stringify,Te=JSON.parse;var Ne=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Oe=(e,n,t,o,r,i=ge,a,d)=>{const c=G();return[()=>Ne(void 0,null,(function*(){c.clear(),h(yield t(e,n),(({tn:e,cn:n})=>W(H(c,e,J),n)))})),(n,t)=>Ne(void 0,null,(function*(){return((e,n)=>D(j(c,e),n))(n,t)?P(R(h(yield e(ve+me(n)),(e=>{return[e[t],d?(n=I(e,t),l=d,P(L(n,((e,n)=>[n,l(e,n)])))):I(e,t)];var n,l})),(([e,n])=>!u(e)&&!w(n)))):{}})),(n,t,o,d,s,v=!1)=>Ne(void 0,null,(function*(){const E=J();L(null!=o?o:{},(e=>h($(null!=e?e:{}),(e=>W(E,e)))));const f=M(E);if(!v&&s&&m(f)&&D(c,n))return yield e("DROP "+de+me(n)),void Y(c,n);const T=j(c,n),N=J(M(T));if(m(f)||(D(c,n)?yield y(h([t,...f],((l,o)=>Ne(void 0,null,(function*(){U(N,l)||(yield e(ce+me(n)+"ADD"+me(l)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+me(n)+`(${me(t)})`)),W(T,l))}))))):(yield e("CREATE "+de+me(n)+`(${me(t)}${r} PRIMARY KEY${p(h(f,(e=>l+me(e)+r)))});`),Y(c,n,J([t,...f])))),yield y([...!v&&d?h(M(N),(l=>Ne(void 0,null,(function*(){l!=t&&(yield e(ce+me(n)+"DROP"+me(l)),U(T,l))})))):[]]),v)u(o)?yield e(se+me(n)+ae+" true"):yield y(L(o,((l,o)=>Ne(void 0,null,(function*(){u(l)?yield e(se+me(n)+ae+me(t)+"=$1",[o]):m(f)||(yield i(e,n,t,$(l),{[o]:a?h(S(l),a):S(l)},T))})))));else if(m(f))D(c,n)&&(yield e(se+me(n)+ae+" true"));else{const l=R(M(j(c,n)),(e=>e!=t)),r={},u=[];L(null!=o?o:{},((e,n)=>{r[n]=h(l,(n=>a?a(null==e?void 0:e[n]):null==e?void 0:e[n])),A(u,n)})),yield i(e,n,t,l,r),yield e(se+me(n)+ae+me(t)+`NOT IN(${Re(u)})`,u)}})),n=>Ne(void 0,null,(function*(){let t;yield e("BEGIN");try{t=yield n()}catch(e){null==o||o(e)}return yield e("END"),t}))]},ge=(e,n,t,o,r)=>Ne(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+me(n)+"("+((...e)=>p(h(e,me),l))(t,...o)+")VALUES"+p(L(r,(e=>"($"+i[0]+++","+Re(e,i)+")")),l)+"ON CONFLICT("+me(t)+")DO UPDATE SET"+p(h(o,(e=>me(e)+"=excluded."+me(e))),l),L(r,((e,n)=>[n,...h(e,(e=>null!=e?e:null))])).flat())}));var $e=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Ce=(e,n,t,l,o,r,i,[u,a,d],c,s,v,y,E,f)=>{const[p,h,m,R]=Oe(n,c,s,o,E,f),A=oe(e,(()=>$e(void 0,null,(function*(){return yield R((()=>$e(void 0,null,(function*(){var e,n,t;return yield p(),t=null!=(n=null==(e=(yield h(u,a))[re])?void 0:e[d])?n:"null",Te(t,((e,n)=>"ï¿¼"===n?void 0:n))}))))}))),(e=>$e(void 0,null,(function*(){return yield R((()=>$e(void 0,null,(function*(){var n,t;yield p(),yield m(u,a,{[re]:{[d]:(t=null!=(n=e())?n:null,Ae(t,((e,n)=>void 0===n?"ï¿¼":n)))}},!0,!0)}))))}))),t,l,o,i,{[y]:()=>v,destroy:()=>(A.stopAutoLoad().stopAutoSave(),r(),A)},0,v);return A};var Pe=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const be=(e,n,t,l,o,r,i,[a,d,[c,s,v]],E,f,p,h,m,A,T,N)=>{const[O,g,$,C]=Oe(n,E,f,o,m,A,T,N),b=(e,n)=>Pe(void 0,null,(function*(){return yield y(B(d,((t,l)=>Pe(void 0,[t,l],(function*([t,l,o,r],i){n&&!(i in e)||(yield $(t,l,e[i],o,r,n))})))))})),I=(e,n)=>Pe(void 0,null,(function*(){return s?yield $(v,ie,{[re]:e},!0,!0,n):null})),L=oe(e,(()=>Pe(void 0,null,(function*(){return yield C((()=>Pe(void 0,null,(function*(){yield O();const e=yield Pe(void 0,null,(function*(){return P(R(yield y(B(a,((e,n)=>Pe(void 0,[e,n],(function*([e,n],t){return[e,yield g(t,n)]}))))),(e=>!w(e[1]))))})),n=yield Pe(void 0,null,(function*(){return c?(yield g(v,ie))[re]:{}}));return w(e)&&u(n)?void 0:[e,n]}))))}))),((e,n)=>Pe(void 0,null,(function*(){return yield C((()=>Pe(void 0,null,(function*(){if(yield O(),u(n)){const[n,t]=e();yield b(n),yield I(t)}else yield b(n[0],!0),yield I(n[1],!0)}))))}))),t,l,o,i,{[h]:()=>p,destroy:()=>(L.stopAutoLoad().stopAutoSave(),r(),L)},0,p);return L},Ie="ColumnName",Le="store",Se="json",_e=Le+"TableName",we=Le+"Id"+Ie,De=Le+Ie,xe="autoLoadIntervalSeconds",Me="rowId"+Ie,Fe="tableId",Ue="tableName",Ge="deleteEmptyColumns",je="deleteEmptyTable",Be={mode:Se,[xe]:1},Ye={load:0,save:0,[Ue]:n+"_values"},He=(e,n,t,l,o)=>{const r=G();return L(e,((e,i)=>{const a=s(S(b(n,d(e)?{[t]:e}:e)),0,_(n));u(a[0])||l(i,a[0])||(o(i,a[0]),Y(r,i,a))})),r},Xe=e=>{var t,l,o;const r=(e=>b(Be,d(e)?{[_e]:e}:null!=e?e:{}))(e),i=r[xe];if(r.mode==Se){const e=null!=(t=r[_e])?t:n;return[1,i,[e,null!=(l=r[we])?l:ie,null!=(o=r[De])?o:Le],J(e)]}const{tables:{load:u={},save:a={}}={},values:c={}}=r,v=s(S(b(Ye,c)),0,_(Ye)),y=v[2],E=J(y),f=J(y);return[0,i,[He(u,{[Fe]:null,[Me]:ie},Fe,(e=>D(f,e)),(e=>W(E,e))),He(a,{[Ue]:null,[Me]:ie,[Ge]:0,[je]:0},Ue,((e,n)=>D(f,n)),((e,n)=>W(E,n))),v],E]};var Je=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const We=(e,n,l,o,r,u,a,d,c,s,v="getDb",y)=>{let E,f,p;const h=he(l,u),[m,R,A,T]=Xe(n);return(m?Ce:be)(e,h,(e=>{let n;const t=()=>n=setInterval((()=>Je(void 0,null,(function*(){try{const[{d:n,s:t,c:l}]=yield h(`${ue} ${Ee} d,${fe} s,TOTAL_CHANGES() c FROM ${ye}${Ee} JOIN ${ye}${fe}`);n==E&&t==f&&l==p||(null!=E&&e(),E=n,f=t,p=l)}catch(e){}}))),1e3*R),l=()=>{E=f=p=null,i(n)},u=o((n=>{T.has(n)&&(l(),e(),t())}));return t(),()=>{l(),r(u)}}),(e=>e()),a,d,c,A,M(T),((e,n)=>Je(void 0,null,(function*(){return yield e(`${ue} t.name tn,c.name cn FROM ${pe}list()t,${pe}info(t.name)c ${ae} t.schema='main'AND t.type IN('table','view')AND t.name IN(${Re(n)})ORDER BY t.name,c.name`,n)}))),s,v,t,y,(e=>!0===e?1:!1===e?0:e),void 0)};var ke=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const qe=n,ze=/^([cd]:)(.+)/,Ke=n+"_data",Ve=n+"_table",Qe=(e,n,t,l,o,r,i,u,d,c,s="getDb")=>{const v=he(t,r),[E,,f,p]=Xe(n),m=e=>ke(void 0,null,(function*(){yield v(`CREATE OR REPLACE TRIGGER ${me(Ke+"_"+e)} AFTER INSERT OR UPDATE OR DELETE ON ${me(e)} EXECUTE FUNCTION ${Ke}()`)}));return(E?Ce:be)(e,v,(e=>ke(void 0,null,(function*(){yield v(`CREATE OR REPLACE FUNCTION ${Ve}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${qe}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{yield v(`CREATE EVENT TRIGGER ${Ve} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${Ve}();`)}catch(e){}return yield v(`CREATE OR REPLACE FUNCTION ${Ke}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${qe}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),yield y(h(M(p),(e=>ke(void 0,null,(function*(){yield v(`CREATE TABLE IF NOT EXISTS ${me(e)}("_id"text PRIMARY KEY)`),yield m(e)}))))),yield l(qe,(n=>ke(void 0,null,(function*(){return yield a((t=n,l=ze,null==t?void 0:t.match(l)),(n=>ke(void 0,[n],(function*([,n,t]){D(p,t)&&("c:"==n&&(yield m(t)),e())}))));var t,l}))))}))),o,i,u,d,f,M(p),((e,n)=>ke(void 0,null,(function*(){return yield e(`${ue} table_name tn,column_name cn FROM information_schema.columns ${ae} table_schema='public'AND table_name IN(${Re(n)})`,n)}))),c,s,"text",void 0,(e=>Ae(e)),(e=>Te(e)))};export{ne as Persists,ee as Status,oe as createCustomPersister,Qe as createCustomPostgreSqlPersister,We as createCustomSqlitePersister};
