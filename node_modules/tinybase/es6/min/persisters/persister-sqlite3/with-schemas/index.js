const e=e=>typeof e,n="tinybase",t="",l=",",o=e(t),r=Promise,i=clearInterval,u=e=>null==e,a=(e,n,t)=>u(e)?null==t?void 0:t():n(e),d=n=>e(n)==o,s=e=>Array.isArray(e),c=(e,n,t)=>e.slice(n,t),v=e=>e.length,y=e=>{return n=function*(){return r.all(e)},new Promise(((e,t)=>{var l=e=>{try{r(n.next(e))}catch(e){t(e)}},o=e=>{try{r(n.throw(e))}catch(e){t(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,o);r((n=n.apply(void 0,null)).next())}));var n},f=e=>{throw Error(e)},h=(e,n)=>e.forEach(n),p=(e,n="")=>e.join(n),m=(e,n)=>e.map(n),E=e=>0==v(e),g=(e,n)=>e.filter(n),P=(e,...n)=>e.push(...n),b=e=>e.shift(),w="_",A="_id",O="SELECT",N="WHERE",$="TABLE",S="ALTER "+$,C="DELETE FROM",T=O+"*FROM",x="pragma_",I="data_version",L="schema_version",D="pragma_table_",R=e=>`"${e.replace(/"/g,'""')}"`,M=(e,n=[1])=>p(m(e,(()=>"$"+n[0]++)),l),_=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},j=e=>u(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),F=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},U=(e,n)=>null==e?void 0:e.forEach(n),B=(e,n)=>null==e?void 0:e.delete(n),J=Object,Y=e=>J.getPrototypeOf(e),k=J.entries,z=J.keys,G=J.freeze,H=(e=[])=>J.fromEntries(e),K=(...e)=>J.assign({},...e),Q=(e,n)=>(delete e[n],e),V=(e,n)=>m(k(e),(([e,t])=>n(t,e))),W=e=>J.values(e),X=e=>v(z(e)),q=e=>(e=>!u(e)&&a(Y(e),(e=>e==J.prototype||u(Y(e))),(()=>!0)))(e)&&0==X(e),Z=JSON.stringify,ee=JSON.parse,ne=e=>new Map(e),te=(e,n)=>null==e?void 0:e.get(n),le=(e,n)=>{var t;return m([...null!=(t=null==e?void 0:e.entries())?t:[]],(([e,t])=>n(t,e)))},oe=(e,n,t)=>u(t)?(B(e,n),e):null==e?void 0:e.set(n,t),re=(e,n,t,l)=>(_(e,n)?null==l||l(te(e,n)):oe(e,n,t()),te(e,n)),ie=(e,n,t,l,o=0)=>a((t?re:te)(e,n[o],o>v(n)-2?t:ne),(r=>{if(o>v(n)-2)return(null==l?void 0:l(r))&&oe(e,n[o]),r;const i=ie(r,n,t,l,o+1);return j(r)&&oe(e,n[o]),i})),ue=e=>new Set(s(e)||u(e)?e:[e]),ae=(e,n)=>null==e?void 0:e.add(n),de=/^\d+$/;var se=Object.defineProperty,ce=Object.getOwnPropertySymbols,ve=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable,fe=(e,n,t)=>n in e?se(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,he=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const pe=ne(),me=ne(),Ee=(e,n,l,o,r,i,d,c={},y=0,p=[])=>{let m,E,g,w=0,A=0,O=0;re(pe,p,(()=>0)),re(me,p,(()=>[]));const N=ne(),[$,S,C,T,x]=((e=1,n,t)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!t),([[e],[n]])=>!q(e)||!q(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!q(e)||!q(n),n.setContent]:f("Store type not supported by this Persister"))(d,e,y),[I,L,D]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var o;return null!=(o=l?b(e):null)?o:t+n++},n=>{de.test(n)&&v(e)<1e3&&P(e,n)}]})(),o=ne();return[(l,r,i,u=[],a=()=>[])=>{null!=e||(e=z);const d=n(1);return oe(o,d,[l,r,i,u,a]),ae(ie(r,null!=i?i:[t],ue),d),d},(n,l,...r)=>h(((e,n=[t])=>{const l=[],o=(e,t)=>t==v(n)?P(l,e):null===n[t]?U(e,(e=>o(e,t+1))):h([n[t],null],(n=>o(te(e,n),t+1)));return o(e,0),l})(n,l),(n=>U(n,(n=>te(o,n)[0](e,...null!=l?l:[],...r))))),e=>a(te(o,e),(([,n,r])=>(ie(n,null!=r?r:[t],void 0,(n=>(B(n,e),j(n)?1:0))),oe(o,e),l(e),r))),n=>a(te(o,n),(([n,,t=[],l,o])=>{const r=(...i)=>{var a,d;const s=v(i);s==v(t)?n(e,...i,...o(i)):u(t[s])?h(null!=(d=null==(a=l[s])?void 0:a.call(l,...i))?d:[],(e=>r(...i,e))):r(...i,t[s])};r()}))]})(),R=e=>{e!=w&&(w=e,L(N,void 0,w))},M=n=>{($&&s(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},_=e=>he(void 0,null,(function*(){return 2!=w&&(R(1),A++,yield k((()=>he(void 0,null,(function*(){try{const t=yield n();s(t)?M(t):e?x(e):f("Content is not an array: "+t)}catch(n){null==i||i(n),e&&x(e)}R(0)}))))),z})),F=()=>(E&&(r(E),E=void 0),z),J=e=>he(void 0,null,(function*(){return 1!=w&&(R(2),O++,yield k((()=>he(void 0,null,(function*(){try{yield l(S,e)}catch(e){null==i||i(e)}R(0)}))))),z})),Y=()=>(g&&(e.delListener(g),g=void 0),z),k=(...e)=>he(void 0,null,(function*(){return P(te(me,p),...e),yield he(void 0,null,(function*(){if(!te(pe,p)){for(oe(pe,p,1);!u(m=b(te(me,p)));)try{yield m()}catch(e){null==i||i(e)}oe(pe,p,0)}})),z})),z=((e,n)=>{for(var t in n||(n={}))ve.call(n,t)&&fe(e,t,n[t]);if(ce)for(var t of ce(n))ye.call(n,t)&&fe(e,t,n[t]);return e})({load:_,startAutoLoad:e=>he(void 0,null,(function*(){F(),yield _(e);try{E=yield o(((e,n)=>he(void 0,null,(function*(){n||e?2!=w&&(R(1),A++,M(null!=n?n:e),R(0)):yield _()}))))}catch(e){null==i||i(e)}return z})),stopAutoLoad:F,isAutoLoading:()=>!u(E),save:J,startAutoSave:()=>he(void 0,null,(function*(){return Y(),yield J(),g=e.addDidFinishTransactionListener((()=>{const e=C();T(e)&&J(e)})),z})),stopAutoSave:Y,isAutoSaving:()=>!u(g),getStatus:()=>w,addStatusListener:e=>I(e,N),delListener:n=>(D(n),e),schedule:k,getStore:()=>e,destroy:()=>(te(me,p).splice(0,void 0),F().stopAutoSave()),getStats:()=>({loads:A,saves:O})},c);return G(z)};var ge=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Pe=(e,n,t,o,r,i=be,a,d)=>{const s=ne();return[()=>ge(void 0,null,(function*(){s.clear(),m(yield t(e,n),(({tn:e,cn:n})=>ae(re(s,e,ue),n)))})),(n,t)=>ge(void 0,null,(function*(){return((e,n)=>_(te(s,e),n))(n,t)?H(g(m(yield e(T+R(n)),(e=>{return[e[t],d?(n=Q(e,t),l=d,H(V(n,((e,n)=>[n,l(e,n)])))):Q(e,t)];var n,l})),(([e,n])=>!u(e)&&!q(n)))):{}})),(n,t,o,d,c,v=!1)=>ge(void 0,null,(function*(){const f=ue();V(null!=o?o:{},(e=>m(z(null!=e?e:{}),(e=>ae(f,e)))));const h=F(f);if(!v&&c&&E(h)&&_(s,n))return yield e("DROP "+$+R(n)),void oe(s,n);const b=te(s,n),w=ue(F(b));if(E(h)||(_(s,n)?yield y(m([t,...h],((l,o)=>ge(void 0,null,(function*(){B(w,l)||(yield e(S+R(n)+"ADD"+R(l)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+R(n)+`(${R(t)})`)),ae(b,l))}))))):(yield e("CREATE "+$+R(n)+`(${R(t)}${r} PRIMARY KEY${p(m(h,(e=>l+R(e)+r)))});`),oe(s,n,ue([t,...h])))),yield y([...!v&&d?m(F(w),(l=>ge(void 0,null,(function*(){l!=t&&(yield e(S+R(n)+"DROP"+R(l)),B(b,l))})))):[]]),v)u(o)?yield e(C+R(n)+N+" true"):yield y(V(o,((l,o)=>ge(void 0,null,(function*(){u(l)?yield e(C+R(n)+N+R(t)+"=$1",[o]):E(h)||(yield i(e,n,t,z(l),{[o]:a?m(W(l),a):W(l)},b))})))));else if(E(h))_(s,n)&&(yield e(C+R(n)+N+" true"));else{const l=g(F(te(s,n)),(e=>e!=t)),r={},u=[];V(null!=o?o:{},((e,n)=>{r[n]=m(l,(n=>a?a(null==e?void 0:e[n]):null==e?void 0:e[n])),P(u,n)})),yield i(e,n,t,l,r),yield e(C+R(n)+N+R(t)+`NOT IN(${M(u)})`,u)}})),n=>ge(void 0,null,(function*(){let t;yield e("BEGIN");try{t=yield n()}catch(e){null==o||o(e)}return yield e("END"),t}))]},be=(e,n,t,o,r)=>ge(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+R(n)+"("+((...e)=>p(m(e,R),l))(t,...o)+")VALUES"+p(V(r,(e=>"($"+i[0]+++","+M(e,i)+")")),l)+"ON CONFLICT("+R(t)+")DO UPDATE SET"+p(m(o,(e=>R(e)+"=excluded."+R(e))),l),V(r,((e,n)=>[n,...m(e,(e=>null!=e?e:null))])).flat())}));var we=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Ae=(e,n,t,l,o,r,i,[u,a,d],s,c,v,y,f,h)=>{const[p,m,E,g]=Pe(n,s,c,o,f,h),P=Ee(e,(()=>we(void 0,null,(function*(){return yield g((()=>we(void 0,null,(function*(){var e,n,t;return yield p(),t=null!=(n=null==(e=(yield m(u,a))[w])?void 0:e[d])?n:"null",ee(t,((e,n)=>"ï¿¼"===n?void 0:n))}))))}))),(e=>we(void 0,null,(function*(){return yield g((()=>we(void 0,null,(function*(){var n,t;yield p(),yield E(u,a,{[w]:{[d]:(t=null!=(n=e())?n:null,Z(t,((e,n)=>void 0===n?"ï¿¼":n)))}},!0,!0)}))))}))),t,l,o,i,{[y]:()=>v,destroy:()=>(P.stopAutoLoad().stopAutoSave(),r(),P)},0,v);return P};var Oe=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Ne=(e,n,t,l,o,r,i,[a,d,[s,c,v]],f,h,p,m,E,P,b,O)=>{const[N,$,S,C]=Pe(n,f,h,o,E,P,b,O),T=(e,n)=>Oe(void 0,null,(function*(){return yield y(le(d,((t,l)=>Oe(void 0,[t,l],(function*([t,l,o,r],i){n&&!(i in e)||(yield S(t,l,e[i],o,r,n))})))))})),x=(e,n)=>Oe(void 0,null,(function*(){return c?yield S(v,A,{[w]:e},!0,!0,n):null})),I=Ee(e,(()=>Oe(void 0,null,(function*(){return yield C((()=>Oe(void 0,null,(function*(){yield N();const e=yield Oe(void 0,null,(function*(){return H(g(yield y(le(a,((e,n)=>Oe(void 0,[e,n],(function*([e,n],t){return[e,yield $(t,n)]}))))),(e=>!q(e[1]))))})),n=yield Oe(void 0,null,(function*(){return s?(yield $(v,A))[w]:{}}));return q(e)&&u(n)?void 0:[e,n]}))))}))),((e,n)=>Oe(void 0,null,(function*(){return yield C((()=>Oe(void 0,null,(function*(){if(yield N(),u(n)){const[n,t]=e();yield T(n),yield x(t)}else yield T(n[0],!0),yield x(n[1],!0)}))))}))),t,l,o,i,{[m]:()=>p,destroy:()=>(I.stopAutoLoad().stopAutoSave(),r(),I)},0,p);return I},$e="ColumnName",Se="store",Ce="json",Te=Se+"TableName",xe=Se+"Id"+$e,Ie=Se+$e,Le="autoLoadIntervalSeconds",De="rowId"+$e,Re="tableId",Me="tableName",_e="deleteEmptyColumns",je="deleteEmptyTable",Fe={mode:Ce,[Le]:1},Ue={load:0,save:0,[Me]:n+"_values"},Be=(e,n,t,l,o)=>{const r=ne();return V(e,((e,i)=>{const a=c(W(K(n,d(e)?{[t]:e}:e)),0,X(n));u(a[0])||l(i,a[0])||(o(i,a[0]),oe(r,i,a))})),r};var Je=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Ye=(e,l,o,r,u,a,s,v,y,f,h="getDb",p)=>{let m,E,g;const P=((e,n)=>n?(t,l)=>{return o=function*(){return n(t,l),yield e(t,l)},new Promise(((e,n)=>{var t=e=>{try{r(o.next(e))}catch(e){n(e)}},l=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,l);r((o=o.apply(void 0,null)).next())}));var o}:e)(o,a),[b,w,$,S]=(e=>{var t,l,o;const r=(e=>K(Fe,d(e)?{[Te]:e}:null!=e?e:{}))(e),i=r[Le];if(r.mode==Ce){const e=null!=(t=r[Te])?t:n;return[1,i,[e,null!=(l=r[xe])?l:A,null!=(o=r[Ie])?o:Se],ue(e)]}const{tables:{load:u={},save:a={}}={},values:s={}}=r,v=c(W(K(Ue,s)),0,X(Ue)),y=v[2],f=ue(y),h=ue(y);return[0,i,[Be(u,{[Re]:null,[De]:A},Re,(e=>_(h,e)),(e=>ae(f,e))),Be(a,{[Me]:null,[De]:A,[_e]:0,[je]:0},Me,((e,n)=>_(h,n)),((e,n)=>ae(f,n))),v],f]})(l);return(b?Ae:Ne)(e,P,(e=>{let n;const t=()=>n=setInterval((()=>Je(void 0,null,(function*(){try{const[{d:n,s:t,c:l}]=yield P(`${O} ${I} d,${L} s,TOTAL_CHANGES() c FROM ${x}${I} JOIN ${x}${L}`);n==m&&t==E&&l==g||(null!=m&&e(),m=n,E=t,g=l)}catch(e){}}))),1e3*w),l=()=>{m=E=g=null,i(n)},o=r((n=>{S.has(n)&&(l(),e(),t())}));return t(),()=>{l(),u(o)}}),(e=>e()),s,v,y,$,F(S),((e,n)=>Je(void 0,null,(function*(){return yield e(`${O} t.name tn,c.name cn FROM ${D}list()t,${D}info(t.name)c ${N} t.schema='main'AND t.type IN('table','view')AND t.name IN(${M(n)})ORDER BY t.name,c.name`,n)}))),f,h,t,p,(e=>!0===e?1:!1===e?0:e),void 0)},ke="change",ze=(e,n,t,l,o)=>Ye(e,t,((e,...t)=>{return l=[e,...t],o=function*(e,t=[]){return yield(l=(l,o)=>n.all(e,t,((e,n)=>e?o(e):l(n))),new r(l));var l},new Promise(((e,n)=>{var t=e=>{try{i(o.next(e))}catch(e){n(e)}},r=e=>{try{i(o.throw(e))}catch(e){n(e)}},i=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,r);i((o=o.apply(void 0,l)).next())}));var l,o}),(e=>{const t=(n,t,l)=>e(l);return n.on(ke,t),t}),(e=>n.off(ke,e)),l,o,(()=>0),3,n);export{ze as createSqlite3Persister};
