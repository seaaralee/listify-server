import{Map as e}from"yjs";const t="t",n="v",l=e=>null==e,o=(e,t,n)=>l(e)?null==n?void 0:n():t(e),r=e=>Array.isArray(e),u=e=>e.length,i=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),s=(e,...t)=>e.push(...t),d=e=>e.shift(),c=Object,v=e=>c.getPrototypeOf(e),g=c.entries,y=c.keys,p=c.freeze,f=(e=[])=>c.fromEntries(e),h=(e,t)=>t in e,b=(e,t)=>((e,t)=>e.map(t))(g(e),(([e,n])=>t(n,e))),S=e=>(e=>!l(e)&&o(v(e),(e=>e==c.prototype||l(v(e))),(()=>!0)))(e)&&0==(e=>u(y(e)))(e),O=(e,t,n)=>(h(e,t)||(e[t]=n()),e[t]),w=e=>l(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),m=(e,t)=>null==e?void 0:e.forEach(t),C=(e,t)=>null==e?void 0:e.delete(t),A=e=>new Map(e),P=(e,t)=>null==e?void 0:e.get(t),M=(e,t)=>m(e,((e,n)=>t(n,e))),L=(e,t,n)=>l(n)?(C(e,t),e):null==e?void 0:e.set(t,n),j=(e,t,n,l)=>{var o,r,u;return r=t,null!=(u=null==(o=e)?void 0:o.has(r))&&u?null==l||l(P(e,t)):L(e,t,n()),P(e,t)},E=(e,t,n,l,r=0)=>o((n?j:P)(e,t[r],r>u(t)-2?n:A),(o=>{if(r>u(t)-2)return(null==l?void 0:l(o))&&L(e,t[r]),o;const i=E(o,t,n,l,r+1);return w(o)&&L(e,t[r]),i})),J=e=>new Set(r(e)||l(e)?e:[e]),N=/^\d+$/;var x=Object.defineProperty,z=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable,k=(e,t,n)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,F=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},u=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,u);i((n=n.apply(e,t)).next())}));const I=A(),Y=A(),$=(e,t,n,c,v,g,y,f={},h=0,b=[])=>{let O,M,x,$=0,q=0,B=0;j(I,b,(()=>0)),j(Y,b,(()=>[]));const G=A(),[H,K,Q,R,U]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!S(e)||!S(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!S(e)||!S(t),t.setContent]:i("Store type not supported by this Persister"))(y,e,h),[V,W,X]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?d(e):null)?l:""+t++},t=>{N.test(t)&&u(e)<1e3&&s(e,t)}]})(),r=A();return[(n,l,o,u=[],i=()=>[])=>{null!=e||(e=re);const a=t(1);var s,d;return L(r,a,[n,l,o,u,i]),d=a,null==(s=E(l,null!=o?o:[""],J))||s.add(d),a},(t,n,...l)=>a(((e,t=[""])=>{const n=[],l=(e,o)=>o==u(t)?s(n,e):null===t[o]?m(e,(e=>l(e,o+1))):a([t[o],null],(t=>l(P(e,t),o+1)));return l(e,0),n})(t,n),(t=>m(t,(t=>P(r,t)[0](e,...null!=n?n:[],...l))))),e=>o(P(r,e),(([,t,l])=>(E(t,null!=l?l:[""],void 0,(t=>(C(t,e),w(t)?1:0))),L(r,e),n(e),l))),t=>o(P(r,t),(([t,,n=[],o,r])=>{const i=(...s)=>{var d,c;const v=u(s);v==u(n)?t(e,...s,...r(s)):l(n[v])?a(null!=(c=null==(d=o[v])?void 0:d.call(o,...s))?c:[],(e=>i(...s,e))):i(...s,n[v])};i()}))]})(),Z=e=>{e!=$&&($=e,W(G,void 0,$))},_=t=>{(H&&r(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>F(void 0,null,(function*(){return 2!=$&&(Z(1),q++,yield oe((()=>F(void 0,null,(function*(){try{const n=yield t();r(n)?_(n):e?U(e):i("Content is not an array: "+n)}catch(t){null==g||g(t),e&&U(e)}Z(0)}))))),re})),te=()=>(M&&(v(M),M=void 0),re),ne=e=>F(void 0,null,(function*(){return 1!=$&&(Z(2),B++,yield oe((()=>F(void 0,null,(function*(){try{yield n(K,e)}catch(e){null==g||g(e)}Z(0)}))))),re})),le=()=>(x&&(e.delListener(x),x=void 0),re),oe=(...e)=>F(void 0,null,(function*(){return s(P(Y,b),...e),yield F(void 0,null,(function*(){if(!P(I,b)){for(L(I,b,1);!l(O=d(P(Y,b)));)try{yield O()}catch(e){null==g||g(e)}L(I,b,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))D.call(t,n)&&k(e,n,t[n]);if(z)for(var n of z(t))T.call(t,n)&&k(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>F(void 0,null,(function*(){te(),yield ee(e);try{M=yield c(((e,t)=>F(void 0,null,(function*(){t||e?2!=$&&(Z(1),q++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==g||g(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!l(M),save:ne,startAutoSave:()=>F(void 0,null,(function*(){return le(),yield ne(),x=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!l(x),getStatus:()=>$,addStatusListener:e=>V(e,G),delListener:t=>(X(t),e),schedule:oe,getStore:()=>e,destroy:()=>(P(Y,b).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:q,saves:B})},f);return p(re)};var q=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},u=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,u);i((n=n.apply(e,t)).next())}));const B="delete",G=e=>[e.get(t),e.get(n)],H=(t,n,o,r)=>{var u;const i=l(n)?t:null!=(u=t.get(n))?u:t.set(n,new e);let a;return b(o,((e,t)=>{r(i,t,e)&&(a=1)})),i.forEach(((e,t)=>{h(o,t)||(i.delete(t),a=1)})),l(n)||i.size||t.delete(n),a},K=(r,i,s="tinybase",c)=>{const v=i.getMap(s);return $(r,(()=>q(void 0,null,(function*(){return v.size?[v.get(t).toJSON(),v.get(n).toJSON()]:void 0}))),((r,u)=>q(void 0,null,(function*(){return i.transact((()=>((r,u,i)=>{r.size||(r.set(t,new e),r.set(n,new e));const[a,s]=G(r),d=()=>{c=1};let c=1;if(o(i,(([e,t])=>{c=0,b(e,((e,t)=>c?0:l(e)?a.delete(t):o(a.get(t),(t=>b(e,((e,n)=>c?0:l(e)?t.delete(n):o(t.get(n),(t=>b(e,((e,n)=>l(e)?t.delete(n):t.set(n,e)))),d)))),d))),b(t,((e,t)=>c?0:l(e)?s.delete(t):s.set(t,e)))})),c){const[e,t]=u();H(a,void 0,e,((e,t,n)=>H(a,t,n,((e,t,n)=>H(e,t,n,((e,t,n)=>{if(e.get(t)!==n)return e.set(t,n),1})))))),H(s,void 0,t,((e,t,n)=>{s.get(t)!==n&&s.set(t,n)}))}})(v,r,u)))}))),(e=>{const l=l=>e(void 0,((e,l)=>{if(1==u(l)&&(r=l[0].path,0==u(r)))return[e.get(t).toJSON(),e.get(n).toJSON(),1];var r;const[i,s]=G(e),c={},v={};return a(l,(({path:e,changes:{keys:n}})=>d(e)==t?o(d(e),(t=>{const l=O(c,t,f),r=i.get(t);o(d(e),(e=>{const t=O(l,e,f),o=r.get(e);M(n,((e,{action:n})=>t[e]=n==B?null:o.get(e)))}),(()=>M(n,((e,{action:t})=>{var n;return l[e]=t==B?null:null==(n=r.get(e))?void 0:n.toJSON()}))))}),(()=>M(n,((e,{action:t})=>{var n;return c[e]=t==B?null:null==(n=i.get(e))?void 0:n.toJSON()})))):M(n,((e,{action:t})=>v[e]=t==B?null:s.get(e))))),[c,v,1]})(v,l));return v.observeDeep(l),l}),(e=>{v.unobserveDeep(e)}),c,1,{getYDoc:()=>i})};export{K as createYjsPersister};
