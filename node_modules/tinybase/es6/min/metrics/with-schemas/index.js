const e=e=>typeof e,n="",t=e(n),l=e(e),r=Math,i=r.max,o=r.min,u=isFinite,s=e=>null==e,d=(e,n,t)=>s(e)?void 0:n(e),a=e=>Array.isArray(e),v=e=>e.length,c=()=>{},h=(e,n)=>e.forEach(n),f=e=>g(e,((e,n)=>e+n),0),g=(e,n,t)=>e.reduce(n,t),M=(e,...n)=>e.push(...n),L=Object.freeze,m=e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0},w=(y=m,e=>g(I(e),((e,n)=>e+y(n)),0));var y;const p=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},b=e=>s(e)||0==m(e),I=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},x=e=>e.clear(),E=(e,n)=>null==e?void 0:e.forEach(n),R=(e,n)=>null==e?void 0:e.delete(n),S=e=>new Map(e),T=(e,n)=>null==e?void 0:e.get(n),k=(e,n)=>E(e,((e,t)=>n(t,e))),z=(e,n,t)=>s(t)?(R(e,n),e):null==e?void 0:e.set(n,t),A=(e,n,t,l)=>(p(e,n)?null==l||l(T(e,n)):z(e,n,t()),T(e,n)),D=(e,n,t,l,r=0)=>d((t?A:T)(e,n[r],r>v(n)-2?t:S),(i=>{if(r>v(n)-2)return(null==l?void 0:l(i))&&z(e,n[r]),i;const o=D(i,n,t,l,r+1);return b(i)&&z(e,n[r]),o})),N=S([["avg",[(e,n)=>f(e)/n,(e,n,t)=>e+(n-e)/(t+1),(e,n,t)=>e+(e-n)/(t-1),(e,n,t,l)=>e+(n-t)/l]],["max",[e=>i(...e),(e,n)=>i(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:i(n,e)]],["min",[e=>o(...e),(e,n)=>o(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:o(n,e)]],["sum",[e=>f(e),(e,n)=>e+n,(e,n)=>e-n,(e,n,t)=>e-t+n]]]),j=e=>new Set(a(e)||s(e)?e:[e]),C=(e,n)=>null==e?void 0:e.add(n),F=/^\d+$/,O=(()=>{const r=new WeakMap;return i=>(r.has(i)||r.set(i,(r=>{const i=S(),[o,f,g]=(()=>{let e;const[t,l]=(()=>{const e=[];let t=0;return[l=>{var r;return null!=(r=l?e.shift():null)?r:n+t++},n=>{F.test(n)&&v(e)<1e3&&M(e,n)}]})(),r=S();return[(l,i,o,u=[],s=()=>[])=>{null!=e||(e=Q);const d=t(1);return z(r,d,[l,i,o,u,s]),C(D(i,null!=o?o:[n],j),d),d},(t,l,...i)=>h(((e,t=[n])=>{const l=[],r=(e,n)=>n==v(t)?M(l,e):null===t[n]?E(e,(e=>r(e,n+1))):h([t[n],null],(t=>r(T(e,t),n+1)));return r(e,0),l})(t,l),(n=>E(n,(n=>T(r,n)[0](e,...null!=l?l:[],...i))))),e=>d(T(r,e),(([,t,i])=>(D(t,null!=i?i:[n],void 0,(n=>(R(n,e),b(n)?1:0))),z(r,e),l(e),i))),n=>d(T(r,n),(([n,,t=[],l,r])=>{const i=(...o)=>{var u,d;const a=v(o);a==v(t)?n(e,...o,...r(o)):s(t[a])?h(null!=(d=null==(u=l[a])?void 0:u.call(l,...o))?d:[],(e=>i(...o,e))):i(...o,t[a])};i()}))]})(),[y,O,W,$,q,B,G,,H,J,K,P]=((e,t,l,r,i)=>{const o=e.hasRow,u=S(),c=S(),f=S(),g=S(),M=S(),L=S(),m=(n,t,...l)=>{const r=A(L,n,j);return h(l,(n=>C(r,n)&&t&&e.callListener(n))),l},w=(n,...t)=>d(T(L,n),(l=>{h(0==v(t)?I(l):t,(n=>{e.delListener(n),R(l,n)})),b(l)&&z(L,n)})),y=(e,n)=>{z(u,e,n),p(c,e)||(z(c,e,t()),z(g,e,S()),z(M,e,S()),i(f))},D=e=>{z(u,e),z(c,e),z(g,e),z(M,e),w(e),i(f)};return[()=>e,()=>{return[...null!=(n=null==(e=u)?void 0:e.keys())?n:[]];var e,n},e=>k(c,e),e=>p(c,e),e=>T(u,e),e=>T(c,e),(e,n)=>z(c,e,n),y,(t,l,r,i,u)=>{y(t,l);const d=S(),c=S(),f=T(g,t),L=T(M,t),b=t=>{const r=n=>e.getCell(l,t,n),h=T(f,t),g=o(l,t)?(M=i(r,t),isNaN(M)||s(M)||!0===M||!1===M||M===n?void 0:1*M):void 0;var M,m,w,y;if(h===g||a(h)&&a(g)&&(w=g,v(m=h)===v(w)&&(y=(e,n)=>w[n]===e,m.every(y)))||z(d,t,[h,g]),!s(u)){const e=T(L,t),n=o(l,t)?u(r,t):void 0;e!=n&&z(c,t,n)}},I=e=>{r((()=>{E(d,(([,e],n)=>z(f,n,e))),E(c,((e,n)=>z(L,n,e)))}),d,c,f,L,e),x(d),x(c)};k(f,b),e.hasTable(l)&&h(e.getRowIds(l),(e=>{p(f,e)||b(e)})),I(!0),w(t),m(t,0,e.addRowListener(l,null,((e,n,t)=>b(t))),e.addTableListener(l,(()=>I())))},D,e=>r(e,f),()=>k(L,D),m,w]})(r,c,0,o,f),Q={setMetricDefinition:(n,r,o,d,a,v,c)=>{var h;const g=e(o)==l?[o,a,v,c]:null!=(h=T(N,o))?h:T(N,"sum");return H(n,r,((e,t,l,r,o,d)=>{const a=B(n),v=m(r);d||(d=s(a)),e();let c=((e,n,t,l,r,i=!1)=>{if(b(t))return;const[o,u,d,a]=r;return i||(i=s(e)),E(l,(([t,l])=>{i||(e=s(t)?null==u?void 0:u(e,l,n++):s(l)?null==d?void 0:d(e,t,n--):null==a?void 0:a(e,l,t,n),i||(i=s(e)))})),i?o(I(t),m(t)):e})(a,v,r,t,g,d);u(c)||(c=void 0),c!=a&&(G(n,c),f(i,[n],c,a))}),e(M=d)==t?e=>e(M):null!=M?M:()=>1),Q;var M},delMetricDefinition:e=>(J(e),Q),getStore:y,getMetricIds:O,forEachMetric:W,hasMetric:$,getTableId:q,getMetric:B,addMetricIdsListener:K,addMetricListener:(e,n)=>o(n,i,[e]),delListener:e=>(g(e),Q),destroy:P,getListenerStats:()=>({metric:w(i)})};return L(Q)})(i)),r.get(i))})();export{O as createMetrics};
