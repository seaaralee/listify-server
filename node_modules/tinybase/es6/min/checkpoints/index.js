const e=e=>null==e,n=(n,l,t)=>e(n)?void 0:l(n),l=e=>e.length,t=(e,n)=>e.includes(n),r=(e,n)=>e.forEach(n),o=e=>0==l(e),s=(e,...n)=>e.push(...n),u=e=>e.pop(),i=e=>e.shift(),c=Object.freeze,d=e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0},a=(v=d,e=>{return n=(e,n)=>e+v(n),g(e).reduce(n,0);var n});var v;const h=(e,n)=>{var l;return null!=(l=null==e?void 0:e.has(n))&&l},p=n=>e(n)||0==d(n),g=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},k=(e,n)=>null==e?void 0:e.forEach(n),C=(e,n)=>null==e?void 0:e.delete(n),f=e=>new Map(e),L=(e,n)=>null==e?void 0:e.get(n),w=(n,l,t)=>e(t)?(C(n,l),n):null==n?void 0:n.set(l,t),S=(e,n,l,t)=>(h(e,n)?null==t||t(L(e,n)):w(e,n,l()),L(e,n)),y=(e,t,r,o,s=0)=>n((r?S:L)(e,t[s],s>l(t)-2?r:f),(n=>{if(s>l(t)-2)return(null==o?void 0:o(n))&&w(e,t[s]),n;const u=y(n,t,r,o,s+1);return p(n)&&w(e,t[s]),u})),z=n=>new Set(Array.isArray(n)||e(n)?n:[n]),E=/^\d+$/,I=((d,v)=>{const g=new WeakMap;return d=>{g.has(d)||g.set(d,(d=>{let v,g,I,V=100,A=f(),F=f(),M=1;const _=f(),b=f(),[j,x,B]=(()=>{let t;const[o,u]=(()=>{const e=[];let n=0;return[l=>{var t;return null!=(t=l?i(e):null)?t:""+n++},n=>{E.test(n)&&l(e)<1e3&&s(e,n)}]})(),c=f();return[(e,n,l,r=[],s=()=>[])=>{null!=t||(t=ee);const u=o(1);var i,d;return w(c,u,[e,n,l,r,s]),d=u,null==(i=y(n,null!=l?l:[""],z))||i.add(d),u},(e,n,...o)=>r(((e,n=[""])=>{const t=[],o=(e,u)=>u==l(n)?s(t,e):null===n[u]?k(e,(e=>o(e,u+1))):r([n[u],null],(n=>o(L(e,n),u+1)));return o(e,0),t})(e,n),(e=>k(e,(e=>L(c,e)[0](t,...null!=n?n:[],...o))))),e=>n(L(c,e),(([,n,l])=>(y(n,null!=l?l:[""],void 0,(n=>(C(n,e),p(n)?1:0))),w(c,e),u(e),l))),o=>n(L(c,o),(([n,,o=[],s,u])=>{const i=(...c)=>{var d,a;const v=l(c);v==l(o)?n(t,...c,...u(c)):e(o[v])?r(null!=(a=null==(d=s[v])?void 0:d.call(s,...c))?a:[],(e=>i(...c,e))):i(...c,o[v])};i()}))]})(),O=f(),T=f(),W=[],$=[],m=(n,l)=>{M=0,d.transaction((()=>{const[t,r]=L(O,l);k(t,((l,t)=>k(l,((l,r)=>k(l,((l,o)=>((n,l,t,r,o)=>e(o)?n.delCell(l,t,r,!0):n.setCell(l,t,r,o))(d,t,r,o,l[n]))))))),k(r,((l,t)=>((n,l,t)=>e(t)?n.delValue(l):n.setValue(l,t))(d,t,l[n])))})),M=1},q=e=>{w(O,e),w(T,e),x(b,[e])},D=(e,n)=>r(((e,n)=>e.splice(0,n))(e,null!=n?n:l(e)),q),G=()=>D(W,l(W)-V),H=()=>n(v,(()=>{s(W,v),G(),D($),v=void 0,I=1})),J=()=>{v=u(W),I=1};let K,N;const P=(n="")=>(e(v)&&(v=""+g++,w(O,v,[A,F]),Y(v,n),A=f(),F=f(),I=1),v),Q=()=>{o(W)||(((e,...n)=>{e.unshift(...n)})($,P()),m(0,v),v=u(W),I=1)},R=()=>{o($)||(s(W,v),v=i($),m(1,v),I=1)},U=()=>{I&&(x(_),I=0)},X=e=>{const n=P(e);return U(),n},Y=(e,n)=>(Z(e)&&L(T,e)!==n&&(w(T,e,n),x(b,[e])),ee),Z=e=>h(O,e),ee={setSize:e=>(V=e,G(),ee),addCheckpoint:X,setCheckpoint:Y,getStore:()=>d,getCheckpointIds:()=>[[...W],v,[...$]],forEachCheckpoint:e=>{return n=e,k(T,((e,l)=>n(l,e)));var n},hasCheckpoint:Z,getCheckpoint:e=>L(T,e),goBackward:()=>(Q(),U(),ee),goForward:()=>(R(),U(),ee),goTo:n=>{const l=t(W,n)?Q:t($,n)?R:null;for(;!e(l)&&n!=v;)l();return U(),ee},addCheckpointIdsListener:e=>j(e,_),addCheckpointListener:(e,n)=>j(n,b,[e]),delListener:e=>(B(e),ee),clear:()=>(D(W),D($),e(v)||q(v),v=void 0,g=0,X(),ee),clearForward:()=>(o($)||(D($),x(_)),ee),destroy:()=>{d.delListener(K),d.delListener(N)},getListenerStats:()=>({checkpointIds:a(_),checkpoint:a(b)}),_registerListeners:()=>{K=d.addCellListener(null,null,null,((e,n,l,t,r,o)=>{if(M){H();const e=S(A,n,f),s=S(e,l,f),u=S(s,t,(()=>[o,void 0]));u[1]=r,u[0]===r&&p(w(s,t))&&p(w(e,l))&&p(w(A,n))&&J(),U()}})),N=d.addValueListener(null,((e,n,l,t)=>{if(M){H();const e=S(F,n,(()=>[t,void 0]));e[1]=l,e[0]===l&&p(w(F,n))&&J(),U()}}))}};return c(ee.clear())})(d));const I=g.get(d);return null==v||v(I),I}})(0,(e=>e._registerListeners()));export{I as createCheckpoints};
