"use strict";var t=require("yjs");const e="t",n="v",a=t=>null==t,s=(t,e,n)=>a(t)?n?.():e(t),r=t=>Array.isArray(t),o=t=>t.length,i=t=>{throw Error(t)},c=(t,e)=>t.forEach(e),l=(t,...e)=>t.push(...e),g=t=>t.shift(),u=Object,d=t=>u.getPrototypeOf(t),y=u.entries,p=u.keys,h=u.freeze,v=(t=[])=>u.fromEntries(t),w=(t,e)=>e in t,S=(t,e)=>((t,e)=>t.map(e))(y(t),(([t,n])=>e(n,t))),f=t=>(t=>!a(t)&&s(d(t),(t=>t==u.prototype||a(d(t))),(()=>!0)))(t)&&0==(t=>o(p(t)))(t),C=(t,e,n)=>(w(t,e)||(t[e]=n()),t[e]),b=t=>a(t)||0==(t=>t?.size??0)(t),M=(t,e)=>t?.forEach(e),A=(t,e)=>t?.delete(e),O=t=>new Map(t),L=(t,e)=>t?.get(e),J=(t,e)=>M(t,((t,n)=>e(n,t))),N=(t,e,n)=>a(n)?(A(t,e),t):t?.set(e,n),z=(t,e,n,a)=>{var s,r;return s=t,r=e,s?.has(r)?a?.(L(t,e)):N(t,e,n()),L(t,e)},D=(t,e,n,a,r=0)=>s((n?z:L)(t,e[r],r>o(e)-2?n:O),(s=>{if(r>o(e)-2)return a?.(s)&&N(t,e[r]),s;const i=D(s,e,n,a,r+1);return b(s)&&N(t,e[r]),i})),E=t=>new Set(r(t)||a(t)?t:[t]),j=/^\d+$/,P=O(),T=O(),k=(t,e,n,u,d,y,p,v={},w=0,S=[])=>{let C,J,k,m=0,Y=0,q=0;z(P,S,(()=>0)),z(T,S,(()=>[]));const x=O(),[F,$,B,G,H]=((t=1,e,n)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!n),([[t],[e]])=>!f(t)||!f(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!f(t)||!f(e),e.setContent]:i("Store type not supported by this Persister"))(p,t,w),[I,K,Q]=(()=>{let t;const[e,n]=(()=>{const t=[];let e=0;return[n=>(n?g(t):null)??""+e++,e=>{j.test(e)&&o(t)<1e3&&l(t,e)}]})(),r=O();return[(n,a,s,o=[],i=()=>[])=>{t??=tt;const c=e(1);var l,g;return N(r,c,[n,a,s,o,i]),l=D(a,s??[""],E),g=c,l?.add(g),c},(e,n,...a)=>c(((t,e=[""])=>{const n=[],a=(t,s)=>s==o(e)?l(n,t):null===e[s]?M(t,(t=>a(t,s+1))):c([e[s],null],(e=>a(L(t,e),s+1)));return a(t,0),n})(e,n),(e=>M(e,(e=>L(r,e)[0](t,...n??[],...a))))),t=>s(L(r,t),(([,e,a])=>(D(e,a??[""],void 0,(e=>(A(e,t),b(e)?1:0))),N(r,t),n(t),a))),e=>s(L(r,e),(([e,,n=[],s,r])=>{const i=(...l)=>{const g=o(l);g==o(n)?e(t,...l,...r(l)):a(n[g])?c(s[g]?.(...l)??[],(t=>i(...l,t))):i(...l,n[g])};i()}))]})(),R=t=>{t!=m&&(m=t,K(x,void 0,m))},U=e=>{(F&&r(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},V=async t=>(2!=m&&(R(1),Y++,await _((async()=>{try{const n=await e();r(n)?U(n):t?H(t):i("Content is not an array: "+n)}catch(e){y?.(e),t&&H(t)}R(0)}))),tt),W=()=>(J&&(d(J),J=void 0),tt),X=async t=>(1!=m&&(R(2),q++,await _((async()=>{try{await n($,t)}catch(t){y?.(t)}R(0)}))),tt),Z=()=>(k&&(t.delListener(k),k=void 0),tt),_=async(...t)=>(l(L(T,S),...t),await(async()=>{if(!L(P,S)){for(N(P,S,1);!a(C=g(L(T,S)));)try{await C()}catch(t){y?.(t)}N(P,S,0)}})(),tt),tt={load:V,startAutoLoad:async t=>{W(),await V(t);try{J=await u((async(t,e)=>{e||t?2!=m&&(R(1),Y++,U(e??t),R(0)):await V()}))}catch(t){y?.(t)}return tt},stopAutoLoad:W,isAutoLoading:()=>!a(J),save:X,startAutoSave:async()=>(Z(),await X(),k=t.addDidFinishTransactionListener((()=>{const t=B();G(t)&&X(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!a(k),getStatus:()=>m,addStatusListener:t=>I(t,x),delListener:e=>(Q(e),t),schedule:_,getStore:()=>t,destroy:()=>(L(T,S).splice(0,void 0),W().stopAutoSave()),getStats:()=>({loads:Y,saves:q}),...v};return h(tt)},m="delete",Y=t=>[t.get(e),t.get(n)],q=(e,n,s,r)=>{const o=a(n)?e:e.get(n)??e.set(n,new t.Map);let i;return S(s,((t,e)=>{r(o,e,t)&&(i=1)})),o.forEach(((t,e)=>{w(s,e)||(o.delete(e),i=1)})),a(n)||o.size||e.delete(n),i};exports.createYjsPersister=(r,i,l="tinybase",u)=>{const d=i.getMap(l);return k(r,(async()=>d.size?[d.get(e).toJSON(),d.get(n).toJSON()]:void 0),(async(r,o)=>i.transact((()=>((r,o,i)=>{r.size||(r.set(e,new t.Map),r.set(n,new t.Map));const[c,l]=Y(r),g=()=>{u=1};let u=1;if(s(i,(([t,e])=>{u=0,S(t,((t,e)=>u?0:a(t)?c.delete(e):s(c.get(e),(e=>S(t,((t,n)=>u?0:a(t)?e.delete(n):s(e.get(n),(e=>S(t,((t,n)=>a(t)?e.delete(n):e.set(n,t)))),g)))),g))),S(e,((t,e)=>u?0:a(t)?l.delete(e):l.set(e,t)))})),u){const[t,e]=o();q(c,void 0,t,((t,e,n)=>q(c,e,n,((t,e,n)=>q(t,e,n,((t,e,n)=>{if(t.get(e)!==n)return t.set(e,n),1})))))),q(l,void 0,e,((t,e,n)=>{l.get(e)!==n&&l.set(e,n)}))}})(d,r,o)))),(t=>{const a=a=>t(void 0,((t,a)=>{if(1==o(a)&&(r=a[0].path,0==o(r)))return[t.get(e).toJSON(),t.get(n).toJSON(),1];var r;const[i,l]=Y(t),u={},d={};return c(a,(({path:t,changes:{keys:n}})=>g(t)==e?s(g(t),(e=>{const a=C(u,e,v),r=i.get(e);s(g(t),(t=>{const e=C(a,t,v),s=r.get(t);J(n,((t,{action:n})=>e[t]=n==m?null:s.get(t)))}),(()=>J(n,((t,{action:e})=>a[t]=e==m?null:r.get(t)?.toJSON()))))}),(()=>J(n,((t,{action:e})=>u[t]=e==m?null:i.get(t)?.toJSON())))):J(n,((t,{action:e})=>d[t]=e==m?null:l.get(t))))),[u,d,1]})(d,a));return d.observeDeep(a),a}),(t=>{d.unobserveDeep(t)}),u,1,{getYDoc:()=>i})};
