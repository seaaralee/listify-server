"use strict";const e=e=>typeof e,t="",n=e(t),l=e(e),r=Math,i=r.max,u=r.min,o=isFinite,s=e=>null==e,d=(e,t,n)=>s(e)?void 0:t(e),a=e=>Array.isArray(e),c=e=>e.length,v=()=>{},h=(e,t)=>e.forEach(t),M=e=>f(e,((e,t)=>e+t),0),f=(e,t,n)=>e.reduce(t,n),g=(e,...t)=>e.push(...t),L=Object.freeze,m=e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0},w=(y=m,e=>f(I(e),((e,t)=>e+y(t)),0));var y;const p=(e,t)=>{var n;return null!=(n=null==e?void 0:e.has(t))&&n},b=e=>s(e)||0==m(e),I=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},x=e=>e.clear(),E=(e,t)=>null==e?void 0:e.forEach(t),R=(e,t)=>null==e?void 0:e.delete(t),S=e=>new Map(e),T=(e,t)=>null==e?void 0:e.get(t),k=(e,t)=>E(e,((e,n)=>t(n,e))),z=(e,t,n)=>s(n)?(R(e,t),e):null==e?void 0:e.set(t,n),A=(e,t,n,l)=>(p(e,t)?null==l||l(T(e,t)):z(e,t,n()),T(e,t)),D=(e,t,n,l,r=0)=>d((n?A:T)(e,t[r],r>c(t)-2?n:S),(i=>{if(r>c(t)-2)return(null==l?void 0:l(i))&&z(e,t[r]),i;const u=D(i,t,n,l,r+1);return b(i)&&z(e,t[r]),u})),N=S([["avg",[(e,t)=>M(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,l)=>e+(t-n)/l]],["max",[e=>i(...e),(e,t)=>i(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:i(t,e)]],["min",[e=>u(...e),(e,t)=>u(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:u(t,e)]],["sum",[e=>M(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),j=e=>new Set(a(e)||s(e)?e:[e]),C=(e,t)=>null==e?void 0:e.add(t),F=/^\d+$/,O=(()=>{const r=new WeakMap;return i=>(r.has(i)||r.set(i,(r=>{const i=S(),[u,M,f]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var r;return null!=(r=l?e.shift():null)?r:t+n++},t=>{F.test(t)&&c(e)<1e3&&g(e,t)}]})(),r=S();return[(l,i,u,o=[],s=()=>[])=>{null!=e||(e=Q);const d=n(1);return z(r,d,[l,i,u,o,s]),C(D(i,null!=u?u:[t],j),d),d},(n,l,...i)=>h(((e,n=[t])=>{const l=[],r=(e,t)=>t==c(n)?g(l,e):null===n[t]?E(e,(e=>r(e,t+1))):h([n[t],null],(n=>r(T(e,n),t+1)));return r(e,0),l})(n,l),(t=>E(t,(t=>T(r,t)[0](e,...null!=l?l:[],...i))))),e=>d(T(r,e),(([,n,i])=>(D(n,null!=i?i:[t],void 0,(t=>(R(t,e),b(t)?1:0))),z(r,e),l(e),i))),t=>d(T(r,t),(([t,,n=[],l,r])=>{const i=(...u)=>{var o,d;const a=c(u);a==c(n)?t(e,...u,...r(u)):s(n[a])?h(null!=(d=null==(o=l[a])?void 0:o.call(l,...u))?d:[],(e=>i(...u,e))):i(...u,n[a])};i()}))]})(),[y,O,W,$,q,B,G,,H,J,K,P]=((e,n,l,r,i)=>{const u=e.hasRow,o=S(),v=S(),M=S(),f=S(),g=S(),L=S(),m=(t,n,...l)=>{const r=A(L,t,j);return h(l,(t=>C(r,t)&&n&&e.callListener(t))),l},w=(t,...n)=>d(T(L,t),(l=>{h(0==c(n)?I(l):n,(t=>{e.delListener(t),R(l,t)})),b(l)&&z(L,t)})),y=(e,t)=>{z(o,e,t),p(v,e)||(z(v,e,n()),z(f,e,S()),z(g,e,S()),i(M))},D=e=>{z(o,e),z(v,e),z(f,e),z(g,e),w(e),i(M)};return[()=>e,()=>{return[...null!=(t=null==(e=o)?void 0:e.keys())?t:[]];var e,t},e=>k(v,e),e=>p(v,e),e=>T(o,e),e=>T(v,e),(e,t)=>z(v,e,t),y,(n,l,r,i,o)=>{y(n,l);const d=S(),v=S(),M=T(f,n),L=T(g,n),b=n=>{const r=t=>e.getCell(l,n,t),h=T(M,n),f=u(l,n)?(g=i(r,n),isNaN(g)||s(g)||!0===g||!1===g||g===t?void 0:1*g):void 0;var g,m,w,y;if(h===f||a(h)&&a(f)&&(w=f,c(m=h)===c(w)&&(y=(e,t)=>w[t]===e,m.every(y)))||z(d,n,[h,f]),!s(o)){const e=T(L,n),t=u(l,n)?o(r,n):void 0;e!=t&&z(v,n,t)}},I=e=>{r((()=>{E(d,(([,e],t)=>z(M,t,e))),E(v,((e,t)=>z(L,t,e)))}),d,v,M,L,e),x(d),x(v)};k(M,b),e.hasTable(l)&&h(e.getRowIds(l),(e=>{p(M,e)||b(e)})),I(!0),w(n),m(n,0,e.addRowListener(l,null,((e,t,n)=>b(n))),e.addTableListener(l,(()=>I())))},D,e=>r(e,M),()=>k(L,D),m,w]})(r,v,0,u,M),Q={setMetricDefinition:(t,r,u,d,a,c,v)=>{var h;const f=e(u)==l?[u,a,c,v]:null!=(h=T(N,u))?h:T(N,"sum");return H(t,r,((e,n,l,r,u,d)=>{const a=B(t),c=m(r);d||(d=s(a)),e();let v=((e,t,n,l,r,i=!1)=>{if(b(n))return;const[u,o,d,a]=r;return i||(i=s(e)),E(l,(([n,l])=>{i||(e=s(n)?null==o?void 0:o(e,l,t++):s(l)?null==d?void 0:d(e,n,t--):null==a?void 0:a(e,l,n,t),i||(i=s(e)))})),i?u(I(n),m(n)):e})(a,c,r,n,f,d);o(v)||(v=void 0),v!=a&&(G(t,v),M(i,[t],v,a))}),e(g=d)==n?e=>e(g):null!=g?g:()=>1),Q;var g},delMetricDefinition:e=>(J(e),Q),getStore:y,getMetricIds:O,forEachMetric:W,hasMetric:$,getTableId:q,getMetric:B,addMetricIdsListener:K,addMetricListener:(e,t)=>u(t,i,[e]),delListener:e=>(f(e),Q),destroy:P,getListenerStats:()=>({metric:w(i)})};return L(Q)})(i)),r.get(i))})();exports.createMetrics=O;
