"use strict";var e=require("expo-sqlite");const n=e=>typeof e,t="tinybase",l="",r=",",o=n(l),i=Promise,u=clearInterval,a=e=>null==e,d=(e,n,t)=>a(e)?null==t?void 0:t():n(e),s=e=>n(e)==o,c=e=>Array.isArray(e),v=(e,n,t)=>e.slice(n,t),y=e=>e.length,f=e=>{return n=function*(){return i.all(e)},new Promise(((e,t)=>{var l=e=>{try{o(n.next(e))}catch(e){t(e)}},r=e=>{try{o(n.throw(e))}catch(e){t(e)}},o=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,r);o((n=n.apply(void 0,null)).next())}));var n},p=e=>{throw Error(e)},h=(e,n)=>e.forEach(n),m=(e,n="")=>e.join(n),E=(e,n)=>e.map(n),g=e=>0==y(e),b=(e,n)=>e.filter(n),A=(e,...n)=>e.push(...n),P=e=>e.shift(),O="_",w="_id",N="SELECT",S="WHERE",$="TABLE",x="ALTER "+$,C="DELETE FROM",T=N+"*FROM",I="pragma_",L="data_version",D="schema_version",R="pragma_table_",M=e=>`"${e.replace(/"/g,'""')}"`,_=(e,n=[1])=>m(E(e,(()=>"$"+n[0]++)),r),j=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},F=e=>a(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),U=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},q=(e,n)=>null==e?void 0:e.forEach(n),B=(e,n)=>null==e?void 0:e.delete(n),J=Object,Y=e=>J.getPrototypeOf(e),k=J.entries,z=J.keys,G=J.freeze,H=(e=[])=>J.fromEntries(e),K=(...e)=>J.assign({},...e),Q=(e,n)=>(delete e[n],e),V=(e,n)=>E(k(e),(([e,t])=>n(t,e))),W=e=>J.values(e),X=e=>y(z(e)),Z=e=>(e=>!a(e)&&d(Y(e),(e=>e==J.prototype||a(Y(e))),(()=>!0)))(e)&&0==X(e),ee=JSON.stringify,ne=JSON.parse,te=e=>new Map(e),le=(e,n)=>null==e?void 0:e.get(n),re=(e,n)=>{var t;return E([...null!=(t=null==e?void 0:e.entries())?t:[]],(([e,t])=>n(t,e)))},oe=(e,n,t)=>a(t)?(B(e,n),e):null==e?void 0:e.set(n,t),ie=(e,n,t,l)=>(j(e,n)?null==l||l(le(e,n)):oe(e,n,t()),le(e,n)),ue=(e,n,t,l,r=0)=>d((t?ie:le)(e,n[r],r>y(n)-2?t:te),(o=>{if(r>y(n)-2)return(null==l?void 0:l(o))&&oe(e,n[r]),o;const i=ue(o,n,t,l,r+1);return F(o)&&oe(e,n[r]),i})),ae=e=>new Set(c(e)||a(e)?e:[e]),de=(e,n)=>null==e?void 0:e.add(n),se=/^\d+$/;var ce=Object.defineProperty,ve=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,fe=Object.prototype.propertyIsEnumerable,pe=(e,n,t)=>n in e?ce(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,he=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const me=te(),Ee=te(),ge=(e,n,t,r,o,i,u,s={},v=0,f=[])=>{let m,E,g,b=0,O=0,w=0;ie(me,f,(()=>0)),ie(Ee,f,(()=>[]));const N=te(),[S,$,x,C,T]=((e=1,n,t)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!t),([[e],[n]])=>!Z(e)||!Z(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!Z(e)||!Z(n),n.setContent]:p("Store type not supported by this Persister"))(u,e,v),[I,L,D]=(()=>{let e;const[n,t]=(()=>{const e=[];let n=0;return[t=>{var r;return null!=(r=t?P(e):null)?r:l+n++},n=>{se.test(n)&&y(e)<1e3&&A(e,n)}]})(),r=te();return[(t,o,i,u=[],a=()=>[])=>{null!=e||(e=k);const d=n(1);return oe(r,d,[t,o,i,u,a]),de(ue(o,null!=i?i:[l],ae),d),d},(n,t,...o)=>h(((e,n=[l])=>{const t=[],r=(e,l)=>l==y(n)?A(t,e):null===n[l]?q(e,(e=>r(e,l+1))):h([n[l],null],(n=>r(le(e,n),l+1)));return r(e,0),t})(n,t),(n=>q(n,(n=>le(r,n)[0](e,...null!=t?t:[],...o))))),e=>d(le(r,e),(([,n,o])=>(ue(n,null!=o?o:[l],void 0,(n=>(B(n,e),F(n)?1:0))),oe(r,e),t(e),o))),n=>d(le(r,n),(([n,,t=[],l,r])=>{const o=(...i)=>{var u,d;const s=y(i);s==y(t)?n(e,...i,...r(i)):a(t[s])?h(null!=(d=null==(u=l[s])?void 0:u.call(l,...i))?d:[],(e=>o(...i,e))):o(...i,t[s])};o()}))]})(),R=e=>{e!=b&&(b=e,L(N,void 0,b))},M=n=>{(S&&c(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},_=e=>he(void 0,null,(function*(){return 2!=b&&(R(1),O++,yield Y((()=>he(void 0,null,(function*(){try{const t=yield n();c(t)?M(t):e?T(e):p("Content is not an array: "+t)}catch(n){null==i||i(n),e&&T(e)}R(0)}))))),k})),j=()=>(E&&(o(E),E=void 0),k),U=e=>he(void 0,null,(function*(){return 1!=b&&(R(2),w++,yield Y((()=>he(void 0,null,(function*(){try{yield t($,e)}catch(e){null==i||i(e)}R(0)}))))),k})),J=()=>(g&&(e.delListener(g),g=void 0),k),Y=(...e)=>he(void 0,null,(function*(){return A(le(Ee,f),...e),yield he(void 0,null,(function*(){if(!le(me,f)){for(oe(me,f,1);!a(m=P(le(Ee,f)));)try{yield m()}catch(e){null==i||i(e)}oe(me,f,0)}})),k})),k=((e,n)=>{for(var t in n||(n={}))ye.call(n,t)&&pe(e,t,n[t]);if(ve)for(var t of ve(n))fe.call(n,t)&&pe(e,t,n[t]);return e})({load:_,startAutoLoad:e=>he(void 0,null,(function*(){j(),yield _(e);try{E=yield r(((e,n)=>he(void 0,null,(function*(){n||e?2!=b&&(R(1),O++,M(null!=n?n:e),R(0)):yield _()}))))}catch(e){null==i||i(e)}return k})),stopAutoLoad:j,isAutoLoading:()=>!a(E),save:U,startAutoSave:()=>he(void 0,null,(function*(){return J(),yield U(),g=e.addDidFinishTransactionListener((()=>{const e=x();C(e)&&U(e)})),k})),stopAutoSave:J,isAutoSaving:()=>!a(g),getStatus:()=>b,addStatusListener:e=>I(e,N),delListener:n=>(D(n),e),schedule:Y,getStore:()=>e,destroy:()=>(le(Ee,f).splice(0,void 0),j().stopAutoSave()),getStats:()=>({loads:O,saves:w})},s);return G(k)};var be=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const Ae=(e,n,t,l,o,i=Pe,u,d)=>{const s=te();return[()=>be(void 0,null,(function*(){s.clear(),E(yield t(e,n),(({tn:e,cn:n})=>de(ie(s,e,ae),n)))})),(n,t)=>be(void 0,null,(function*(){return((e,n)=>j(le(s,e),n))(n,t)?H(b(E(yield e(T+M(n)),(e=>{return[e[t],d?(n=Q(e,t),l=d,H(V(n,((e,n)=>[n,l(e,n)])))):Q(e,t)];var n,l})),(([e,n])=>!a(e)&&!Z(n)))):{}})),(n,t,l,d,c,v=!1)=>be(void 0,null,(function*(){const y=ae();V(null!=l?l:{},(e=>E(z(null!=e?e:{}),(e=>de(y,e)))));const p=U(y);if(!v&&c&&g(p)&&j(s,n))return yield e("DROP "+$+M(n)),void oe(s,n);const h=le(s,n),P=ae(U(h));if(g(p)||(j(s,n)?yield f(E([t,...p],((l,r)=>be(void 0,null,(function*(){B(P,l)||(yield e(x+M(n)+"ADD"+M(l)+o),0==r&&(yield e("CREATE UNIQUE INDEX pk ON "+M(n)+`(${M(t)})`)),de(h,l))}))))):(yield e("CREATE "+$+M(n)+`(${M(t)}${o} PRIMARY KEY${m(E(p,(e=>r+M(e)+o)))});`),oe(s,n,ae([t,...p])))),yield f([...!v&&d?E(U(P),(l=>be(void 0,null,(function*(){l!=t&&(yield e(x+M(n)+"DROP"+M(l)),B(h,l))})))):[]]),v)a(l)?yield e(C+M(n)+S+" true"):yield f(V(l,((l,r)=>be(void 0,null,(function*(){a(l)?yield e(C+M(n)+S+M(t)+"=$1",[r]):g(p)||(yield i(e,n,t,z(l),{[r]:u?E(W(l),u):W(l)},h))})))));else if(g(p))j(s,n)&&(yield e(C+M(n)+S+" true"));else{const r=b(U(le(s,n)),(e=>e!=t)),o={},a=[];V(null!=l?l:{},((e,n)=>{o[n]=E(r,(n=>u?u(null==e?void 0:e[n]):null==e?void 0:e[n])),A(a,n)})),yield i(e,n,t,r,o),yield e(C+M(n)+S+M(t)+`NOT IN(${_(a)})`,a)}})),n=>be(void 0,null,(function*(){let t;yield e("BEGIN");try{t=yield n()}catch(e){null==l||l(e)}return yield e("END"),t}))]},Pe=(e,n,t,l,o)=>be(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+M(n)+"("+((...e)=>m(E(e,M),r))(t,...l)+")VALUES"+m(V(o,(e=>"($"+i[0]+++","+_(e,i)+")")),r)+"ON CONFLICT("+M(t)+")DO UPDATE SET"+m(E(l,(e=>M(e)+"=excluded."+M(e))),r),V(o,((e,n)=>[n,...E(e,(e=>null!=e?e:null))])).flat())}));var Oe=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const we=(e,n,t,l,r,o,i,[u,a,d],s,c,v,y,f,p)=>{const[h,m,E,g]=Ae(n,s,c,r,f,p),b=ge(e,(()=>Oe(void 0,null,(function*(){return yield g((()=>Oe(void 0,null,(function*(){var e,n,t;return yield h(),t=null!=(n=null==(e=(yield m(u,a))[O])?void 0:e[d])?n:"null",ne(t,((e,n)=>"ï¿¼"===n?void 0:n))}))))}))),(e=>Oe(void 0,null,(function*(){return yield g((()=>Oe(void 0,null,(function*(){var n,t;yield h(),yield E(u,a,{[O]:{[d]:(t=null!=(n=e())?n:null,ee(t,((e,n)=>void 0===n?"ï¿¼":n)))}},!0,!0)}))))}))),t,l,r,i,{[y]:()=>v,destroy:()=>(b.stopAutoLoad().stopAutoSave(),o(),b)},0,v);return b};var Ne=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const Se=(e,n,t,l,r,o,i,[u,d,[s,c,v]],y,p,h,m,E,g,A,P)=>{const[N,S,$,x]=Ae(n,y,p,r,E,g,A,P),C=(e,n)=>Ne(void 0,null,(function*(){return yield f(re(d,((t,l)=>Ne(void 0,[t,l],(function*([t,l,r,o],i){n&&!(i in e)||(yield $(t,l,e[i],r,o,n))})))))})),T=(e,n)=>Ne(void 0,null,(function*(){return c?yield $(v,w,{[O]:e},!0,!0,n):null})),I=ge(e,(()=>Ne(void 0,null,(function*(){return yield x((()=>Ne(void 0,null,(function*(){yield N();const e=yield Ne(void 0,null,(function*(){return H(b(yield f(re(u,((e,n)=>Ne(void 0,[e,n],(function*([e,n],t){return[e,yield S(t,n)]}))))),(e=>!Z(e[1]))))})),n=yield Ne(void 0,null,(function*(){return s?(yield S(v,w))[O]:{}}));return Z(e)&&a(n)?void 0:[e,n]}))))}))),((e,n)=>Ne(void 0,null,(function*(){return yield x((()=>Ne(void 0,null,(function*(){if(yield N(),a(n)){const[n,t]=e();yield C(n),yield T(t)}else yield C(n[0],!0),yield T(n[1],!0)}))))}))),t,l,r,i,{[m]:()=>h,destroy:()=>(I.stopAutoLoad().stopAutoSave(),o(),I)},0,h);return I},$e="ColumnName",xe="store",Ce="json",Te=xe+"TableName",Ie=xe+"Id"+$e,Le=xe+$e,De="autoLoadIntervalSeconds",Re="rowId"+$e,Me="tableId",_e="tableName",je="deleteEmptyColumns",Fe="deleteEmptyTable",Ue={mode:Ce,[De]:1},qe={load:0,save:0,[_e]:t+"_values"},Be=(e,n,t,l,r)=>{const o=te();return V(e,((e,i)=>{const u=v(W(K(n,s(e)?{[t]:e}:e)),0,X(n));a(u[0])||l(i,u[0])||(r(i,u[0]),oe(o,i,u))})),o};var Je=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const Ye=(e,n,r,o,i,a,d,c,y,f,p="getDb",h)=>{let m,E,g;const b=((e,n)=>n?(t,l)=>{return r=function*(){return n(t,l),yield e(t,l)},new Promise(((e,n)=>{var t=e=>{try{o(r.next(e))}catch(e){n(e)}},l=e=>{try{o(r.throw(e))}catch(e){n(e)}},o=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,l);o((r=r.apply(void 0,null)).next())}));var r}:e)(r,a),[A,P,O,$]=(e=>{var n,l,r;const o=(e=>K(Ue,s(e)?{[Te]:e}:null!=e?e:{}))(e),i=o[De];if(o.mode==Ce){const e=null!=(n=o[Te])?n:t;return[1,i,[e,null!=(l=o[Ie])?l:w,null!=(r=o[Le])?r:xe],ae(e)]}const{tables:{load:u={},save:a={}}={},values:d={}}=o,c=v(W(K(qe,d)),0,X(qe)),y=c[2],f=ae(y),p=ae(y);return[0,i,[Be(u,{[Me]:null,[Re]:w},Me,(e=>j(p,e)),(e=>de(f,e))),Be(a,{[_e]:null,[Re]:w,[je]:0,[Fe]:0},_e,((e,n)=>j(p,n)),((e,n)=>de(f,n))),c],f]})(n);return(A?we:Se)(e,b,(e=>{let n;const t=()=>n=setInterval((()=>Je(void 0,null,(function*(){try{const[{d:n,s:t,c:l}]=yield b(`${N} ${L} d,${D} s,TOTAL_CHANGES() c FROM ${I}${L} JOIN ${I}${D}`);n==m&&t==E&&l==g||(null!=m&&e(),m=n,E=t,g=l)}catch(e){}}))),1e3*P),l=()=>{m=E=g=null,u(n)},r=o((n=>{$.has(n)&&(l(),e(),t())}));return t(),()=>{l(),i(r)}}),(e=>e()),d,c,y,O,U($),((e,n)=>Je(void 0,null,(function*(){return yield e(`${N} t.name tn,c.name cn FROM ${R}list()t,${R}info(t.name)c ${S} t.schema='main'AND t.type IN('table','view')AND t.name IN(${_(n)})ORDER BY t.name,c.name`,n)}))),f,p,l,h,(e=>!0===e?1:!1===e?0:e),void 0)};exports.createExpoSqlitePersister=(n,t,l,r,o)=>Ye(n,l,((e,...n)=>{return l=[e,...n],r=function*(e,n=[]){return yield t.getAllAsync(e,n)},new Promise(((e,n)=>{var t=e=>{try{i(r.next(e))}catch(e){n(e)}},o=e=>{try{i(r.throw(e))}catch(e){n(e)}},i=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,o);i((r=r.apply(void 0,l)).next())}));var l,r}),(n=>e.addDatabaseChangeListener((({tableName:e})=>n(e)))),(e=>e.remove()),r,o,(()=>0),3,t);
