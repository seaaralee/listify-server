"use strict";const e=e=>typeof e,n="tinybase",t="",l=",",r=e(t),o=Promise,i=clearInterval,u=e=>null==e,a=(e,n,t)=>u(e)?null==t?void 0:t():n(e),d=n=>e(n)==r,s=e=>Array.isArray(e),c=(e,n,t)=>e.slice(n,t),v=e=>e.length,y=e=>{return n=function*(){return o.all(e)},new Promise(((e,t)=>{var l=e=>{try{o(n.next(e))}catch(e){t(e)}},r=e=>{try{o(n.throw(e))}catch(e){t(e)}},o=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,r);o((n=n.apply(void 0,null)).next())}));var n},p=e=>{throw Error(e)},f=(e,n)=>e.forEach(n),h=(e,n="")=>e.join(n),m=(e,n)=>e.map(n),b=e=>0==v(e),E=(e,n)=>e.filter(n),g=(e,...n)=>e.push(...n),O=e=>e.shift(),P="_",w="_id",A="SELECT",S="WHERE",N="TABLE",$="ALTER "+N,x="DELETE FROM",C=A+"*FROM",I="pragma_",T="data_version",L="schema_version",R="pragma_table_",D=e=>`"${e.replace(/"/g,'""')}"`,_=(e,n=[1])=>h(m(e,(()=>"$"+n[0]++)),l),j=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},M=e=>u(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),F=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},k=(e,n)=>null==e?void 0:e.forEach(n),U=(e,n)=>null==e?void 0:e.delete(n),q=Object,B=e=>q.getPrototypeOf(e),J=q.entries,Y=q.keys,z=q.freeze,G=(e=[])=>q.fromEntries(e),H=(...e)=>q.assign({},...e),V=(e,n)=>(delete e[n],e),W=(e,n)=>m(J(e),(([e,t])=>n(t,e))),K=e=>q.values(e),Q=e=>v(Y(e)),X=e=>(e=>!u(e)&&a(B(e),(e=>e==q.prototype||u(B(e))),(()=>!0)))(e)&&0==Q(e),Z=JSON.stringify,ee=JSON.parse,ne=e=>new Map(e),te=(e,n)=>null==e?void 0:e.get(n),le=(e,n)=>{var t;return m([...null!=(t=null==e?void 0:e.entries())?t:[]],(([e,t])=>n(t,e)))},re=(e,n,t)=>u(t)?(U(e,n),e):null==e?void 0:e.set(n,t),oe=(e,n,t,l)=>(j(e,n)?null==l||l(te(e,n)):re(e,n,t()),te(e,n)),ie=(e,n,t,l,r=0)=>a((t?oe:te)(e,n[r],r>v(n)-2?t:ne),(o=>{if(r>v(n)-2)return(null==l?void 0:l(o))&&re(e,n[r]),o;const i=ie(o,n,t,l,r+1);return M(o)&&re(e,n[r]),i})),ue=e=>new Set(s(e)||u(e)?e:[e]),ae=(e,n)=>null==e?void 0:e.add(n),de=/^\d+$/;var se=Object.defineProperty,ce=Object.getOwnPropertySymbols,ve=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable,pe=(e,n,t)=>n in e?se(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,fe=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const he=ne(),me=ne(),be=(e,n,l,r,o,i,d,c={},y=0,h=[])=>{let m,b,E,P=0,w=0,A=0;oe(he,h,(()=>0)),oe(me,h,(()=>[]));const S=ne(),[N,$,x,C,I]=((e=1,n,t)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!t),([[e],[n]])=>!X(e)||!X(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!X(e)||!X(n),n.setContent]:p("Store type not supported by this Persister"))(d,e,y),[T,L,R]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var r;return null!=(r=l?O(e):null)?r:t+n++},n=>{de.test(n)&&v(e)<1e3&&g(e,n)}]})(),r=ne();return[(l,o,i,u=[],a=()=>[])=>{null!=e||(e=Y);const d=n(1);return re(r,d,[l,o,i,u,a]),ae(ie(o,null!=i?i:[t],ue),d),d},(n,l,...o)=>f(((e,n=[t])=>{const l=[],r=(e,t)=>t==v(n)?g(l,e):null===n[t]?k(e,(e=>r(e,t+1))):f([n[t],null],(n=>r(te(e,n),t+1)));return r(e,0),l})(n,l),(n=>k(n,(n=>te(r,n)[0](e,...null!=l?l:[],...o))))),e=>a(te(r,e),(([,n,o])=>(ie(n,null!=o?o:[t],void 0,(n=>(U(n,e),M(n)?1:0))),re(r,e),l(e),o))),n=>a(te(r,n),(([n,,t=[],l,r])=>{const o=(...i)=>{var a,d;const s=v(i);s==v(t)?n(e,...i,...r(i)):u(t[s])?f(null!=(d=null==(a=l[s])?void 0:a.call(l,...i))?d:[],(e=>o(...i,e))):o(...i,t[s])};o()}))]})(),D=e=>{e!=P&&(P=e,L(S,void 0,P))},_=n=>{(N&&s(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},j=e=>fe(void 0,null,(function*(){return 2!=P&&(D(1),w++,yield J((()=>fe(void 0,null,(function*(){try{const t=yield n();s(t)?_(t):e?I(e):p("Content is not an array: "+t)}catch(n){null==i||i(n),e&&I(e)}D(0)}))))),Y})),F=()=>(b&&(o(b),b=void 0),Y),q=e=>fe(void 0,null,(function*(){return 1!=P&&(D(2),A++,yield J((()=>fe(void 0,null,(function*(){try{yield l($,e)}catch(e){null==i||i(e)}D(0)}))))),Y})),B=()=>(E&&(e.delListener(E),E=void 0),Y),J=(...e)=>fe(void 0,null,(function*(){return g(te(me,h),...e),yield fe(void 0,null,(function*(){if(!te(he,h)){for(re(he,h,1);!u(m=O(te(me,h)));)try{yield m()}catch(e){null==i||i(e)}re(he,h,0)}})),Y})),Y=((e,n)=>{for(var t in n||(n={}))ve.call(n,t)&&pe(e,t,n[t]);if(ce)for(var t of ce(n))ye.call(n,t)&&pe(e,t,n[t]);return e})({load:j,startAutoLoad:e=>fe(void 0,null,(function*(){F(),yield j(e);try{b=yield r(((e,n)=>fe(void 0,null,(function*(){n||e?2!=P&&(D(1),w++,_(null!=n?n:e),D(0)):yield j()}))))}catch(e){null==i||i(e)}return Y})),stopAutoLoad:F,isAutoLoading:()=>!u(b),save:q,startAutoSave:()=>fe(void 0,null,(function*(){return B(),yield q(),E=e.addDidFinishTransactionListener((()=>{const e=x();C(e)&&q(e)})),Y})),stopAutoSave:B,isAutoSaving:()=>!u(E),getStatus:()=>P,addStatusListener:e=>T(e,S),delListener:n=>(R(n),e),schedule:J,getStore:()=>e,destroy:()=>(te(me,h).splice(0,void 0),F().stopAutoSave()),getStats:()=>({loads:w,saves:A})},c);return z(Y)};var Ee=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const ge=(e,n,t,r,o,i=Oe,a,d)=>{const s=ne();return[()=>Ee(void 0,null,(function*(){s.clear(),m(yield t(e,n),(({tn:e,cn:n})=>ae(oe(s,e,ue),n)))})),(n,t)=>Ee(void 0,null,(function*(){return((e,n)=>j(te(s,e),n))(n,t)?G(E(m(yield e(C+D(n)),(e=>{return[e[t],d?(n=V(e,t),l=d,G(W(n,((e,n)=>[n,l(e,n)])))):V(e,t)];var n,l})),(([e,n])=>!u(e)&&!X(n)))):{}})),(n,t,r,d,c,v=!1)=>Ee(void 0,null,(function*(){const p=ue();W(null!=r?r:{},(e=>m(Y(null!=e?e:{}),(e=>ae(p,e)))));const f=F(p);if(!v&&c&&b(f)&&j(s,n))return yield e("DROP "+N+D(n)),void re(s,n);const O=te(s,n),P=ue(F(O));if(b(f)||(j(s,n)?yield y(m([t,...f],((l,r)=>Ee(void 0,null,(function*(){U(P,l)||(yield e($+D(n)+"ADD"+D(l)+o),0==r&&(yield e("CREATE UNIQUE INDEX pk ON "+D(n)+`(${D(t)})`)),ae(O,l))}))))):(yield e("CREATE "+N+D(n)+`(${D(t)}${o} PRIMARY KEY${h(m(f,(e=>l+D(e)+o)))});`),re(s,n,ue([t,...f])))),yield y([...!v&&d?m(F(P),(l=>Ee(void 0,null,(function*(){l!=t&&(yield e($+D(n)+"DROP"+D(l)),U(O,l))})))):[]]),v)u(r)?yield e(x+D(n)+S+" true"):yield y(W(r,((l,r)=>Ee(void 0,null,(function*(){u(l)?yield e(x+D(n)+S+D(t)+"=$1",[r]):b(f)||(yield i(e,n,t,Y(l),{[r]:a?m(K(l),a):K(l)},O))})))));else if(b(f))j(s,n)&&(yield e(x+D(n)+S+" true"));else{const l=E(F(te(s,n)),(e=>e!=t)),o={},u=[];W(null!=r?r:{},((e,n)=>{o[n]=m(l,(n=>a?a(null==e?void 0:e[n]):null==e?void 0:e[n])),g(u,n)})),yield i(e,n,t,l,o),yield e(x+D(n)+S+D(t)+`NOT IN(${_(u)})`,u)}})),n=>Ee(void 0,null,(function*(){let t;yield e("BEGIN");try{t=yield n()}catch(e){null==r||r(e)}return yield e("END"),t}))]},Oe=(e,n,t,r,o)=>Ee(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+D(n)+"("+((...e)=>h(m(e,D),l))(t,...r)+")VALUES"+h(W(o,(e=>"($"+i[0]+++","+_(e,i)+")")),l)+"ON CONFLICT("+D(t)+")DO UPDATE SET"+h(m(r,(e=>D(e)+"=excluded."+D(e))),l),W(o,((e,n)=>[n,...m(e,(e=>null!=e?e:null))])).flat())}));var Pe=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const we=(e,n,t,l,r,o,i,[u,a,d],s,c,v,y,p,f)=>{const[h,m,b,E]=ge(n,s,c,r,p,f),g=be(e,(()=>Pe(void 0,null,(function*(){return yield E((()=>Pe(void 0,null,(function*(){var e,n,t;return yield h(),t=null!=(n=null==(e=(yield m(u,a))[P])?void 0:e[d])?n:"null",ee(t,((e,n)=>"ï¿¼"===n?void 0:n))}))))}))),(e=>Pe(void 0,null,(function*(){return yield E((()=>Pe(void 0,null,(function*(){var n,t;yield h(),yield b(u,a,{[P]:{[d]:(t=null!=(n=e())?n:null,Z(t,((e,n)=>void 0===n?"ï¿¼":n)))}},!0,!0)}))))}))),t,l,r,i,{[y]:()=>v,destroy:()=>(g.stopAutoLoad().stopAutoSave(),o(),g)},0,v);return g};var Ae=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const Se=(e,n,t,l,r,o,i,[a,d,[s,c,v]],p,f,h,m,b,g,O,A)=>{const[S,N,$,x]=ge(n,p,f,r,b,g,O,A),C=(e,n)=>Ae(void 0,null,(function*(){return yield y(le(d,((t,l)=>Ae(void 0,[t,l],(function*([t,l,r,o],i){n&&!(i in e)||(yield $(t,l,e[i],r,o,n))})))))})),I=(e,n)=>Ae(void 0,null,(function*(){return c?yield $(v,w,{[P]:e},!0,!0,n):null})),T=be(e,(()=>Ae(void 0,null,(function*(){return yield x((()=>Ae(void 0,null,(function*(){yield S();const e=yield Ae(void 0,null,(function*(){return G(E(yield y(le(a,((e,n)=>Ae(void 0,[e,n],(function*([e,n],t){return[e,yield N(t,n)]}))))),(e=>!X(e[1]))))})),n=yield Ae(void 0,null,(function*(){return s?(yield N(v,w))[P]:{}}));return X(e)&&u(n)?void 0:[e,n]}))))}))),((e,n)=>Ae(void 0,null,(function*(){return yield x((()=>Ae(void 0,null,(function*(){if(yield S(),u(n)){const[n,t]=e();yield C(n),yield I(t)}else yield C(n[0],!0),yield I(n[1],!0)}))))}))),t,l,r,i,{[m]:()=>h,destroy:()=>(T.stopAutoLoad().stopAutoSave(),o(),T)},0,h);return T},Ne="ColumnName",$e="store",xe="json",Ce=$e+"TableName",Ie=$e+"Id"+Ne,Te=$e+Ne,Le="autoLoadIntervalSeconds",Re="rowId"+Ne,De="tableId",_e="tableName",je="deleteEmptyColumns",Me="deleteEmptyTable",Fe={mode:xe,[Le]:1},ke={load:0,save:0,[_e]:n+"_values"},Ue=(e,n,t,l,r)=>{const o=ne();return W(e,((e,i)=>{const a=c(K(H(n,d(e)?{[t]:e}:e)),0,Q(n));u(a[0])||l(i,a[0])||(r(i,a[0]),re(o,i,a))})),o};var qe=(e,n,t)=>new Promise(((l,r)=>{var o=e=>{try{u(t.next(e))}catch(e){r(e)}},i=e=>{try{u(t.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((t=t.apply(e,n)).next())}));const Be=(e,l,r,o,u,a,s,v,y,p,f="getDb",h)=>{let m,b,E;const g=((e,n)=>n?(t,l)=>{return r=function*(){return n(t,l),yield e(t,l)},new Promise(((e,n)=>{var t=e=>{try{o(r.next(e))}catch(e){n(e)}},l=e=>{try{o(r.throw(e))}catch(e){n(e)}},o=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,l);o((r=r.apply(void 0,null)).next())}));var r}:e)(r,a),[O,P,N,$]=(e=>{var t,l,r;const o=(e=>H(Fe,d(e)?{[Ce]:e}:null!=e?e:{}))(e),i=o[Le];if(o.mode==xe){const e=null!=(t=o[Ce])?t:n;return[1,i,[e,null!=(l=o[Ie])?l:w,null!=(r=o[Te])?r:$e],ue(e)]}const{tables:{load:u={},save:a={}}={},values:s={}}=o,v=c(K(H(ke,s)),0,Q(ke)),y=v[2],p=ue(y),f=ue(y);return[0,i,[Ue(u,{[De]:null,[Re]:w},De,(e=>j(f,e)),(e=>ae(p,e))),Ue(a,{[_e]:null,[Re]:w,[je]:0,[Me]:0},_e,((e,n)=>j(f,n)),((e,n)=>ae(p,n))),v],p]})(l);return(O?we:Se)(e,g,(e=>{let n;const t=()=>n=setInterval((()=>qe(void 0,null,(function*(){try{const[{d:n,s:t,c:l}]=yield g(`${A} ${T} d,${L} s,TOTAL_CHANGES() c FROM ${I}${T} JOIN ${I}${L}`);n==m&&t==b&&l==E||(null!=m&&e(),m=n,b=t,E=l)}catch(e){}}))),1e3*P),l=()=>{m=b=E=null,i(n)},r=o((n=>{$.has(n)&&(l(),e(),t())}));return t(),()=>{l(),u(r)}}),(e=>e()),s,v,y,N,F($),((e,n)=>qe(void 0,null,(function*(){return yield e(`${A} t.name tn,c.name cn FROM ${R}list()t,${R}info(t.name)c ${S} t.schema='main'AND t.type IN('table','view')AND t.name IN(${_(n)})ORDER BY t.name,c.name`,n)}))),p,f,t,h,(e=>!0===e?1:!1===e?0:e),void 0)};var Je=Object.defineProperty,Ye=Object.getOwnPropertySymbols,ze=Object.prototype.hasOwnProperty,Ge=Object.prototype.propertyIsEnumerable,He=(e,n,t)=>n in e?Je(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;exports.createSqliteWasmPersister=(e,n,t,l,r,o)=>Be(e,l,((e,...n)=>{return l=[e,...n],r=function*(e,n=[]){return t.exec(e,{bind:n,rowMode:"object",returnValue:"resultRows"}).map((e=>((e,n)=>{for(var t in n||(n={}))ze.call(n,t)&&He(e,t,n[t]);if(Ye)for(var t of Ye(n))Ge.call(n,t)&&He(e,t,n[t]);return e})({},e)))},new Promise(((e,n)=>{var t=e=>{try{i(r.next(e))}catch(e){n(e)}},o=e=>{try{i(r.throw(e))}catch(e){n(e)}},i=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,o);i((r=r.apply(void 0,l)).next())}));var l,r}),(e=>n.capi.sqlite3_update_hook(t,((n,t,l,r)=>e(r)),0)),(()=>n.capi.sqlite3_update_hook(t,(()=>0),0)),r,o,(()=>0),3,t);
