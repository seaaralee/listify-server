"use strict";const e=e=>typeof e,n="tinybase",l="",t=",",o=e(l),r=Promise,i=clearInterval,u=e=>null==e,a=(e,n,l)=>u(e)?null==l?void 0:l():n(e),d=n=>e(n)==o,s=e=>Array.isArray(e),c=(e,n,l)=>e.slice(n,l),v=e=>e.length,y=e=>{return n=function*(){return r.all(e)},new Promise(((e,l)=>{var t=e=>{try{r(n.next(e))}catch(e){l(e)}},o=e=>{try{r(n.throw(e))}catch(e){l(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,o);r((n=n.apply(void 0,null)).next())}));var n},f=e=>{throw Error(e)},h=(e,n)=>e.forEach(n),p=(e,n="")=>e.join(n),m=(e,n)=>e.map(n),E=e=>0==v(e),g=(e,n)=>e.filter(n),b=(e,...n)=>e.push(...n),P=e=>e.shift(),w=Object,S=e=>w.getPrototypeOf(e),A=w.entries,O=w.keys,N=w.freeze,T=(e=[])=>w.fromEntries(e),C=(...e)=>w.assign({},...e),$=(e,n)=>(delete e[n],e),I=(e,n)=>m(A(e),(([e,l])=>n(l,e))),x=e=>w.values(e),L=e=>v(O(e)),R=e=>(e=>!u(e)&&a(S(e),(e=>e==w.prototype||u(S(e))),(()=>!0)))(e)&&0==L(e),D=e=>new Set(s(e)||u(e)?e:[e]),M=(e,n)=>null==e?void 0:e.add(n),_="_",j="_id",F="SELECT",U="WHERE",B="TABLE",H="ALTER "+B,J="DELETE FROM",Y=F+"*FROM",k="pragma_",z="data_version",G="schema_version",V="pragma_table_",W=e=>`"${e.replace(/"/g,'""')}"`,K=(...e)=>p(m(e,W),t),Q=(e,n=[1])=>p(m(e,(()=>"$"+n[0]++)),t),X=(e,n)=>{var l;return null!=(l=null==e?void 0:e.has(n))&&l},q=e=>u(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),Z=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},ee=(e,n)=>null==e?void 0:e.forEach(n),ne=(e,n)=>null==e?void 0:e.delete(n),le=JSON.stringify,te=JSON.parse,oe=e=>new Map(e),re=(e,n)=>null==e?void 0:e.get(n),ie=(e,n)=>{var l;return m([...null!=(l=null==e?void 0:e.entries())?l:[]],(([e,l])=>n(l,e)))},ue=(e,n,l)=>u(l)?(ne(e,n),e):null==e?void 0:e.set(n,l),ae=(e,n,l,t)=>(X(e,n)?null==t||t(re(e,n)):ue(e,n,l()),re(e,n)),de=(e,n,l,t,o=0)=>a((l?ae:re)(e,n[o],o>v(n)-2?l:oe),(r=>{if(o>v(n)-2)return(null==t?void 0:t(r))&&ue(e,n[o]),r;const i=de(r,n,l,t,o+1);return q(r)&&ue(e,n[o]),i})),se=/^\d+$/;var ce=Object.defineProperty,ve=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,fe=Object.prototype.propertyIsEnumerable,he=(e,n,l)=>n in e?ce(e,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[n]=l,pe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const me=oe(),Ee=oe(),ge=(e,n,t,o,r,i,d,c={},y=0,p=[])=>{let m,E,g,w=0,S=0,A=0;ae(me,p,(()=>0)),ae(Ee,p,(()=>[]));const O=oe(),[T,C,$,I,x]=((e=1,n,l)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!l),([[e],[n]])=>!R(e)||!R(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!R(e)||!R(n),n.setContent]:f("Store type not supported by this Persister"))(d,e,y),[L,_,j]=(()=>{let e;const[n,t]=(()=>{const e=[];let n=0;return[t=>{var o;return null!=(o=t?P(e):null)?o:l+n++},n=>{se.test(n)&&v(e)<1e3&&b(e,n)}]})(),o=oe();return[(t,r,i,u=[],a=()=>[])=>{null!=e||(e=z);const d=n(1);return ue(o,d,[t,r,i,u,a]),M(de(r,null!=i?i:[l],D),d),d},(n,t,...r)=>h(((e,n=[l])=>{const t=[],o=(e,l)=>l==v(n)?b(t,e):null===n[l]?ee(e,(e=>o(e,l+1))):h([n[l],null],(n=>o(re(e,n),l+1)));return o(e,0),t})(n,t),(n=>ee(n,(n=>re(o,n)[0](e,...null!=t?t:[],...r))))),e=>a(re(o,e),(([,n,r])=>(de(n,null!=r?r:[l],void 0,(n=>(ne(n,e),q(n)?1:0))),ue(o,e),t(e),r))),n=>a(re(o,n),(([n,,l=[],t,o])=>{const r=(...i)=>{var a,d;const s=v(i);s==v(l)?n(e,...i,...o(i)):u(l[s])?h(null!=(d=null==(a=t[s])?void 0:a.call(t,...i))?d:[],(e=>r(...i,e))):r(...i,l[s])};r()}))]})(),F=e=>{e!=w&&(w=e,_(O,void 0,w))},U=n=>{(T&&s(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},B=e=>pe(void 0,null,(function*(){return 2!=w&&(F(1),S++,yield k((()=>pe(void 0,null,(function*(){try{const l=yield n();s(l)?U(l):e?x(e):f("Content is not an array: "+l)}catch(n){null==i||i(n),e&&x(e)}F(0)}))))),z})),H=()=>(E&&(r(E),E=void 0),z),J=e=>pe(void 0,null,(function*(){return 1!=w&&(F(2),A++,yield k((()=>pe(void 0,null,(function*(){try{yield t(C,e)}catch(e){null==i||i(e)}F(0)}))))),z})),Y=()=>(g&&(e.delListener(g),g=void 0),z),k=(...e)=>pe(void 0,null,(function*(){return b(re(Ee,p),...e),yield pe(void 0,null,(function*(){if(!re(me,p)){for(ue(me,p,1);!u(m=P(re(Ee,p)));)try{yield m()}catch(e){null==i||i(e)}ue(me,p,0)}})),z})),z=((e,n)=>{for(var l in n||(n={}))ye.call(n,l)&&he(e,l,n[l]);if(ve)for(var l of ve(n))fe.call(n,l)&&he(e,l,n[l]);return e})({load:B,startAutoLoad:e=>pe(void 0,null,(function*(){H(),yield B(e);try{E=yield o(((e,n)=>pe(void 0,null,(function*(){n||e?2!=w&&(F(1),S++,U(null!=n?n:e),F(0)):yield B()}))))}catch(e){null==i||i(e)}return z})),stopAutoLoad:H,isAutoLoading:()=>!u(E),save:J,startAutoSave:()=>pe(void 0,null,(function*(){return Y(),yield J(),g=e.addDidFinishTransactionListener((()=>{const e=$();I(e)&&J(e)})),z})),stopAutoSave:Y,isAutoSaving:()=>!u(g),getStatus:()=>w,addStatusListener:e=>L(e,O),delListener:n=>(j(n),e),schedule:k,getStore:()=>e,destroy:()=>(re(Ee,p).splice(0,void 0),H().stopAutoSave()),getStats:()=>({loads:S,saves:A})},c);return N(z)};var be=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Pe=(e,n,l,o,r,i=we,a,d)=>{const s=oe();return[()=>be(void 0,null,(function*(){s.clear(),m(yield l(e,n),(({tn:e,cn:n})=>M(ae(s,e,D),n)))})),(n,l)=>be(void 0,null,(function*(){return((e,n)=>X(re(s,e),n))(n,l)?T(g(m(yield e(Y+W(n)),(e=>{return[e[l],d?(n=$(e,l),t=d,T(I(n,((e,n)=>[n,t(e,n)])))):$(e,l)];var n,t})),(([e,n])=>!u(e)&&!R(n)))):{}})),(n,l,o,d,c,v=!1)=>be(void 0,null,(function*(){const f=D();I(null!=o?o:{},(e=>m(O(null!=e?e:{}),(e=>M(f,e)))));const h=Z(f);if(!v&&c&&E(h)&&X(s,n))return yield e("DROP "+B+W(n)),void ue(s,n);const P=re(s,n),w=D(Z(P));if(E(h)||(X(s,n)?yield y(m([l,...h],((t,o)=>be(void 0,null,(function*(){ne(w,t)||(yield e(H+W(n)+"ADD"+W(t)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+W(n)+`(${W(l)})`)),M(P,t))}))))):(yield e("CREATE "+B+W(n)+`(${W(l)}${r} PRIMARY KEY${p(m(h,(e=>t+W(e)+r)))});`),ue(s,n,D([l,...h])))),yield y([...!v&&d?m(Z(w),(t=>be(void 0,null,(function*(){t!=l&&(yield e(H+W(n)+"DROP"+W(t)),ne(P,t))})))):[]]),v)u(o)?yield e(J+W(n)+U+" true"):yield y(I(o,((t,o)=>be(void 0,null,(function*(){u(t)?yield e(J+W(n)+U+W(l)+"=$1",[o]):E(h)||(yield i(e,n,l,O(t),{[o]:a?m(x(t),a):x(t)},P))})))));else if(E(h))X(s,n)&&(yield e(J+W(n)+U+" true"));else{const t=g(Z(re(s,n)),(e=>e!=l)),r={},u=[];I(null!=o?o:{},((e,n)=>{r[n]=m(t,(n=>a?a(null==e?void 0:e[n]):null==e?void 0:e[n])),b(u,n)})),yield i(e,n,l,t,r),yield e(J+W(n)+U+W(l)+`NOT IN(${Q(u)})`,u)}})),n=>be(void 0,null,(function*(){let l;yield e("BEGIN");try{l=yield n()}catch(e){null==o||o(e)}return yield e("END"),l}))]},we=(e,n,l,o,r)=>be(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+W(n)+"("+K(l,...o)+")VALUES"+p(I(r,(e=>"($"+i[0]+++","+Q(e,i)+")")),t)+"ON CONFLICT("+W(l)+")DO UPDATE SET"+p(m(o,(e=>W(e)+"=excluded."+W(e))),t),I(r,((e,n)=>[n,...m(e,(e=>null!=e?e:null))])).flat())}));var Se=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ae=(e,n,l,t,o,r,i,[u,a,d],s,c,v,y,f,h)=>{const[p,m,E,g]=Pe(n,s,c,o,f,h),b=ge(e,(()=>Se(void 0,null,(function*(){return yield g((()=>Se(void 0,null,(function*(){var e,n,l;return yield p(),l=null!=(n=null==(e=(yield m(u,a))[_])?void 0:e[d])?n:"null",te(l,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>Se(void 0,null,(function*(){return yield g((()=>Se(void 0,null,(function*(){var n,l;yield p(),yield E(u,a,{[_]:{[d]:(l=null!=(n=e())?n:null,le(l,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),l,t,o,i,{[y]:()=>v,destroy:()=>(b.stopAutoLoad().stopAutoSave(),r(),b)},0,v);return b};var Oe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ne=(e,n,l,t,o,r,i,[a,d,[s,c,v]],f,h,p,m,E,b,P,w)=>{const[S,A,O,N]=Pe(n,f,h,o,E,b,P,w),C=(e,n)=>Oe(void 0,null,(function*(){return yield y(ie(d,((l,t)=>Oe(void 0,[l,t],(function*([l,t,o,r],i){n&&!(i in e)||(yield O(l,t,e[i],o,r,n))})))))})),$=(e,n)=>Oe(void 0,null,(function*(){return c?yield O(v,j,{[_]:e},!0,!0,n):null})),I=ge(e,(()=>Oe(void 0,null,(function*(){return yield N((()=>Oe(void 0,null,(function*(){yield S();const e=yield Oe(void 0,null,(function*(){return T(g(yield y(ie(a,((e,n)=>Oe(void 0,[e,n],(function*([e,n],l){return[e,yield A(l,n)]}))))),(e=>!R(e[1]))))})),n=yield Oe(void 0,null,(function*(){return s?(yield A(v,j))[_]:{}}));return R(e)&&u(n)?void 0:[e,n]}))))}))),((e,n)=>Oe(void 0,null,(function*(){return yield N((()=>Oe(void 0,null,(function*(){if(yield S(),u(n)){const[n,l]=e();yield C(n),yield $(l)}else yield C(n[0],!0),yield $(n[1],!0)}))))}))),l,t,o,i,{[m]:()=>p,destroy:()=>(I.stopAutoLoad().stopAutoSave(),r(),I)},0,p);return I},Te="ColumnName",Ce="store",$e="json",Ie=Ce+"TableName",xe=Ce+"Id"+Te,Le=Ce+Te,Re="autoLoadIntervalSeconds",De="rowId"+Te,Me="tableId",_e="tableName",je="deleteEmptyColumns",Fe="deleteEmptyTable",Ue={mode:$e,[Re]:1},Be={load:0,save:0,[_e]:n+"_values"},He=(e,n,l,t,o)=>{const r=oe();return I(e,((e,i)=>{const a=c(x(C(n,d(e)?{[l]:e}:e)),0,L(n));u(a[0])||t(i,a[0])||(o(i,a[0]),ue(r,i,a))})),r};var Je=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ye=(e,t,o,r,u,a,s,v,y,f,h="getDb",p)=>{let m,E,g;const b=((e,n)=>n?(l,t)=>{return o=function*(){return n(l,t),yield e(l,t)},new Promise(((e,n)=>{var l=e=>{try{r(o.next(e))}catch(e){n(e)}},t=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,t);r((o=o.apply(void 0,null)).next())}));var o}:e)(o,a),[P,w,S,A]=(e=>{var l,t,o;const r=(e=>C(Ue,d(e)?{[Ie]:e}:null!=e?e:{}))(e),i=r[Re];if(r.mode==$e){const e=null!=(l=r[Ie])?l:n;return[1,i,[e,null!=(t=r[xe])?t:j,null!=(o=r[Le])?o:Ce],D(e)]}const{tables:{load:u={},save:a={}}={},values:s={}}=r,v=c(x(C(Be,s)),0,L(Be)),y=v[2],f=D(y),h=D(y);return[0,i,[He(u,{[Me]:null,[De]:j},Me,(e=>X(h,e)),(e=>M(f,e))),He(a,{[_e]:null,[De]:j,[je]:0,[Fe]:0},_e,((e,n)=>X(h,n)),((e,n)=>M(f,n))),v],f]})(t);return(P?Ae:Ne)(e,b,(e=>{let n;const l=()=>n=setInterval((()=>Je(void 0,null,(function*(){try{const[{d:n,s:l,c:t}]=yield b(`${F} ${z} d,${G} s,TOTAL_CHANGES() c FROM ${k}${z} JOIN ${k}${G}`);n==m&&l==E&&t==g||(null!=m&&e(),m=n,E=l,g=t)}catch(e){}}))),1e3*w),t=()=>{m=E=g=null,i(n)},o=r((n=>{A.has(n)&&(t(),e(),l())}));return l(),()=>{t(),u(o)}}),(e=>e()),s,v,y,S,Z(A),((e,n)=>Je(void 0,null,(function*(){return yield e(`${F} t.name tn,c.name cn FROM ${V}list()t,${V}info(t.name)c ${U} t.schema='main'AND t.type IN('table','view')AND t.name IN(${Q(n)})ORDER BY t.name,c.name`,n)}))),f,h,l,p,(e=>!0===e?1:!1===e?0:e),void 0)};var ke=(e,n)=>(n=Symbol[e])?n:Symbol.for("Symbol."+e),ze=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Ge=(e,n,l,o,r,i)=>ze(void 0,null,(function*(){const u=[1],a=D(o),d=i?g([...i],(e=>e!=l&&!X(a,e))):[];if(!E(d)){const t=O(r),o=T(m(yield e("SELECT"+K(l,...d)+"FROM"+W(n)+"WHERE"+W(l)+"IN("+Q(t)+")",t),(e=>[e[l],e])));h(t,(e=>b(r[e],...m(d,(n=>{var l,t;return null!=(t=null==(l=null==o?void 0:o[e])?void 0:l[n])?t:null})))))}yield e("INSERT OR REPLACE INTO"+W(n)+"("+K(l,...o,...d)+")VALUES"+p(I(r,(e=>"($"+u[0]+++","+Q(e,u)+")")),t),I(r,((e,n)=>[n,...m(e,(e=>null!=e?e:null))])).flat())}));exports.createPowerSyncPersister=(e,n,l,t,o)=>{let r;return Ye(e,l,((e,...l)=>ze(void 0,[e,...l],(function*(e,l=[]){return n.execute(e,l).then((e=>{var n,l;return null!=(l=null==(n=e.rows)?void 0:n._array)?l:[]}))}))),(e=>{const l=new AbortController,t=n.onChange({rawTableNames:!0,signal:l.signal});return ze(void 0,null,(function*(){try{for(var e,n,l,o=((e,n,l)=>(n=e[ke("asyncIterator")])?n.call(e):(e=e[ke("iterator")](),n={},(l=(l,t)=>(t=e[l])&&(n[l]=n=>new Promise(((l,o,r)=>(n=t.call(e,n),r=n.done,Promise.resolve(n.value).then((e=>l({value:e,done:r})),o))))))("next"),l("return"),n))(t);e=!(n=yield o.next()).done;e=!1){const e=n.value;r&&m(e.changedTables,r)}}catch(n){l=[n]}finally{try{e&&(n=o.return)&&(yield n.call(o))}finally{if(l)throw l[0]}}})),r=e,l}),(e=>{r=void 0,e.abort()}),t,o,(()=>0),1,n,"getPowerSync",Ge)};
