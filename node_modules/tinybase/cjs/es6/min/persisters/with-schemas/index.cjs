"use strict";const e=e=>typeof e,t="tinybase",n="",l=",",o=e(n),r=Promise,i=clearInterval,u=e=>null==e,a=(e,t,n)=>u(e)?null==n?void 0:n():t(e),d=t=>e(t)==o,s=e=>Array.isArray(e),c=(e,t,n)=>e.slice(t,n),v=e=>e.length,y=e=>{return t=function*(){return r.all(e)},new Promise(((e,n)=>{var l=e=>{try{r(t.next(e))}catch(e){n(e)}},o=e=>{try{r(t.throw(e))}catch(e){n(e)}},r=t=>t.done?e(t.value):Promise.resolve(t.value).then(l,o);r((t=t.apply(void 0,null)).next())}));var t},E=e=>{throw Error(e)},f=(e,t)=>e.forEach(t),p=(e,t="")=>e.join(t),h=(e,t)=>e.map(t),m=e=>0==v(e),R=(e,t)=>e.filter(t),A=(e,...t)=>e.push(...t),T=e=>e.shift(),N=Object,O=e=>N.getPrototypeOf(e),g=N.entries,$=N.keys,P=N.freeze,C=(e=[])=>N.fromEntries(e),S=(...e)=>N.assign({},...e),b=(e,t)=>(delete e[t],e),I=(e,t)=>h(g(e),(([e,n])=>t(n,e))),L=e=>N.values(e),_=e=>v($(e)),w=e=>(e=>!u(e)&&a(O(e),(e=>e==N.prototype||u(O(e))),(()=>!0)))(e)&&0==_(e),x=(e,t)=>{var n;return null!=(n=null==e?void 0:e.has(t))&&n},D=e=>u(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),M=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},F=(e,t)=>null==e?void 0:e.forEach(t),U=(e,t)=>null==e?void 0:e.delete(t),G=e=>new Map(e),j=(e,t)=>null==e?void 0:e.get(t),B=(e,t)=>{var n;return h([...null!=(n=null==e?void 0:e.entries())?n:[]],(([e,n])=>t(n,e)))},Y=(e,t,n)=>u(n)?(U(e,t),e):null==e?void 0:e.set(t,n),q=(e,t,n,l)=>(x(e,t)?null==l||l(j(e,t)):Y(e,t,n()),j(e,t)),H=(e,t,n,l,o=0)=>a((n?q:j)(e,t[o],o>v(t)-2?n:G),(r=>{if(o>v(t)-2)return(null==l?void 0:l(r))&&Y(e,t[o]),r;const i=H(r,t,n,l,o+1);return D(r)&&Y(e,t[o]),i})),X=e=>new Set(s(e)||u(e)?e:[e]),J=(e,t)=>null==e?void 0:e.add(t),W=/^\d+$/;var k=Object.defineProperty,z=Object.getOwnPropertySymbols,K=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable,Q=(e,t,n)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Z=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const ee=G(),te=G(),ne=(e,t,l,o,r,i,d,c={},y=0,p=[])=>{let h,m,R,N=0,O=0,g=0;q(ee,p,(()=>0)),q(te,p,(()=>[]));const $=G(),[C,S,b,I,L]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!w(e)||!w(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!w(e)||!w(t),t.setContent]:E("Store type not supported by this Persister"))(d,e,y),[_,x,M]=(()=>{let e;const[t,l]=(()=>{const e=[];let t=0;return[l=>{var o;return null!=(o=l?T(e):null)?o:n+t++},t=>{W.test(t)&&v(e)<1e3&&A(e,t)}]})(),o=G();return[(l,r,i,u=[],a=()=>[])=>{null!=e||(e=ue);const d=t(1);return Y(o,d,[l,r,i,u,a]),J(H(r,null!=i?i:[n],X),d),d},(t,l,...r)=>f(((e,t=[n])=>{const l=[],o=(e,n)=>n==v(t)?A(l,e):null===t[n]?F(e,(e=>o(e,n+1))):f([t[n],null],(t=>o(j(e,t),n+1)));return o(e,0),l})(t,l),(t=>F(t,(t=>j(o,t)[0](e,...null!=l?l:[],...r))))),e=>a(j(o,e),(([,t,r])=>(H(t,null!=r?r:[n],void 0,(t=>(U(t,e),D(t)?1:0))),Y(o,e),l(e),r))),t=>a(j(o,t),(([t,,n=[],l,o])=>{const r=(...i)=>{var a,d;const s=v(i);s==v(n)?t(e,...i,...o(i)):u(n[s])?f(null!=(d=null==(a=l[s])?void 0:a.call(l,...i))?d:[],(e=>r(...i,e))):r(...i,n[s])};r()}))]})(),B=e=>{e!=N&&(N=e,x($,void 0,N))},k=t=>{(C&&s(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ne=e=>Z(void 0,null,(function*(){return 2!=N&&(B(1),O++,yield ie((()=>Z(void 0,null,(function*(){try{const n=yield t();s(n)?k(n):e?L(e):E("Content is not an array: "+n)}catch(t){null==i||i(t),e&&L(e)}B(0)}))))),ue})),le=()=>(m&&(r(m),m=void 0),ue),oe=e=>Z(void 0,null,(function*(){return 1!=N&&(B(2),g++,yield ie((()=>Z(void 0,null,(function*(){try{yield l(S,e)}catch(e){null==i||i(e)}B(0)}))))),ue})),re=()=>(R&&(e.delListener(R),R=void 0),ue),ie=(...e)=>Z(void 0,null,(function*(){return A(j(te,p),...e),yield Z(void 0,null,(function*(){if(!j(ee,p)){for(Y(ee,p,1);!u(h=T(j(te,p)));)try{yield h()}catch(e){null==i||i(e)}Y(ee,p,0)}})),ue})),ue=((e,t)=>{for(var n in t||(t={}))K.call(t,n)&&Q(e,n,t[n]);if(z)for(var n of z(t))V.call(t,n)&&Q(e,n,t[n]);return e})({load:ne,startAutoLoad:e=>Z(void 0,null,(function*(){le(),yield ne(e);try{m=yield o(((e,t)=>Z(void 0,null,(function*(){t||e?2!=N&&(B(1),O++,k(null!=t?t:e),B(0)):yield ne()}))))}catch(e){null==i||i(e)}return ue})),stopAutoLoad:le,isAutoLoading:()=>!u(m),save:oe,startAutoSave:()=>Z(void 0,null,(function*(){return re(),yield oe(),R=e.addDidFinishTransactionListener((()=>{const e=b();I(e)&&oe(e)})),ue})),stopAutoSave:re,isAutoSaving:()=>!u(R),getStatus:()=>N,addStatusListener:e=>_(e,$),delListener:t=>(M(t),e),schedule:ie,getStore:()=>e,destroy:()=>(j(te,p).splice(0,void 0),le().stopAutoSave()),getStats:()=>({loads:O,saves:g})},c);return P(ue)},le="_",oe="_id",re="SELECT",ie="WHERE",ue="TABLE",ae="ALTER "+ue,de="DELETE FROM",se=re+"*FROM",ce="pragma_",ve="data_version",ye="schema_version",Ee="pragma_table_",fe=(e,t)=>t?(n,l)=>{return o=function*(){return t(n,l),yield e(n,l)},new Promise(((e,t)=>{var n=e=>{try{r(o.next(e))}catch(e){t(e)}},l=e=>{try{r(o.throw(e))}catch(e){t(e)}},r=t=>t.done?e(t.value):Promise.resolve(t.value).then(n,l);r((o=o.apply(void 0,null)).next())}));var o}:e,pe=e=>`"${e.replace(/"/g,'""')}"`,he=(e,t=[1])=>p(h(e,(()=>"$"+t[0]++)),l),me=JSON.stringify,Re=JSON.parse;var Ae=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const Te=(e,t,n,o,r,i=Ne,a,d)=>{const s=G();return[()=>Ae(void 0,null,(function*(){s.clear(),h(yield n(e,t),(({tn:e,cn:t})=>J(q(s,e,X),t)))})),(t,n)=>Ae(void 0,null,(function*(){return((e,t)=>x(j(s,e),t))(t,n)?C(R(h(yield e(se+pe(t)),(e=>{return[e[n],d?(t=b(e,n),l=d,C(I(t,((e,t)=>[t,l(e,t)])))):b(e,n)];var t,l})),(([e,t])=>!u(e)&&!w(t)))):{}})),(t,n,o,d,c,v=!1)=>Ae(void 0,null,(function*(){const E=X();I(null!=o?o:{},(e=>h($(null!=e?e:{}),(e=>J(E,e)))));const f=M(E);if(!v&&c&&m(f)&&x(s,t))return yield e("DROP "+ue+pe(t)),void Y(s,t);const T=j(s,t),N=X(M(T));if(m(f)||(x(s,t)?yield y(h([n,...f],((l,o)=>Ae(void 0,null,(function*(){U(N,l)||(yield e(ae+pe(t)+"ADD"+pe(l)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+pe(t)+`(${pe(n)})`)),J(T,l))}))))):(yield e("CREATE "+ue+pe(t)+`(${pe(n)}${r} PRIMARY KEY${p(h(f,(e=>l+pe(e)+r)))});`),Y(s,t,X([n,...f])))),yield y([...!v&&d?h(M(N),(l=>Ae(void 0,null,(function*(){l!=n&&(yield e(ae+pe(t)+"DROP"+pe(l)),U(T,l))})))):[]]),v)u(o)?yield e(de+pe(t)+ie+" true"):yield y(I(o,((l,o)=>Ae(void 0,null,(function*(){u(l)?yield e(de+pe(t)+ie+pe(n)+"=$1",[o]):m(f)||(yield i(e,t,n,$(l),{[o]:a?h(L(l),a):L(l)},T))})))));else if(m(f))x(s,t)&&(yield e(de+pe(t)+ie+" true"));else{const l=R(M(j(s,t)),(e=>e!=n)),r={},u=[];I(null!=o?o:{},((e,t)=>{r[t]=h(l,(t=>a?a(null==e?void 0:e[t]):null==e?void 0:e[t])),A(u,t)})),yield i(e,t,n,l,r),yield e(de+pe(t)+ie+pe(n)+`NOT IN(${he(u)})`,u)}})),t=>Ae(void 0,null,(function*(){let n;yield e("BEGIN");try{n=yield t()}catch(e){null==o||o(e)}return yield e("END"),n}))]},Ne=(e,t,n,o,r)=>Ae(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+pe(t)+"("+((...e)=>p(h(e,pe),l))(n,...o)+")VALUES"+p(I(r,(e=>"($"+i[0]+++","+he(e,i)+")")),l)+"ON CONFLICT("+pe(n)+")DO UPDATE SET"+p(h(o,(e=>pe(e)+"=excluded."+pe(e))),l),I(r,((e,t)=>[t,...h(e,(e=>null!=e?e:null))])).flat())}));var Oe=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const ge=(e,t,n,l,o,r,i,[u,a,d],s,c,v,y,E,f)=>{const[p,h,m,R]=Te(t,s,c,o,E,f),A=ne(e,(()=>Oe(void 0,null,(function*(){return yield R((()=>Oe(void 0,null,(function*(){var e,t,n;return yield p(),n=null!=(t=null==(e=(yield h(u,a))[le])?void 0:e[d])?t:"null",Re(n,((e,t)=>"￼"===t?void 0:t))}))))}))),(e=>Oe(void 0,null,(function*(){return yield R((()=>Oe(void 0,null,(function*(){var t,n;yield p(),yield m(u,a,{[le]:{[d]:(n=null!=(t=e())?t:null,me(n,((e,t)=>void 0===t?"￼":t)))}},!0,!0)}))))}))),n,l,o,i,{[y]:()=>v,destroy:()=>(A.stopAutoLoad().stopAutoSave(),r(),A)},0,v);return A};var $e=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const Pe=(e,t,n,l,o,r,i,[a,d,[s,c,v]],E,f,p,h,m,A,T,N)=>{const[O,g,$,P]=Te(t,E,f,o,m,A,T,N),S=(e,t)=>$e(void 0,null,(function*(){return yield y(B(d,((n,l)=>$e(void 0,[n,l],(function*([n,l,o,r],i){t&&!(i in e)||(yield $(n,l,e[i],o,r,t))})))))})),b=(e,t)=>$e(void 0,null,(function*(){return c?yield $(v,oe,{[le]:e},!0,!0,t):null})),I=ne(e,(()=>$e(void 0,null,(function*(){return yield P((()=>$e(void 0,null,(function*(){yield O();const e=yield $e(void 0,null,(function*(){return C(R(yield y(B(a,((e,t)=>$e(void 0,[e,t],(function*([e,t],n){return[e,yield g(n,t)]}))))),(e=>!w(e[1]))))})),t=yield $e(void 0,null,(function*(){return s?(yield g(v,oe))[le]:{}}));return w(e)&&u(t)?void 0:[e,t]}))))}))),((e,t)=>$e(void 0,null,(function*(){return yield P((()=>$e(void 0,null,(function*(){if(yield O(),u(t)){const[t,n]=e();yield S(t),yield b(n)}else yield S(t[0],!0),yield b(t[1],!0)}))))}))),n,l,o,i,{[h]:()=>p,destroy:()=>(I.stopAutoLoad().stopAutoSave(),r(),I)},0,p);return I},Ce="ColumnName",Se="store",be="json",Ie=Se+"TableName",Le=Se+"Id"+Ce,_e=Se+Ce,we="autoLoadIntervalSeconds",xe="rowId"+Ce,De="tableId",Me="tableName",Fe="deleteEmptyColumns",Ue="deleteEmptyTable",Ge={mode:be,[we]:1},je={load:0,save:0,[Me]:t+"_values"},Be=(e,t,n,l,o)=>{const r=G();return I(e,((e,i)=>{const a=c(L(S(t,d(e)?{[n]:e}:e)),0,_(t));u(a[0])||l(i,a[0])||(o(i,a[0]),Y(r,i,a))})),r},Ye=e=>{var n,l,o;const r=(e=>S(Ge,d(e)?{[Ie]:e}:null!=e?e:{}))(e),i=r[we];if(r.mode==be){const e=null!=(n=r[Ie])?n:t;return[1,i,[e,null!=(l=r[Le])?l:oe,null!=(o=r[_e])?o:Se],X(e)]}const{tables:{load:u={},save:a={}}={},values:s={}}=r,v=c(L(S(je,s)),0,_(je)),y=v[2],E=X(y),f=X(y);return[0,i,[Be(u,{[De]:null,[xe]:oe},De,(e=>x(f,e)),(e=>J(E,e))),Be(a,{[Me]:null,[xe]:oe,[Fe]:0,[Ue]:0},Me,((e,t)=>x(f,t)),((e,t)=>J(E,t))),v],E]};var qe=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())})),He=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const Xe=t,Je=/^([cd]:)(.+)/,We=t+"_data",ke=t+"_table";exports.Persists={StoreOnly:1,MergeableStoreOnly:2,StoreOrMergeableStore:3},exports.Status={Idle:0,Loading:1,Saving:2},exports.createCustomPersister=ne,exports.createCustomPostgreSqlPersister=(e,t,n,l,o,r,i,u,d,s,c="getDb")=>{const v=fe(n,r),[E,,f,p]=Ye(t),m=e=>He(void 0,null,(function*(){yield v(`CREATE OR REPLACE TRIGGER ${pe(We+"_"+e)} AFTER INSERT OR UPDATE OR DELETE ON ${pe(e)} EXECUTE FUNCTION ${We}()`)}));return(E?ge:Pe)(e,v,(e=>He(void 0,null,(function*(){yield v(`CREATE OR REPLACE FUNCTION ${ke}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${Xe}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{yield v(`CREATE EVENT TRIGGER ${ke} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${ke}();`)}catch(e){}return yield v(`CREATE OR REPLACE FUNCTION ${We}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${Xe}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),yield y(h(M(p),(e=>He(void 0,null,(function*(){yield v(`CREATE TABLE IF NOT EXISTS ${pe(e)}("_id"text PRIMARY KEY)`),yield m(e)}))))),yield l(Xe,(t=>He(void 0,null,(function*(){return yield a((n=t,l=Je,null==n?void 0:n.match(l)),(t=>He(void 0,[t],(function*([,t,n]){x(p,n)&&("c:"==t&&(yield m(n)),e())}))));var n,l}))))}))),o,i,u,d,f,M(p),((e,t)=>He(void 0,null,(function*(){return yield e(`${re} table_name tn,column_name cn FROM information_schema.columns ${ie} table_schema='public'AND table_name IN(${he(t)})`,t)}))),s,c,"text",void 0,(e=>me(e)),(e=>Re(e)))},exports.createCustomSqlitePersister=(e,t,l,o,r,u,a,d,s,c,v="getDb",y)=>{let E,f,p;const h=fe(l,u),[m,R,A,T]=Ye(t);return(m?ge:Pe)(e,h,(e=>{let t;const n=()=>t=setInterval((()=>qe(void 0,null,(function*(){try{const[{d:t,s:n,c:l}]=yield h(`${re} ${ve} d,${ye} s,TOTAL_CHANGES() c FROM ${ce}${ve} JOIN ${ce}${ye}`);t==E&&n==f&&l==p||(null!=E&&e(),E=t,f=n,p=l)}catch(e){}}))),1e3*R),l=()=>{E=f=p=null,i(t)},u=o((t=>{T.has(t)&&(l(),e(),n())}));return n(),()=>{l(),r(u)}}),(e=>e()),a,d,s,A,M(T),((e,t)=>qe(void 0,null,(function*(){return yield e(`${re} t.name tn,c.name cn FROM ${Ee}list()t,${Ee}info(t.name)c ${ie} t.schema='main'AND t.type IN('table','view')AND t.name IN(${he(t)})ORDER BY t.name,c.name`,t)}))),c,v,n,y,(e=>!0===e?1:!1===e?0:e),void 0)};
